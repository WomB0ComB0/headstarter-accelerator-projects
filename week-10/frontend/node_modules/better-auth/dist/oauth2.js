var k=(e,t="ms")=>new Date(Date.now()+(t==="sec"?e*1e3:e));import{createHash as Y}from"@better-auth/utils/hash";import{base64Url as ee}from"@better-auth/utils/base64";async function O(e){let t=await Y("SHA-256").digest(e);return ee.encode(new Uint8Array(t),{padding:!1})}function j(e){return{tokenType:e.token_type,accessToken:e.access_token,refreshToken:e.refresh_token,accessTokenExpiresAt:e.expires_in?k(e.expires_in,"sec"):void 0,scopes:e?.scope?typeof e.scope=="string"?e.scope.split(" "):e.scope:[],idToken:e.id_token}}async function je({id:e,options:t,authorizationEndpoint:r,state:n,codeVerifier:i,scopes:l,claims:o,redirectURI:h,duration:f}){let s=new URL(r);if(s.searchParams.set("response_type","code"),s.searchParams.set("client_id",t.clientId),s.searchParams.set("state",n),s.searchParams.set("scope",l.join(" ")),s.searchParams.set("redirect_uri",t.redirectURI||h),i){let c=await O(i);s.searchParams.set("code_challenge_method","S256"),s.searchParams.set("code_challenge",c)}if(o){let c=o.reduce((u,d)=>(u[d]=null,u),{});s.searchParams.set("claims",JSON.stringify({id_token:{email:null,email_verified:null,...c}}))}return f&&s.searchParams.set("duration",f),s}var te=Object.defineProperty,re=Object.defineProperties,ne=Object.getOwnPropertyDescriptors,B=Object.getOwnPropertySymbols,oe=Object.prototype.hasOwnProperty,se=Object.prototype.propertyIsEnumerable,$=(e,t,r)=>t in e?te(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,b=(e,t)=>{for(var r in t||(t={}))oe.call(t,r)&&$(e,r,t[r]);if(B)for(var r of B(t))se.call(t,r)&&$(e,r,t[r]);return e},R=(e,t)=>re(e,ne(t)),ae=class extends Error{constructor(e,t,r){super(t||e.toString(),{cause:r}),this.status=e,this.statusText=t,this.error=r}},ie=async(e,t)=>{var r,n,i,l,o,h;let f=t||{},s={onRequest:[t?.onRequest],onResponse:[t?.onResponse],onSuccess:[t?.onSuccess],onError:[t?.onError],onRetry:[t?.onRetry]};if(!t||!t?.plugins)return{url:e,options:f,hooks:s};for(let c of t?.plugins||[]){if(c.init){let u=await((r=c.init)==null?void 0:r.call(c,e.toString(),t));f=u.options||f,e=u.url}s.onRequest.push((n=c.hooks)==null?void 0:n.onRequest),s.onResponse.push((i=c.hooks)==null?void 0:i.onResponse),s.onSuccess.push((l=c.hooks)==null?void 0:l.onSuccess),s.onError.push((o=c.hooks)==null?void 0:o.onError),s.onRetry.push((h=c.hooks)==null?void 0:h.onRetry)}return{url:e,options:f,hooks:s}},C=class{constructor(e){this.options=e}shouldAttemptRetry(e,t){return this.options.shouldRetry?Promise.resolve(e<this.options.attempts&&this.options.shouldRetry(t)):Promise.resolve(e<this.options.attempts)}getDelay(){return this.options.delay}},ce=class{constructor(e){this.options=e}shouldAttemptRetry(e,t){return this.options.shouldRetry?Promise.resolve(e<this.options.attempts&&this.options.shouldRetry(t)):Promise.resolve(e<this.options.attempts)}getDelay(e){return Math.min(this.options.maxDelay,this.options.baseDelay*2**e)}};function le(e){if(typeof e=="number")return new C({type:"linear",attempts:e,delay:1e3});switch(e.type){case"linear":return new C(e);case"exponential":return new ce(e);default:throw new Error("Invalid retry strategy")}}var ue=e=>{let t={},r=n=>typeof n=="function"?n():n;if(e?.auth){if(e.auth.type==="Bearer"){let n=r(e.auth.token);if(!n)return t;t.authorization=`Bearer ${n}`}else if(e.auth.type==="Basic"){let n=r(e.auth.username),i=r(e.auth.password);if(!n||!i)return t;t.authorization=`Basic ${btoa(`${n}:${i}`)}`}else if(e.auth.type==="Custom"){let n=r(e.auth.value);if(!n)return t;t.authorization=`${r(e.auth.prefix)} ${n}`}}return t},N=["get","post","put","patch","delete"];var fe=/^application\/(?:[\w!#$%&*.^`~-]*\+)?json(;.+)?$/i;function de(e){let t=e.headers.get("content-type"),r=new Set(["image/svg","application/xml","application/xhtml","application/html"]);if(!t)return"json";let n=t.split(";").shift()||"";return fe.test(n)?"json":r.has(n)||n.startsWith("text/")?"text":"blob"}function pe(e){try{return JSON.parse(e),!0}catch{return!1}}function D(e){if(e===void 0)return!1;let t=typeof e;return t==="string"||t==="number"||t==="boolean"||t===null?!0:t!=="object"?!1:Array.isArray(e)?!0:e.buffer?!1:e.constructor&&e.constructor.name==="Object"||typeof e.toJSON=="function"}function q(e){try{return JSON.parse(e)}catch{return e}}function H(e){return typeof e=="function"}function he(e){if(e?.customFetchImpl)return e.customFetchImpl;if(typeof globalThis<"u"&&H(globalThis.fetch))return globalThis.fetch;if(typeof window<"u"&&H(window.fetch))return window.fetch;throw new Error("No fetch implementation found")}function ye(e){let t=new Headers(e?.headers),r=ue(e);for(let[n,i]of Object.entries(r||{}))t.set(n,i);if(!t.has("content-type")){let n=me(e?.body);n&&t.set("content-type",n)}return t}function me(e){return D(e)?"application/json":null}function ge(e){if(!e?.body)return null;let t=new Headers(e?.headers);return D(e.body)&&!t.has("content-type")?JSON.stringify(e.body):e.body}function ve(e,t){var r;if(t?.method)return t.method.toUpperCase();if(e.startsWith("@")){let n=(r=e.split("@")[1])==null?void 0:r.split("/")[0];return N.includes(n)?n.toUpperCase():t?.body?"POST":"GET"}return t?.body?"POST":"GET"}function we(e,t){let r;return!e?.signal&&e?.timeout&&(r=setTimeout(()=>t?.abort(),e?.timeout)),{abortTimeout:r,clearTimeout:()=>{r&&clearTimeout(r)}}}function be(e,t){let{baseURL:r,params:n,query:i}=t||{query:{},params:{},baseURL:""},l=e.startsWith("http")?e.split("/").slice(0,3).join("/"):r;if(!l)throw new TypeError(`Invalid URL ${e}. Are you passing in a relative URL but not setting the baseURL?`);if(e.startsWith("@")){let u=e.toString().split("@")[1].split("/")[0];N.includes(u)&&(e=e.replace(`@${u}/`,"/"))}l.endsWith("/")||(l+="/");let[o,h]=e.replace(l,"").split("?"),f=new URLSearchParams(h);for(let[u,d]of Object.entries(i||{}))f.set(u,String(d));if(n)if(Array.isArray(n)){let u=o.split("/").filter(d=>d.startsWith(":"));for(let[d,P]of u.entries()){let _=n[d];o=o.replace(P,_)}}else for(let[u,d]of Object.entries(n))o=o.replace(`:${u}`,String(d));o=o.split("/").map(encodeURIComponent).join("/"),o.startsWith("/")&&(o=o.slice(1));let s=f.size>0?`?${f}`.replace(/\+/g,"%20"):"";return new URL(`${o}${s}`,l)}var U=async(e,t)=>{var r,n,i,l,o,h,f,s;let{hooks:c,url:u,options:d}=await ie(e,t),P=he(d),_=new AbortController,z=(r=d.signal)!=null?r:_.signal,J=be(u,d),M=ge(d),F=ye(d),G=ve(u,d),p=R(b({},d),{url:J,headers:F,body:M,method:G,signal:z});for(let m of c.onRequest)if(m){let y=await m(p);y instanceof Object&&(p=y)}("pipeTo"in p&&typeof p.pipeTo=="function"||typeof((n=t?.body)==null?void 0:n.pipe)=="function")&&("duplex"in p||(p.duplex="half"));let{clearTimeout:K}=we(d,_),a=await P(p.url,p);K();let E={response:a,request:p};for(let m of c.onResponse)if(m){let y=await m(R(b({},E),{response:(i=t?.hookOptions)!=null&&i.cloneResponse?a.clone():a}));y instanceof Response?a=y:y instanceof Object&&(a=y.response)}if(a.ok){if(!(p.method!=="HEAD"))return{data:"",error:null};let y=de(a),g={data:"",response:a,request:p};if(y==="json"||y==="text"){let v=await a.text(),Z=await((l=p.jsonParser)!=null?l:q)(v);g.data=Z}else g.data=await a[y]();p?.output&&p.output&&!p.disableValidation&&(g.data=p.output.parse(g.data));for(let v of c.onSuccess)v&&await v(R(b({},g),{response:(o=t?.hookOptions)!=null&&o.cloneResponse?a.clone():a}));return t?.throw?g.data:{data:g.data,error:null}}let X=(h=t?.jsonParser)!=null?h:q,L=await a.text(),S=pe(L)?await X(L):{},Q={response:a,request:p,error:R(b({},S),{status:a.status,statusText:a.statusText})};for(let m of c.onError)m&&await m(R(b({},Q),{response:(f=t?.hookOptions)!=null&&f.cloneResponse?a.clone():a}));if(t?.retry){let m=le(t.retry),y=(s=t.retryAttempt)!=null?s:0;if(await m.shouldAttemptRetry(y,a)){for(let v of c.onRetry)v&&await v(E);let g=m.getDelay(y);return await new Promise(v=>setTimeout(v,g)),await U(e,R(b({},t),{retryAttempt:y+1}))}}if(t?.throw)throw new ae(a.status,a.statusText,S);return{data:null,error:R(b({},S),{status:a.status,statusText:a.statusText})}};import{jwtVerify as Re}from"jose";async function Ve({code:e,codeVerifier:t,redirectURI:r,options:n,tokenEndpoint:i,authentication:l}){let o=new URLSearchParams,h={"content-type":"application/x-www-form-urlencoded",accept:"application/json","user-agent":"better-auth"};if(o.set("grant_type","authorization_code"),o.set("code",e),t&&o.set("code_verifier",t),o.set("redirect_uri",r),l==="basic"){let u=btoa(`${n.clientId}:${n.clientSecret}`);h.authorization=`Basic ${u}`}else o.set("client_id",n.clientId),o.set("client_secret",n.clientSecret);let{data:f,error:s}=await U(i,{method:"POST",body:o,headers:h});if(s)throw s;return j(f)}async function We(e,t){let{data:r,error:n}=await U(t,{method:"GET",headers:{accept:"application/json","user-agent":"better-auth"}});if(n)throw n;let i=r.keys,l=JSON.parse(atob(e.split(".")[0])),o=i.find(f=>f.kid===l.kid);if(!o)throw new Error("Key not found");return await Re(e,o)}import{z as w}from"zod";import{APIError as W}from"better-call";var T=Object.create(null),x=e=>globalThis.process?.env||globalThis.Deno?.env.toObject()||globalThis.__env__||(e?T:globalThis),I=new Proxy(T,{get(e,t){return x()[t]??T[t]},has(e,t){let r=x();return t in r||t in T},set(e,t,r){let n=x(!0);return n[t]=r,!0},deleteProperty(e,t){if(!t)return!1;let r=x(!0);return delete r[t],!0},ownKeys(){let e=x(!0);return Object.keys(e)}});function xe(e){return e?e!=="false":!1}var _e=typeof process<"u"&&process.env&&process.env.NODE_ENV||"";var Je=_e==="test"||xe(I.TEST);function V(e){try{return new URL(e).origin}catch{return null}}import{createHash as gt}from"@better-auth/utils/hash";import{xchacha20poly1305 as wt}from"@noble/ciphers/chacha";import{bytesToHex as Rt,hexToBytes as xt,utf8ToBytes as _t}from"@noble/ciphers/utils";import{managedNonce as Tt}from"@noble/ciphers/webcrypto";import{createHash as tt}from"@better-auth/utils/hash";import{SignJWT as ot}from"jose";import{scryptAsync as ct}from"@noble/hashes/scrypt";import{getRandomValues as ut}from"uncrypto";import{hex as dt}from"@better-auth/utils/hex";import{createRandomStringGenerator as Te}from"@better-auth/utils/random";var A=Te("a-z","0-9","A-Z","-_");async function Ct(e,t){let r=e.body?.callbackURL||(e.query?.currentURL?V(e.query?.currentURL):"")||e.context.options.baseURL;if(!r)throw new W("BAD_REQUEST",{message:"callbackURL is required"});let n=A(128),i=A(32),l=JSON.stringify({callbackURL:r,codeVerifier:n,errorURL:e.body?.errorCallbackURL||e.query?.currentURL,newUserURL:e.body?.newUserCallbackURL,link:t,expiresAt:Date.now()+10*60*1e3}),o=new Date;o.setMinutes(o.getMinutes()+10);let h=await e.context.internalAdapter.createVerificationValue({value:l,identifier:i,expiresAt:o});if(!h)throw e.context.logger.error("Unable to create verification. Make sure the database adapter is properly working and there is a verification table in the database"),new W("INTERNAL_SERVER_ERROR",{message:"Unable to create verification"});return{state:h.identifier,codeVerifier:n}}async function qt(e){let t=e.query.state||e.body.state,r=await e.context.internalAdapter.findVerificationValue(t);if(!r)throw e.context.logger.error("State Mismatch. Verification not found",{state:t}),e.redirect(`${e.context.baseURL}/error?error=please_restart_the_process`);let n=w.object({callbackURL:w.string(),codeVerifier:w.string(),errorURL:w.string().optional(),newUserURL:w.string().optional(),expiresAt:w.number(),link:w.object({email:w.string(),userId:w.string()}).optional()}).parse(JSON.parse(r.value));if(n.errorURL||(n.errorURL=`${e.context.baseURL}/error`),n.expiresAt<Date.now())throw await e.context.internalAdapter.deleteVerificationValue(r.id),e.context.logger.error("State expired.",{state:t}),e.redirect(`${e.context.baseURL}/error?error=please_restart_the_process`);return await e.context.internalAdapter.deleteVerificationValue(r.id),n}export{je as createAuthorizationURL,O as generateCodeChallenge,Ct as generateState,j as getOAuth2Tokens,qt as parseState,Ve as validateAuthorizationCode,We as validateToken};
