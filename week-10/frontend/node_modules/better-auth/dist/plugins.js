import{APIError as jo}from"better-call";import{z as xe}from"zod";import{createEndpointCreator as qt,createMiddleware as Qo,createMiddlewareCreator as Ht}from"better-call";var Wo=Qo(async()=>({})),L=Ht({use:[Wo,Qo(async()=>({}))]}),u=qt({use:[Wo]});import{APIError as W}from"better-call";import{z as H}from"zod";var de=class extends Error{constructor(o,r){super(o),this.name="BetterAuthError",this.message=o,this.cause=r,this.stack=""}};var x=(e,o="ms")=>new Date(Date.now()+(o==="sec"?e*1e3:e));var no=Object.create(null),$e=e=>globalThis.process?.env||globalThis.Deno?.env.toObject()||globalThis.__env__||(e?no:globalThis),ye=new Proxy(no,{get(e,o){return $e()[o]??no[o]},has(e,o){let r=$e();return o in r||o in no},set(e,o,r){let i=$e(!0);return i[o]=r,!0},deleteProperty(e,o){if(!o)return!1;let r=$e(!0);return delete r[o],!0},ownKeys(){let e=$e(!0);return Object.keys(e)}});function $t(e){return e?e!=="false":!1}var To=typeof process<"u"&&process.env&&process.env.NODE_ENV||"";var so=To==="dev"||To==="development",Zt=To==="test"||$t(ye.TEST);import{base64Url as Gt}from"@better-auth/utils/base64";import{createHMAC as Qt}from"@better-auth/utils/hmac";function Ee(e){let o=new Map;return e.split(", ").forEach(i=>{let t=i.split(";").map(K=>K.trim()),[n,...s]=t,[a,...d]=n.split("="),A=d.join("=");if(!a||A===void 0)return;let c={value:A};s.forEach(K=>{let[l,...p]=K.split("="),y=p.join("="),h=l.trim().toLowerCase();switch(h){case"max-age":c["max-age"]=y?parseInt(y.trim(),10):void 0;break;case"expires":c.expires=y?new Date(y.trim()):void 0;break;case"domain":c.domain=y?y.trim():void 0;break;case"path":c.path=y?y.trim():void 0;break;case"secure":c.secure=!0;break;case"httponly":c.httponly=!0;break;case"samesite":c.samesite=y?y.trim().toLowerCase():void 0;break;default:c[h]=y?y.trim():!0;break}}),o.set(a,c)}),o}async function Eo(e,o){if(e.context.options.session?.cookieCache?.enabled){let i=Gt.encode(JSON.stringify({session:o,expiresAt:x(e.context.authCookies.sessionData.options.maxAge||60,"sec").getTime(),signature:await Qt("SHA-256","base64urlnopad").sign(e.context.secret,JSON.stringify(o))}),{padding:!1});if(i.length>4093)throw new de("Session data is too large to store in the cookie. Please disable session cookie caching or reduce the size of the session data");e.setCookie(e.context.authCookies.sessionData.name,i,e.context.authCookies.sessionData.options)}}async function O(e,o,r,i){let t=e.context.authCookies.sessionToken.options,n=r?void 0:e.context.sessionConfig.expiresIn;await e.setSignedCookie(e.context.authCookies.sessionToken.name,o.session.token,e.context.secret,{...t,maxAge:n,...i}),r&&await e.setSignedCookie(e.context.authCookies.dontRememberToken.name,"true",e.context.secret,e.context.authCookies.dontRememberToken.options),await Eo(e,o),e.context.setNewSession(o),e.context.options.secondaryStorage&&await e.context.secondaryStorage?.set(o.session.token,JSON.stringify({user:o.user,session:o.session}),Math.floor((new Date(o.session.expiresAt).getTime()-Date.now())/1e3))}function G(e){e.setCookie(e.context.authCookies.sessionToken.name,"",{...e.context.authCookies.sessionToken.options,maxAge:0}),e.setCookie(e.context.authCookies.sessionData.name,"",{...e.context.authCookies.sessionData.options,maxAge:0}),e.setCookie(e.context.authCookies.dontRememberToken.name,"",{...e.context.authCookies.dontRememberToken.options,maxAge:0})}function Ze(e){let o=e.split("; "),r=new Map;return o.forEach(i=>{let[t,n]=i.split("=");r.set(t,n)}),r}var Wt=Object.defineProperty,Jt=Object.defineProperties,Yt=Object.getOwnPropertyDescriptors,Jo=Object.getOwnPropertySymbols,Xt=Object.prototype.hasOwnProperty,er=Object.prototype.propertyIsEnumerable,Yo=(e,o,r)=>o in e?Wt(e,o,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[o]=r,Ie=(e,o)=>{for(var r in o||(o={}))Xt.call(o,r)&&Yo(e,r,o[r]);if(Jo)for(var r of Jo(o))er.call(o,r)&&Yo(e,r,o[r]);return e},_e=(e,o)=>Jt(e,Yt(o)),or=class extends Error{constructor(e,o,r){super(o||e.toString(),{cause:r}),this.status=e,this.statusText=o,this.error=r}},ir=async(e,o)=>{var r,i,t,n,s,a;let d=o||{},A={onRequest:[o?.onRequest],onResponse:[o?.onResponse],onSuccess:[o?.onSuccess],onError:[o?.onError],onRetry:[o?.onRetry]};if(!o||!o?.plugins)return{url:e,options:d,hooks:A};for(let c of o?.plugins||[]){if(c.init){let K=await((r=c.init)==null?void 0:r.call(c,e.toString(),o));d=K.options||d,e=K.url}A.onRequest.push((i=c.hooks)==null?void 0:i.onRequest),A.onResponse.push((t=c.hooks)==null?void 0:t.onResponse),A.onSuccess.push((n=c.hooks)==null?void 0:n.onSuccess),A.onError.push((s=c.hooks)==null?void 0:s.onError),A.onRetry.push((a=c.hooks)==null?void 0:a.onRetry)}return{url:e,options:d,hooks:A}},Xo=class{constructor(e){this.options=e}shouldAttemptRetry(e,o){return this.options.shouldRetry?Promise.resolve(e<this.options.attempts&&this.options.shouldRetry(o)):Promise.resolve(e<this.options.attempts)}getDelay(){return this.options.delay}},tr=class{constructor(e){this.options=e}shouldAttemptRetry(e,o){return this.options.shouldRetry?Promise.resolve(e<this.options.attempts&&this.options.shouldRetry(o)):Promise.resolve(e<this.options.attempts)}getDelay(e){return Math.min(this.options.maxDelay,this.options.baseDelay*2**e)}};function rr(e){if(typeof e=="number")return new Xo({type:"linear",attempts:e,delay:1e3});switch(e.type){case"linear":return new Xo(e);case"exponential":return new tr(e);default:throw new Error("Invalid retry strategy")}}var nr=e=>{let o={},r=i=>typeof i=="function"?i():i;if(e?.auth){if(e.auth.type==="Bearer"){let i=r(e.auth.token);if(!i)return o;o.authorization=`Bearer ${i}`}else if(e.auth.type==="Basic"){let i=r(e.auth.username),t=r(e.auth.password);if(!i||!t)return o;o.authorization=`Basic ${btoa(`${i}:${t}`)}`}else if(e.auth.type==="Custom"){let i=r(e.auth.value);if(!i)return o;o.authorization=`${r(e.auth.prefix)} ${i}`}}return o},ii=["get","post","put","patch","delete"];var sr=/^application\/(?:[\w!#$%&*.^`~-]*\+)?json(;.+)?$/i;function ar(e){let o=e.headers.get("content-type"),r=new Set(["image/svg","application/xml","application/xhtml","application/html"]);if(!o)return"json";let i=o.split(";").shift()||"";return sr.test(i)?"json":r.has(i)||i.startsWith("text/")?"text":"blob"}function dr(e){try{return JSON.parse(e),!0}catch{return!1}}function ti(e){if(e===void 0)return!1;let o=typeof e;return o==="string"||o==="number"||o==="boolean"||o===null?!0:o!=="object"?!1:Array.isArray(e)?!0:e.buffer?!1:e.constructor&&e.constructor.name==="Object"||typeof e.toJSON=="function"}function ei(e){try{return JSON.parse(e)}catch{return e}}function oi(e){return typeof e=="function"}function Ar(e){if(e?.customFetchImpl)return e.customFetchImpl;if(typeof globalThis<"u"&&oi(globalThis.fetch))return globalThis.fetch;if(typeof window<"u"&&oi(window.fetch))return window.fetch;throw new Error("No fetch implementation found")}function cr(e){let o=new Headers(e?.headers),r=nr(e);for(let[i,t]of Object.entries(r||{}))o.set(i,t);if(!o.has("content-type")){let i=ur(e?.body);i&&o.set("content-type",i)}return o}function ur(e){return ti(e)?"application/json":null}function lr(e){if(!e?.body)return null;let o=new Headers(e?.headers);return ti(e.body)&&!o.has("content-type")?JSON.stringify(e.body):e.body}function pr(e,o){var r;if(o?.method)return o.method.toUpperCase();if(e.startsWith("@")){let i=(r=e.split("@")[1])==null?void 0:r.split("/")[0];return ii.includes(i)?i.toUpperCase():o?.body?"POST":"GET"}return o?.body?"POST":"GET"}function Kr(e,o){let r;return!e?.signal&&e?.timeout&&(r=setTimeout(()=>o?.abort(),e?.timeout)),{abortTimeout:r,clearTimeout:()=>{r&&clearTimeout(r)}}}function mr(e,o){let{baseURL:r,params:i,query:t}=o||{query:{},params:{},baseURL:""},n=e.startsWith("http")?e.split("/").slice(0,3).join("/"):r;if(!n)throw new TypeError(`Invalid URL ${e}. Are you passing in a relative URL but not setting the baseURL?`);if(e.startsWith("@")){let K=e.toString().split("@")[1].split("/")[0];ii.includes(K)&&(e=e.replace(`@${K}/`,"/"))}n.endsWith("/")||(n+="/");let[s,a]=e.replace(n,"").split("?"),d=new URLSearchParams(a);for(let[K,l]of Object.entries(t||{}))d.set(K,String(l));if(i)if(Array.isArray(i)){let K=s.split("/").filter(l=>l.startsWith(":"));for(let[l,p]of K.entries()){let y=i[l];s=s.replace(p,y)}}else for(let[K,l]of Object.entries(i))s=s.replace(`:${K}`,String(l));s=s.split("/").map(encodeURIComponent).join("/"),s.startsWith("/")&&(s=s.slice(1));let A=d.size>0?`?${d}`.replace(/\+/g,"%20"):"";return new URL(`${s}${A}`,n)}var R=async(e,o)=>{var r,i,t,n,s,a,d,A;let{hooks:c,url:K,options:l}=await ir(e,o),p=Ar(l),y=new AbortController,h=(r=l.signal)!=null?r:y.signal,S=mr(K,l),D=lr(l),B=cr(l),g=pr(K,l),C=_e(Ie({},l),{url:S,headers:B,body:D,method:g,signal:h});for(let N of c.onRequest)if(N){let Z=await N(C);Z instanceof Object&&(C=Z)}("pipeTo"in C&&typeof C.pipeTo=="function"||typeof((i=o?.body)==null?void 0:i.pipe)=="function")&&("duplex"in C||(C.duplex="half"));let{clearTimeout:k}=Kr(l,y),w=await p(C.url,C);k();let te={response:w,request:C};for(let N of c.onResponse)if(N){let Z=await N(_e(Ie({},te),{response:(t=o?.hookOptions)!=null&&t.cloneResponse?w.clone():w}));Z instanceof Response?w=Z:Z instanceof Object&&(w=Z.response)}if(w.ok){if(!(C.method!=="HEAD"))return{data:"",error:null};let Z=ar(w),re={data:"",response:w,request:C};if(Z==="json"||Z==="text"){let ae=await w.text(),Mt=await((n=C.jsonParser)!=null?n:ei)(ae);re.data=Mt}else re.data=await w[Z]();C?.output&&C.output&&!C.disableValidation&&(re.data=C.output.parse(re.data));for(let ae of c.onSuccess)ae&&await ae(_e(Ie({},re),{response:(s=o?.hookOptions)!=null&&s.cloneResponse?w.clone():w}));return o?.throw?re.data:{data:re.data,error:null}}let qe=(a=o?.jsonParser)!=null?a:ei,ro=await w.text(),He=dr(ro)?await qe(ro):{},Oo={response:w,request:C,error:_e(Ie({},He),{status:w.status,statusText:w.statusText})};for(let N of c.onError)N&&await N(_e(Ie({},Oo),{response:(d=o?.hookOptions)!=null&&d.cloneResponse?w.clone():w}));if(o?.retry){let N=rr(o.retry),Z=(A=o.retryAttempt)!=null?A:0;if(await N.shouldAttemptRetry(Z,w)){for(let ae of c.onRetry)ae&&await ae(te);let re=N.getDelay(Z);return await new Promise(ae=>setTimeout(ae,re)),await R(e,_e(Ie({},o),{retryAttempt:Z+1}))}}if(o?.throw)throw new or(w.status,w.statusText,He);return{data:null,error:_e(Ie({},He),{status:w.status,statusText:w.statusText})}};import{APIError as Tr}from"better-call";import{decodeJwt as Er,decodeProtectedHeader as Rr,importJWK as Ir,jwtVerify as _r}from"jose";import{createHash as gr}from"@better-auth/utils/hash";import{base64Url as fr}from"@better-auth/utils/base64";async function ri(e){let o=await gr("SHA-256").digest(e);return fr.encode(new Uint8Array(o),{padding:!1})}function ao(e){return{tokenType:e.token_type,accessToken:e.access_token,refreshToken:e.refresh_token,accessTokenExpiresAt:e.expires_in?x(e.expires_in,"sec"):void 0,scopes:e?.scope?typeof e.scope=="string"?e.scope.split(" "):e.scope:[],idToken:e.id_token}}async function j({id:e,options:o,authorizationEndpoint:r,state:i,codeVerifier:t,scopes:n,claims:s,redirectURI:a,duration:d}){let A=new URL(r);if(A.searchParams.set("response_type","code"),A.searchParams.set("client_id",o.clientId),A.searchParams.set("state",i),A.searchParams.set("scope",n.join(" ")),A.searchParams.set("redirect_uri",o.redirectURI||a),t){let c=await ri(t);A.searchParams.set("code_challenge_method","S256"),A.searchParams.set("code_challenge",c)}if(s){let c=s.reduce((K,l)=>(K[l]=null,K),{});A.searchParams.set("claims",JSON.stringify({id_token:{email:null,email_verified:null,...c}}))}return d&&A.searchParams.set("duration",d),A}import{jwtVerify as ys}from"jose";async function v({code:e,codeVerifier:o,redirectURI:r,options:i,tokenEndpoint:t,authentication:n}){let s=new URLSearchParams,a={"content-type":"application/x-www-form-urlencoded",accept:"application/json","user-agent":"better-auth"};if(s.set("grant_type","authorization_code"),s.set("code",e),o&&s.set("code_verifier",o),s.set("redirect_uri",r),n==="basic"){let K=btoa(`${i.clientId}:${i.clientSecret}`);a.authorization=`Basic ${K}`}else s.set("client_id",i.clientId),s.set("client_secret",i.clientSecret);let{data:d,error:A}=await R(t,{method:"POST",body:s,headers:a});if(A)throw A;return ao(d)}import{z as Ce}from"zod";import{APIError as ci}from"better-call";function Re(e){try{return new URL(e).origin}catch{return null}}function ni(e){try{return new URL(e).protocol}catch{return null}}function Ro(e){return e.includes("://")?new URL(e).host:e}import{createHash as ai}from"@better-auth/utils/hash";import{xchacha20poly1305 as di}from"@noble/ciphers/chacha";import{bytesToHex as Cr,hexToBytes as br,utf8ToBytes as Or}from"@noble/ciphers/utils";import{managedNonce as Ai}from"@noble/ciphers/webcrypto";import{createHash as Is}from"@better-auth/utils/hash";import{SignJWT as yr}from"jose";async function si(e,o,r=3600){return await new yr(e).setProtectedHeader({alg:"HS256"}).setIssuedAt().setExpirationTime(Math.floor(Date.now()/1e3)+r).sign(new TextEncoder().encode(o))}import{scryptAsync as Ps}from"@noble/hashes/scrypt";import{getRandomValues as Ns}from"uncrypto";import{hex as js}from"@better-auth/utils/hex";import{createRandomStringGenerator as wr}from"@better-auth/utils/random";var _=wr("a-z","0-9","A-Z","-_");var Ke=async({key:e,data:o})=>{let r=await ai("SHA-256").digest(e),i=Or(o),t=Ai(di)(new Uint8Array(r));return Cr(t.encrypt(i))},we=async({key:e,data:o})=>{let r=await ai("SHA-256").digest(e),i=br(o),t=Ai(di)(new Uint8Array(r));return new TextDecoder().decode(t.decrypt(i))};async function Pe(e,o){let r=e.body?.callbackURL||(e.query?.currentURL?Re(e.query?.currentURL):"")||e.context.options.baseURL;if(!r)throw new ci("BAD_REQUEST",{message:"callbackURL is required"});let i=_(128),t=_(32),n=JSON.stringify({callbackURL:r,codeVerifier:i,errorURL:e.body?.errorCallbackURL||e.query?.currentURL,newUserURL:e.body?.newUserCallbackURL,link:o,expiresAt:Date.now()+10*60*1e3}),s=new Date;s.setMinutes(s.getMinutes()+10);let a=await e.context.internalAdapter.createVerificationValue({value:n,identifier:t,expiresAt:s});if(!a)throw e.context.logger.error("Unable to create verification. Make sure the database adapter is properly working and there is a verification table in the database"),new ci("INTERNAL_SERVER_ERROR",{message:"Unable to create verification"});return{state:a.identifier,codeVerifier:i}}async function Ao(e){let o=e.query.state||e.body.state,r=await e.context.internalAdapter.findVerificationValue(o);if(!r)throw e.context.logger.error("State Mismatch. Verification not found",{state:o}),e.redirect(`${e.context.baseURL}/error?error=please_restart_the_process`);let i=Ce.object({callbackURL:Ce.string(),codeVerifier:Ce.string(),errorURL:Ce.string().optional(),newUserURL:Ce.string().optional(),expiresAt:Ce.number(),link:Ce.object({email:Ce.string(),userId:Ce.string()}).optional()}).parse(JSON.parse(r.value));if(i.errorURL||(i.errorURL=`${e.context.baseURL}/error`),i.expiresAt<Date.now())throw await e.context.internalAdapter.deleteVerificationValue(r.id),e.context.logger.error("State expired.",{state:o}),e.redirect(`${e.context.baseURL}/error?error=please_restart_the_process`);return await e.context.internalAdapter.deleteVerificationValue(r.id),i}var ui=e=>{let o="https://appleid.apple.com/auth/token";return{id:"apple",name:"Apple",createAuthorizationURL({state:r,scopes:i,redirectURI:t}){let n=i||["email","name"];return e.scope&&n.push(...e.scope),new URL(`https://appleid.apple.com/auth/authorize?client_id=${e.clientId}&response_type=code&redirect_uri=${e.redirectURI||t}&scope=${n.join(" ")}&state=${r}&response_mode=form_post`)},validateAuthorizationCode:async({code:r,codeVerifier:i,redirectURI:t})=>v({code:r,codeVerifier:i,redirectURI:e.redirectURI||t,options:e,tokenEndpoint:o}),async verifyIdToken(r,i){if(e.disableIdTokenSignIn)return!1;if(e.verifyIdToken)return e.verifyIdToken(r,i);let t=Rr(r),{kid:n,alg:s}=t;if(!n||!s)return!1;let a=await Ur(n),{payload:d}=await _r(r,a,{algorithms:[s],issuer:"https://appleid.apple.com",audience:e.appBundleIdentifier||e.clientId,maxTokenAge:"1h"});return["email_verified","is_private_email"].forEach(A=>{d[A]!==void 0&&(d[A]=!!d[A])}),i&&d.nonce!==i?!1:!!d},async getUserInfo(r){if(e.getUserInfo)return e.getUserInfo(r);if(!r.idToken)return null;let i=Er(r.idToken);if(!i)return null;let t=i.user?`${i.user.name.firstName} ${i.user.name.lastName}`:i.email,n=await e.mapProfileToUser?.(i);return{user:{id:i.sub,name:t,emailVerified:!1,email:i.email,...n},data:i}}}},Ur=async e=>{let o="https://appleid.apple.com",r="/auth/keys",{data:i}=await R(`${o}${r}`);if(!i?.keys)throw new Tr("BAD_REQUEST",{message:"Keys not found"});let t=i.keys.find(n=>n.kid===e);if(!t)throw new Error(`JWK with kid ${e} not found`);return await Ir(t,t.alg)};var li=e=>({id:"discord",name:"Discord",createAuthorizationURL({state:o,scopes:r,redirectURI:i}){let t=r||["identify","email"];return e.scope&&t.push(...e.scope),new URL(`https://discord.com/api/oauth2/authorize?scope=${t.join("+")}&response_type=code&client_id=${e.clientId}&redirect_uri=${encodeURIComponent(e.redirectURI||i)}&state=${o}&prompt=${e.prompt||"none"}`)},validateAuthorizationCode:async({code:o,redirectURI:r})=>v({code:o,redirectURI:e.redirectURI||r,options:e,tokenEndpoint:"https://discord.com/api/oauth2/token"}),async getUserInfo(o){if(e.getUserInfo)return e.getUserInfo(o);let{data:r,error:i}=await R("https://discord.com/api/users/@me",{headers:{authorization:`Bearer ${o.accessToken}`}});if(i)return null;if(r.avatar===null){let n=r.discriminator==="0"?Number(BigInt(r.id)>>BigInt(22))%6:parseInt(r.discriminator)%5;r.image_url=`https://cdn.discordapp.com/embed/avatars/${n}.png`}else{let n=r.avatar.startsWith("a_")?"gif":"png";r.image_url=`https://cdn.discordapp.com/avatars/${r.id}/${r.avatar}.${n}`}let t=await e.mapProfileToUser?.(r);return{user:{id:r.id,name:r.display_name||r.username||"",email:r.email,emailVerified:r.verified,image:r.image_url,...t},data:r}}});var pi=e=>({id:"facebook",name:"Facebook",async createAuthorizationURL({state:o,scopes:r,redirectURI:i}){let t=r||["email","public_profile"];return e.scope&&t.push(...e.scope),await j({id:"facebook",options:e,authorizationEndpoint:"https://www.facebook.com/v21.0/dialog/oauth",scopes:t,state:o,redirectURI:i})},validateAuthorizationCode:async({code:o,redirectURI:r})=>v({code:o,redirectURI:e.redirectURI||r,options:e,tokenEndpoint:"https://graph.facebook.com/oauth/access_token"}),async getUserInfo(o){if(e.getUserInfo)return e.getUserInfo(o);let r=["id","name","email","picture",...e?.fields||[]],{data:i,error:t}=await R("https://graph.facebook.com/me?fields="+r.join(","),{auth:{type:"Bearer",token:o.accessToken}});if(t)return null;let n=await e.mapProfileToUser?.(i);return{user:{id:i.id,name:i.name,email:i.email,image:i.picture.data.url,emailVerified:i.email_verified,...n},data:i}}});var Ki=e=>{let o="https://github.com/login/oauth/access_token";return{id:"github",name:"GitHub",createAuthorizationURL({state:r,scopes:i,codeVerifier:t,redirectURI:n}){let s=i||["user:email"];return e.scope&&s.push(...e.scope),j({id:"github",options:e,authorizationEndpoint:"https://github.com/login/oauth/authorize",scopes:s,state:r,redirectURI:n})},validateAuthorizationCode:async({code:r,redirectURI:i})=>v({code:r,redirectURI:e.redirectURI||i,options:e,tokenEndpoint:o}),async getUserInfo(r){if(e.getUserInfo)return e.getUserInfo(r);let{data:i,error:t}=await R("https://api.github.com/user",{headers:{"User-Agent":"better-auth",authorization:`Bearer ${r.accessToken}`}});if(t)return null;let n=!1,{data:s}=await R("https://api.github.com/user/emails",{headers:{authorization:`Bearer ${r.accessToken}`,"User-Agent":"better-auth"}});s&&(i.email=(s.find(d=>d.primary)??s[0])?.email,n=s.find(d=>d.email===i.email)?.verified??!1);let a=await e.mapProfileToUser?.(i);return{user:{id:i.id.toString(),name:i.name||i.login,email:i.email,image:i.avatar_url,emailVerified:n,...a},data:i}}}};import{decodeJwt as Pr}from"jose";var Io=["info","success","warn","error","debug"];function vr(e,o){return Io.indexOf(o)<=Io.indexOf(e)}var me={reset:"\x1B[0m",bright:"\x1B[1m",dim:"\x1B[2m",underscore:"\x1B[4m",blink:"\x1B[5m",reverse:"\x1B[7m",hidden:"\x1B[8m",fg:{black:"\x1B[30m",red:"\x1B[31m",green:"\x1B[32m",yellow:"\x1B[33m",blue:"\x1B[34m",magenta:"\x1B[35m",cyan:"\x1B[36m",white:"\x1B[37m"},bg:{black:"\x1B[40m",red:"\x1B[41m",green:"\x1B[42m",yellow:"\x1B[43m",blue:"\x1B[44m",magenta:"\x1B[45m",cyan:"\x1B[46m",white:"\x1B[47m"}},Sr={info:me.fg.blue,success:me.fg.green,warn:me.fg.yellow,error:me.fg.red,debug:me.fg.magenta},kr=(e,o)=>{let r=new Date().toISOString();return`${me.dim}${r}${me.reset} ${Sr[e]}${e.toUpperCase()}${me.reset} ${me.bright}[Better Auth]:${me.reset} ${o}`},mi=e=>{let o=e?.disabled!==!0,r=e?.level??"error",i=(t,n,s=[])=>{if(!o||!vr(r,t))return;let a=kr(t,n);if(!e||typeof e.log!="function"){t==="error"?console.error(a,...s):t==="warn"?console.warn(a,...s):console.log(a,...s);return}e.log(t==="success"?"info":t,n,...s)};return Object.fromEntries(Io.map(t=>[t,(...[n,...s])=>i(t,n,s)]))},ne=mi();var gi=e=>({id:"google",name:"Google",async createAuthorizationURL({state:o,scopes:r,codeVerifier:i,redirectURI:t}){if(!e.clientId||!e.clientSecret)throw ne.error("Client Id and Client Secret is required for Google. Make sure to provide them in the options."),new de("CLIENT_ID_AND_SECRET_REQUIRED");if(!i)throw new de("codeVerifier is required for Google");let n=r||["email","profile","openid"];e.scope&&n.push(...e.scope);let s=await j({id:"google",options:e,authorizationEndpoint:"https://accounts.google.com/o/oauth2/auth",scopes:n,state:o,codeVerifier:i,redirectURI:t});return e.accessType&&s.searchParams.set("access_type",e.accessType),e.prompt&&s.searchParams.set("prompt",e.prompt),e.display&&s.searchParams.set("display",e.display),e.hd&&s.searchParams.set("hd",e.hd),s},validateAuthorizationCode:async({code:o,codeVerifier:r,redirectURI:i})=>v({code:o,codeVerifier:r,redirectURI:e.redirectURI||i,options:e,tokenEndpoint:"https://oauth2.googleapis.com/token"}),async verifyIdToken(o,r){if(e.disableIdTokenSignIn)return!1;if(e.verifyIdToken)return e.verifyIdToken(o,r);let i=`https://www.googleapis.com/oauth2/v3/tokeninfo?id_token=${o}`,{data:t}=await R(i);return t?t.aud===e.clientId&&t.iss==="https://accounts.google.com":!1},async getUserInfo(o){if(e.getUserInfo)return e.getUserInfo(o);if(!o.idToken)return null;let r=Pr(o.idToken),i=await e.mapProfileToUser?.(r);return{user:{id:r.sub,name:r.name,email:r.email,image:r.picture,emailVerified:r.email_verified,...i},data:r}}});import{decodeJwt as Dr}from"jose";var fi=e=>{let o=e.tenantId||"common",r=`https://login.microsoftonline.com/${o}/oauth2/v2.0/authorize`,i=`https://login.microsoftonline.com/${o}/oauth2/v2.0/token`;return{id:"microsoft",name:"Microsoft EntraID",createAuthorizationURL(t){let n=t.scopes||["openid","profile","email","User.Read"];return e.scope&&n.push(...e.scope),j({id:"microsoft",options:e,authorizationEndpoint:r,state:t.state,codeVerifier:t.codeVerifier,scopes:n,redirectURI:t.redirectURI})},validateAuthorizationCode({code:t,codeVerifier:n,redirectURI:s}){return v({code:t,codeVerifier:n,redirectURI:e.redirectURI||s,options:e,tokenEndpoint:i})},async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);if(!t.idToken)return null;let n=Dr(t.idToken),s=e.profilePhotoSize||48;await R(`https://graph.microsoft.com/v1.0/me/photos/${s}x${s}/$value`,{headers:{Authorization:`Bearer ${t.accessToken}`},async onResponse(d){if(!(e.disableProfilePhoto||!d.response.ok))try{let c=await d.response.clone().arrayBuffer(),K=Buffer.from(c).toString("base64");n.picture=`data:image/jpeg;base64, ${K}`}catch(A){ne.error(A&&typeof A=="object"&&"name"in A?A.name:"",A)}}});let a=await e.mapProfileToUser?.(n);return{user:{id:n.sub,name:n.name,email:n.email,image:n.picture,emailVerified:!0,...a},data:n}}}};var hi=e=>({id:"spotify",name:"Spotify",createAuthorizationURL({state:o,scopes:r,codeVerifier:i,redirectURI:t}){let n=r||["user-read-email"];return e.scope&&n.push(...e.scope),j({id:"spotify",options:e,authorizationEndpoint:"https://accounts.spotify.com/authorize",scopes:n,state:o,codeVerifier:i,redirectURI:t})},validateAuthorizationCode:async({code:o,codeVerifier:r,redirectURI:i})=>v({code:o,codeVerifier:r,redirectURI:e.redirectURI||i,options:e,tokenEndpoint:"https://accounts.spotify.com/api/token"}),async getUserInfo(o){if(e.getUserInfo)return e.getUserInfo(o);let{data:r,error:i}=await R("https://api.spotify.com/v1/me",{method:"GET",headers:{Authorization:`Bearer ${o.accessToken}`}});if(i)return null;let t=await e.mapProfileToUser?.(r);return{user:{id:r.id,name:r.display_name,email:r.email,image:r.images[0]?.url,emailVerified:!1,...t},data:r}}});var De={isAction:!1};import{createRandomStringGenerator as Nr}from"@better-auth/utils/random";var ee=e=>Nr("a-z","A-Z","0-9")(e||32);import{decodeJwt as Lr}from"jose";var yi=e=>({id:"twitch",name:"Twitch",createAuthorizationURL({state:o,scopes:r,redirectURI:i}){let t=r||["user:read:email","openid"];return e.scope&&t.push(...e.scope),j({id:"twitch",redirectURI:i,options:e,authorizationEndpoint:"https://id.twitch.tv/oauth2/authorize",scopes:t,state:o,claims:e.claims||["email","email_verified","preferred_username","picture"]})},validateAuthorizationCode:async({code:o,redirectURI:r})=>v({code:o,redirectURI:e.redirectURI||r,options:e,tokenEndpoint:"https://id.twitch.tv/oauth2/token"}),async getUserInfo(o){if(e.getUserInfo)return e.getUserInfo(o);let r=o.idToken;if(!r)return ne.error("No idToken found in token"),null;let i=Lr(r),t=await e.mapProfileToUser?.(i);return{user:{id:i.sub,name:i.preferred_username,email:i.email,image:i.picture,emailVerified:!1,...t},data:i}}});var wi=e=>({id:"twitter",name:"Twitter",createAuthorizationURL(o){let r=o.scopes||["users.read","tweet.read","offline.access"];return e.scope&&r.push(...e.scope),j({id:"twitter",options:e,authorizationEndpoint:"https://x.com/i/oauth2/authorize",scopes:r,state:o.state,codeVerifier:o.codeVerifier,redirectURI:o.redirectURI})},validateAuthorizationCode:async({code:o,codeVerifier:r,redirectURI:i})=>v({code:o,codeVerifier:r,authentication:"basic",redirectURI:e.redirectURI||i,options:e,tokenEndpoint:"https://api.x.com/2/oauth2/token"}),async getUserInfo(o){if(e.getUserInfo)return e.getUserInfo(o);let{data:r,error:i}=await R("https://api.x.com/2/users/me?user.fields=profile_image_url",{method:"GET",headers:{Authorization:`Bearer ${o.accessToken}`}});if(i)return null;let t=await e.mapProfileToUser?.(r);return{user:{id:r.data.id,name:r.data.name,email:r.data.username||null,image:r.data.profile_image_url,emailVerified:r.data.verified||!1,...t},data:r}}});var Ci=e=>{let o="https://api.dropboxapi.com/oauth2/token";return{id:"dropbox",name:"Dropbox",createAuthorizationURL:async({state:r,scopes:i,codeVerifier:t,redirectURI:n})=>{let s=i||["account_info.read"];return e.scope&&s.push(...e.scope),await j({id:"dropbox",options:e,authorizationEndpoint:"https://www.dropbox.com/oauth2/authorize",scopes:s,state:r,redirectURI:n,codeVerifier:t})},validateAuthorizationCode:async({code:r,codeVerifier:i,redirectURI:t})=>await v({code:r,codeVerifier:i,redirectURI:e.redirectURI||t,options:e,tokenEndpoint:o}),async getUserInfo(r){if(e.getUserInfo)return e.getUserInfo(r);let{data:i,error:t}=await R("https://api.dropboxapi.com/2/users/get_current_account",{method:"POST",headers:{Authorization:`Bearer ${r.accessToken}`}});if(t)return null;let n=await e.mapProfileToUser?.(i);return{user:{id:i.account_id,name:i.name?.display_name,email:i.email,emailVerified:i.email_verified||!1,image:i.profile_photo_url,...n},data:i}}}};var bi=e=>{let o="https://www.linkedin.com/oauth/v2/authorization",r="https://www.linkedin.com/oauth/v2/accessToken";return{id:"linkedin",name:"Linkedin",createAuthorizationURL:async({state:i,scopes:t,redirectURI:n})=>{let s=t||["profile","email","openid"];return e.scope&&s.push(...e.scope),await j({id:"linkedin",options:e,authorizationEndpoint:o,scopes:s,state:i,redirectURI:n})},validateAuthorizationCode:async({code:i,redirectURI:t})=>await v({code:i,redirectURI:e.redirectURI||t,options:e,tokenEndpoint:r}),async getUserInfo(i){let{data:t,error:n}=await R("https://api.linkedin.com/v2/userinfo",{method:"GET",headers:{Authorization:`Bearer ${i.accessToken}`}});if(n)return null;let s=await e.mapProfileToUser?.(t);return{user:{id:t.sub,name:t.name,email:t.email,emailVerified:t.email_verified||!1,image:t.picture,...s},data:t}}}};var _o=(e="")=>e.split("://").map(o=>o.replace(/\/{2,}/g,"/")).join("://"),jr=e=>{let o=e||"https://gitlab.com";return{authorizationEndpoint:_o(`${o}/oauth/authorize`),tokenEndpoint:_o(`${o}/oauth/token`),userinfoEndpoint:_o(`${o}/api/v4/user`)}},Oi=e=>{let{authorizationEndpoint:o,tokenEndpoint:r,userinfoEndpoint:i}=jr(e.issuer),t="gitlab";return{id:t,name:"Gitlab",createAuthorizationURL:async({state:s,scopes:a,codeVerifier:d,redirectURI:A})=>{let c=a||["read_user"];return e.scope&&c.push(...e.scope),await j({id:t,options:e,authorizationEndpoint:o,scopes:c,state:s,redirectURI:A,codeVerifier:d})},validateAuthorizationCode:async({code:s,redirectURI:a,codeVerifier:d})=>v({code:s,redirectURI:e.redirectURI||a,options:e,codeVerifier:d,tokenEndpoint:r}),async getUserInfo(s){if(e.getUserInfo)return e.getUserInfo(s);let{data:a,error:d}=await R(i,{headers:{authorization:`Bearer ${s.accessToken}`}});if(d||a.state!=="active"||a.locked)return null;let A=await e.mapProfileToUser?.(a);return{user:{id:a.id.toString(),name:a.name??a.username,email:a.email,image:a.avatar_url,emailVerified:!0,...A},data:a}}}};var Ti=e=>({id:"reddit",name:"Reddit",createAuthorizationURL({state:o,scopes:r,redirectURI:i}){let t=r||["identity"];return e.scope&&t.push(...e.scope),j({id:"reddit",options:e,authorizationEndpoint:"https://www.reddit.com/api/v1/authorize",scopes:t,state:o,redirectURI:i,duration:e.duration})},validateAuthorizationCode:async({code:o,redirectURI:r})=>{let i=new URLSearchParams({grant_type:"authorization_code",code:o,redirect_uri:e.redirectURI||r}),t={"content-type":"application/x-www-form-urlencoded",accept:"text/plain","user-agent":"better-auth",Authorization:`Basic ${Buffer.from(`${e.clientId}:${e.clientSecret}`).toString("base64")}`},{data:n,error:s}=await R("https://www.reddit.com/api/v1/access_token",{method:"POST",headers:t,body:i.toString()});if(s)throw s;return ao(n)},async getUserInfo(o){if(e.getUserInfo)return e.getUserInfo(o);let{data:r,error:i}=await R("https://oauth.reddit.com/api/v1/me",{headers:{Authorization:`Bearer ${o.accessToken}`,"User-Agent":"better-auth"}});if(i)return null;let t=await e.mapProfileToUser?.(r);return{user:{id:r.id,name:r.name,email:r.oauth_client_id,emailVerified:r.has_verified_email,image:r.icon_img?.split("?")[0],...t},data:r}}});import{z as xr}from"zod";var Br={apple:ui,discord:li,facebook:pi,github:Ki,microsoft:fi,google:gi,spotify:hi,twitch:yi,twitter:wi,dropbox:Ci,linkedin:bi,gitlab:Oi,reddit:Ti},Uo=Object.keys(Br),Ei=xr.enum(Uo,{description:"OAuth2 provider to use"});import{z as Ae}from"zod";import{APIError as Ge}from"better-call";import{APIError as be}from"better-call";import{z as Ue}from"zod";function vo(e){try{return JSON.parse(e)}catch{return null}}var f={USER_NOT_FOUND:"User not found",FAILED_TO_CREATE_USER:"Failed to create user",FAILED_TO_CREATE_SESSION:"Failed to create session",FAILED_TO_UPDATE_USER:"Failed to update user",FAILED_TO_GET_SESSION:"Failed to get session",INVALID_PASSWORD:"Invalid password",INVALID_EMAIL:"Invalid email",INVALID_EMAIL_OR_PASSWORD:"Invalid email or password",SOCIAL_ACCOUNT_ALREADY_LINKED:"Social account already linked",PROVIDER_NOT_FOUND:"Provider not found",INVALID_TOKEN:"invalid token",ID_TOKEN_NOT_SUPPORTED:"id_token not supported",FAILED_TO_GET_USER_INFO:"Failed to get user info",USER_EMAIL_NOT_FOUND:"User email not found",EMAIL_NOT_VERIFIED:"Email not verified",PASSWORD_TOO_SHORT:"Password too short",PASSWORD_TOO_LONG:"Password too long",USER_ALREADY_EXISTS:"User already exists",EMAIL_CAN_NOT_BE_UPDATED:"Email can not be updated",CREDENTIAL_ACCOUNT_NOT_FOUND:"Credential account not found",SESSION_EXPIRED:"Session expired. Re-authenticate to perform this action.",FAILED_TO_UNLINK_LAST_ACCOUNT:"You can't unlink your last account",ACCOUNT_NOT_FOUND:"Account not found"};import{createHMAC as zr}from"@better-auth/utils/hmac";import{base64 as Fr}from"@better-auth/utils/base64";import{binary as Vr}from"@better-auth/utils/binary";var So=()=>u("/get-session",{method:"GET",query:Ue.optional(Ue.object({disableCookieCache:Ue.boolean({description:"Disable cookie cache and fetch session from database"}).or(Ue.string().transform(e=>e==="true")).optional(),disableRefresh:Ue.boolean({description:"Disable session refresh. Useful for checking session status, without updating the session"}).optional()})),requireHeaders:!0,metadata:{openapi:{description:"Get the current session",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{session:{type:"object",properties:{token:{type:"string"},userId:{type:"string"},expiresAt:{type:"string"}}},user:{type:"object",$ref:"#/components/schemas/User"}}}}}}}}}},async e=>{try{let o=await e.getSignedCookie(e.context.authCookies.sessionToken.name,e.context.secret);if(!o)return e.json(null);let r=e.getCookie(e.context.authCookies.sessionData.name),i=r?vo(Vr.decode(Fr.decode(r))):null;if(i&&!await zr("SHA-256","base64urlnopad").verify(e.context.secret,JSON.stringify(i.session),i.signature))return G(e),e.json(null);let t=await e.getSignedCookie(e.context.authCookies.dontRememberToken.name,e.context.secret);if(i?.session&&e.context.options.session?.cookieCache?.enabled&&!e.query?.disableCookieCache){let c=i.session;if(i.expiresAt<Date.now()||c.session.expiresAt<new Date){let l=e.context.authCookies.sessionData.name;e.setCookie(l,"",{maxAge:0})}else return e.json(c)}let n=await e.context.internalAdapter.findSession(o);if(e.context.session=n,!n||n.session.expiresAt<new Date)return G(e),n&&await e.context.internalAdapter.deleteSession(n.session.token),e.json(null);if(t||e.query?.disableRefresh)return e.json(n);let s=e.context.sessionConfig.expiresIn,a=e.context.sessionConfig.updateAge;if(n.session.expiresAt.valueOf()-s*1e3+a*1e3<=Date.now()){let c=await e.context.internalAdapter.updateSession(n.session.token,{expiresAt:x(e.context.sessionConfig.expiresIn,"sec")});if(!c)return G(e),e.json(null,{status:401});let K=(c.expiresAt.valueOf()-Date.now())/1e3;return await O(e,{session:c,user:n.user},!1,{maxAge:K}),e.json({session:c,user:n.user})}return await Eo(e,n),e.json(n)}catch(o){throw e.context.logger.error("INTERNAL_SERVER_ERROR",o),new be("INTERNAL_SERVER_ERROR",{message:f.FAILED_TO_GET_SESSION})}}),U=async(e,o)=>{if(e.context.session)return e.context.session;let r=await So()({...e,_flag:"json",headers:e.headers,query:o}).catch(i=>null);return e.context.session=r,r},I=L(async e=>{let o=await U(e);if(!o?.session)throw new be("UNAUTHORIZED");return{session:o}}),Ri=L(async e=>{let o=await U(e);if(!o?.session)throw new be("UNAUTHORIZED");if(e.context.sessionConfig.freshAge===0)return{session:o};let r=e.context.sessionConfig.freshAge,i=o.session.updatedAt?.valueOf()||o.session.createdAt.valueOf();if(!(Date.now()-i<r*1e3))throw new be("FORBIDDEN",{message:"Session is not fresh"});return{session:o}}),Ii=()=>u("/list-sessions",{method:"GET",use:[I],requireHeaders:!0,metadata:{openapi:{description:"List all active sessions for the user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"array",items:{type:"object",properties:{token:{type:"string"},userId:{type:"string"},expiresAt:{type:"string"}}}}}}}}}}},async e=>{let r=(await e.context.internalAdapter.listSessions(e.context.session.user.id)).filter(i=>i.expiresAt>new Date);return e.json(r)}),_i=u("/revoke-session",{method:"POST",body:Ue.object({token:Ue.string({description:"The token to revoke"})}),use:[I],requireHeaders:!0,metadata:{openapi:{description:"Revoke a single session",requestBody:{content:{"application/json":{schema:{type:"object",properties:{token:{type:"string"}},required:["token"]}}}}}}},async e=>{let o=e.body.token,r=await e.context.internalAdapter.findSession(o);if(!r)throw new be("BAD_REQUEST",{message:"Session not found"});if(r.session.userId!==e.context.session.user.id)throw new be("UNAUTHORIZED");try{await e.context.internalAdapter.deleteSession(o)}catch(i){throw e.context.logger.error(i&&typeof i=="object"&&"name"in i?i.name:"",i),new be("INTERNAL_SERVER_ERROR")}return e.json({status:!0})}),Ui=u("/revoke-sessions",{method:"POST",use:[I],requireHeaders:!0,metadata:{openapi:{description:"Revoke all sessions for the user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"}},required:["status"]}}}}}}}},async e=>{try{await e.context.internalAdapter.deleteSessions(e.context.session.user.id)}catch(o){throw e.context.logger.error(o&&typeof o=="object"&&"name"in o?o.name:"",o),new be("INTERNAL_SERVER_ERROR")}return e.json({status:!0})}),vi=u("/revoke-other-sessions",{method:"POST",requireHeaders:!0,use:[I],metadata:{openapi:{description:"Revoke all other sessions for the user except the current one",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"}}}}}}}}}},async e=>{let o=e.context.session;if(!o.user)throw new be("UNAUTHORIZED");let t=(await e.context.internalAdapter.listSessions(o.user.id)).filter(n=>n.expiresAt>new Date).filter(n=>n.token!==e.context.session.session.token);return await Promise.all(t.map(n=>e.context.internalAdapter.deleteSession(n.token))),e.json({status:!0})});import{jwtVerify as $r}from"jose";import{APIError as ki}from"better-call";function ko(e){return e==="-"||e==="^"||e==="$"||e==="+"||e==="."||e==="("||e===")"||e==="|"||e==="["||e==="]"||e==="{"||e==="}"||e==="*"||e==="?"||e==="\\"?`\\${e}`:e}function Mr(e){let o="";for(let r=0;r<e.length;r++)o+=ko(e[r]);return o}function Si(e,o=!0){if(Array.isArray(e))return`(?:${e.map(c=>`^${Si(c,o)}$`).join("|")})`;let r="",i="",t=".";o===!0?(r="/",i="[/\\\\]",t="[^/\\\\]"):o&&(r=o,i=Mr(r),i.length>1?(i=`(?:${i})`,t=`((?!${i}).)`):t=`[^${i}]`);let n=o?`${i}+?`:"",s=o?`${i}*?`:"",a=o?e.split(r):[e],d="";for(let A=0;A<a.length;A++){let c=a[A],K=a[A+1],l="";if(!(!c&&A>0)){if(o&&(A===a.length-1?l=s:K!=="**"?l=n:l=""),o&&c==="**"){l&&(d+=A===0?"":l,d+=`(?:${t}*?${l})*?`);continue}for(let p=0;p<c.length;p++){let y=c[p];y==="\\"?p<c.length-1&&(d+=ko(c[p+1]),p++):y==="?"?d+=t:y==="*"?d+=`${t}*?`:d+=ko(y)}d+=l}}return d}function qr(e,o){if(typeof o!="string")throw new TypeError(`Sample must be a string, but ${typeof o} given`);return e.test(o)}function co(e,o){if(typeof e!="string"&&!Array.isArray(e))throw new TypeError(`The first argument must be a single pattern string or an array of patterns, but ${typeof e} given`);if((typeof o=="string"||typeof o=="boolean")&&(o={separator:o}),arguments.length===2&&!(typeof o>"u"||typeof o=="object"&&o!==null&&!Array.isArray(o)))throw new TypeError(`The second argument must be an options object or a string/boolean separator, but ${typeof o} given`);if(o=o||{},o.separator==="\\")throw new Error("\\ is not a valid separator because it is used for escaping. Try setting the separator to `true` instead");let r=Si(e,o.separator),i=new RegExp(`^${r}$`,o.flags),t=qr.bind(null,i);return t.options=o,t.pattern=e,t.regexp=i,t}var Hr=L(async e=>{if(e.request?.method!=="POST")return;let{body:o,query:r,context:i}=e,t=e.headers?.get("origin")||e.headers?.get("referer")||"",n=o?.callbackURL||r?.callbackURL,s=o?.redirectTo,a=r?.currentURL,d=o?.errorCallbackURL,A=o?.newUserCallbackURL,c=i.trustedOrigins,K=e.headers?.has("cookie"),l=(y,h)=>{if(y.startsWith("/"))return!1;if(h.includes("*"))return co(h)(Ro(y));let S=ni(y);return S==="http:"||S==="https:"||!S?h===Re(y):y.startsWith(h)},p=(y,h)=>{if(!y)return;if(!c.some(D=>l(y,D)||y?.startsWith("/")&&h!=="origin"&&!y.includes(":")))throw e.context.logger.error(`Invalid ${h}: ${y}`),e.context.logger.info(`If it's a valid URL, please add ${y} to trustedOrigins in your auth config
`,`Current list of trustedOrigins: ${c}`),new ki("FORBIDDEN",{message:`Invalid ${h}`})};K&&!e.context.options.advanced?.disableCSRFCheck&&p(t,"origin"),n&&p(n,"callbackURL"),s&&p(s,"redirectURL"),a&&p(a,"currentURL"),d&&p(d,"errorCallbackURL"),A&&p(A,"newUserCallbackURL")}),ge=e=>L(async o=>{let{context:r}=o,i=e(o),t=r.trustedOrigins,n=(a,d)=>a.startsWith("/")?!1:d.includes("*")?co(d)(Ro(a)):a.startsWith(d);i&&((a,d)=>{if(!a)return;if(!t.some(c=>n(a,c)||a?.startsWith("/")&&d!=="origin"&&!a.includes(":")))throw o.context.logger.error(`Invalid ${d}: ${a}`),o.context.logger.info(`If it's a valid URL, please add ${a} to trustedOrigins in your auth config
`,`Current list of trustedOrigins: ${t}`),new ki("FORBIDDEN",{message:`Invalid ${d}`})})(i,"callbackURL")});import{JWTExpired as Zr}from"jose/errors";async function fe(e,o,r,i=3600){return await si({email:o.toLowerCase(),updateTo:r},e,i)}async function Po(e,o){if(!e.context.options.emailVerification?.sendVerificationEmail)throw e.context.logger.error("Verification email isn't enabled."),new Ge("BAD_REQUEST",{message:"Verification email isn't enabled"});let r=await fe(e.context.secret,o.email,void 0,e.context.options.emailVerification?.expiresIn),i=`${e.context.baseURL}/verify-email?token=${r}&callbackURL=${e.body.callbackURL||e.query?.currentURL||"/"}`;await e.context.options.emailVerification.sendVerificationEmail({user:o,url:i,token:r},e.request)}var Pi=u("/send-verification-email",{method:"POST",query:Ae.object({currentURL:Ae.string({description:"The URL to use for email verification callback"}).optional()}).optional(),body:Ae.object({email:Ae.string({description:"The email to send the verification email to"}).email(),callbackURL:Ae.string({description:"The URL to use for email verification callback"}).optional()}),metadata:{openapi:{description:"Send a verification email to the user",requestBody:{content:{"application/json":{schema:{type:"object",properties:{email:{type:"string",description:"The email to send the verification email to"},callbackURL:{type:"string",description:"The URL to use for email verification callback"}},required:["email"]}}}},responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"}}}}}}}}}},async e=>{if(!e.context.options.emailVerification?.sendVerificationEmail)throw e.context.logger.error("Verification email isn't enabled."),new Ge("BAD_REQUEST",{message:"Verification email isn't enabled"});let{email:o}=e.body,r=await e.context.internalAdapter.findUserByEmail(o);if(!r)throw new Ge("BAD_REQUEST",{message:f.USER_NOT_FOUND});return await Po(e,r.user),e.json({status:!0})}),Di=u("/verify-email",{method:"GET",query:Ae.object({token:Ae.string({description:"The token to verify the email"}),callbackURL:Ae.string({description:"The URL to redirect to after email verification"}).optional()}),use:[ge(e=>e.query.callbackURL)],metadata:{openapi:{description:"Verify the email of the user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{user:{type:"object"},status:{type:"boolean"}},required:["user","status"]}}}}}}}},async e=>{function o(a){throw e.query.callbackURL?e.query.callbackURL.includes("?")?e.redirect(`${e.query.callbackURL}&error=${a}`):e.redirect(`${e.query.callbackURL}?error=${a}`):new Ge("UNAUTHORIZED",{message:a})}let{token:r}=e.query,i;try{i=await $r(r,new TextEncoder().encode(e.context.secret),{algorithms:["HS256"]})}catch(a){return a instanceof Zr?o("token_expired"):o("invalid_token")}let n=Ae.object({email:Ae.string().email(),updateTo:Ae.string().optional()}).parse(i.payload),s=await e.context.internalAdapter.findUserByEmail(n.email);if(!s)return o("user_not_found");if(n.updateTo){let a=await U(e);if(!a){if(e.query.callbackURL)throw e.redirect(`${e.query.callbackURL}?error=unauthorized`);return o("unauthorized")}if(a.user.email!==n.email){if(e.query.callbackURL)throw e.redirect(`${e.query.callbackURL}?error=unauthorized`);return o("unauthorized")}let d=await e.context.internalAdapter.updateUserByEmail(n.email,{email:n.updateTo,emailVerified:!1}),A=await fe(e.context.secret,n.updateTo);if(await e.context.options.emailVerification?.sendVerificationEmail?.({user:d,url:`${e.context.baseURL}/verify-email?token=${A}`,token:A},e.request),e.query.callbackURL)throw e.redirect(e.query.callbackURL);return e.json({status:!0,user:{id:d.id,email:d.email,name:d.name,image:d.image,emailVerified:d.emailVerified,createdAt:d.createdAt,updatedAt:d.updatedAt}})}if(await e.context.internalAdapter.updateUserByEmail(n.email,{emailVerified:!0}),e.context.options.emailVerification?.autoSignInAfterVerification){let a=await U(e);if(!a||a.user.email!==n.email){let d=await e.context.internalAdapter.createSession(s.user.id,e.request);if(!d)throw new Ge("INTERNAL_SERVER_ERROR",{message:"Failed to create session"});await O(e,{session:d,user:s.user})}}if(e.query.callbackURL)throw e.redirect(e.query.callbackURL);return e.json({status:!0,user:null})});import{APIError as Le,createRouter as WA,getCookie as Xr,getSignedCookie as en,setCookie as on,setSignedCookie as tn}from"better-call";var Ni=u("/ok",{method:"GET",metadata:{...De,openapi:{description:"Check if the API is working",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{ok:{type:"boolean"}}}}}}}}}},async e=>e.json({ok:!0}));import{z as Ne}from"zod";import{APIError as Oe}from"better-call";import{z as E}from"zod";import{APIError as Gr}from"better-call";var TA=E.object({id:E.string(),providerId:E.string(),accountId:E.string(),userId:E.string(),accessToken:E.string().nullish(),refreshToken:E.string().nullish(),idToken:E.string().nullish(),accessTokenExpiresAt:E.date().nullish(),refreshTokenExpiresAt:E.date().nullish(),scope:E.string().nullish(),password:E.string().nullish(),createdAt:E.date().default(()=>new Date),updatedAt:E.date().default(()=>new Date)}),EA=E.object({id:E.string(),email:E.string().transform(e=>e.toLowerCase()),emailVerified:E.boolean().default(!1),name:E.string(),image:E.string().nullish(),createdAt:E.date().default(()=>new Date),updatedAt:E.date().default(()=>new Date)}),RA=E.object({id:E.string(),userId:E.string(),expiresAt:E.date(),createdAt:E.date().default(()=>new Date),updatedAt:E.date().default(()=>new Date),token:E.string(),ipAddress:E.string().nullish(),userAgent:E.string().nullish()}),IA=E.object({id:E.string(),value:E.string(),createdAt:E.date().default(()=>new Date),updatedAt:E.date().default(()=>new Date),expiresAt:E.date(),identifier:E.string()});function Qr(e,o){let r={...o==="user"?e.user?.additionalFields:{},...o==="session"?e.session?.additionalFields:{}};for(let i of e.plugins||[])i.schema&&i.schema[o]&&(r={...r,...i.schema[o].fields});return r}function Wr(e,o){let r=o.action||"create",i=o.fields,t={};for(let n in i){if(n in e){if(i[n].input===!1){if(i[n].defaultValue){t[n]=i[n].defaultValue;continue}continue}if(i[n].validator?.input&&e[n]!==void 0){t[n]=i[n].validator.input.parse(e[n]);continue}if(i[n].transform?.input&&e[n]!==void 0){t[n]=i[n].transform?.input(e[n]);continue}t[n]=e[n];continue}if(i[n].defaultValue&&r==="create"){t[n]=i[n].defaultValue;continue}if(i[n].required&&r==="create")throw new Gr("BAD_REQUEST",{message:`${n} is required`})}return t}function uo(e,o,r){let i=Qr(e,"user");return Wr(o||{},{fields:i,action:r})}function he(e,o){if(!o)return e;for(let r in o){let i=o[r]?.modelName;i&&(e[r].modelName=i);for(let t in e[r].fields){let n=o[r]?.fields?.[t];n&&(e[r].fields[t].fieldName=n)}}return e}var Li=()=>u("/sign-up/email",{method:"POST",query:Ne.object({currentURL:Ne.string().optional()}).optional(),body:Ne.record(Ne.string(),Ne.any()),metadata:{openapi:{description:"Sign up a user using email and password",requestBody:{content:{"application/json":{schema:{type:"object",properties:{name:{type:"string",description:"The name of the user"},email:{type:"string",description:"The email of the user"},password:{type:"string",description:"The password of the user"},callbackURL:{type:"string",description:"The URL to use for email verification callback"}},required:["name","email","password"]}}}},responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{id:{type:"string",description:"The id of the user"},email:{type:"string",description:"The email of the user"},name:{type:"string",description:"The name of the user"},image:{type:"string",description:"The image of the user"},emailVerified:{type:"boolean",description:"If the email is verified"}}}}}}}}}},async e=>{if(!e.context.options.emailAndPassword?.enabled)throw new Oe("BAD_REQUEST",{message:"Email and password sign up is not enabled"});let o=e.body,{name:r,email:i,password:t,image:n,callbackURL:s,...a}=o;if(!Ne.string().email().safeParse(i).success)throw new Oe("BAD_REQUEST",{message:f.INVALID_EMAIL});let A=e.context.password.config.minPasswordLength;if(t.length<A)throw e.context.logger.error("Password is too short"),new Oe("BAD_REQUEST",{message:f.PASSWORD_TOO_SHORT});let c=e.context.password.config.maxPasswordLength;if(t.length>c)throw e.context.logger.error("Password is too long"),new Oe("BAD_REQUEST",{message:f.PASSWORD_TOO_LONG});if((await e.context.internalAdapter.findUserByEmail(i))?.user)throw e.context.logger.info(`Sign-up attempt for existing email: ${i}`),new Oe("UNPROCESSABLE_ENTITY",{message:f.USER_ALREADY_EXISTS});let l=uo(e.context.options,a),p;try{if(p=await e.context.internalAdapter.createUser({email:i.toLowerCase(),name:r,image:n,...l,emailVerified:!1}),!p)throw new Oe("BAD_REQUEST",{message:f.FAILED_TO_CREATE_USER})}catch(S){throw so&&e.context.logger.error("Failed to create user",S),new Oe("UNPROCESSABLE_ENTITY",{message:f.FAILED_TO_CREATE_USER,details:S})}if(!p)throw new Oe("UNPROCESSABLE_ENTITY",{message:f.FAILED_TO_CREATE_USER});let y=await e.context.password.hash(t);if(await e.context.internalAdapter.linkAccount({userId:p.id,providerId:"credential",accountId:p.id,password:y}),e.context.options.emailVerification?.sendOnSignUp||e.context.options.emailAndPassword.requireEmailVerification){let S=await fe(e.context.secret,p.email,void 0,e.context.options.emailVerification?.expiresIn),D=`${e.context.baseURL}/verify-email?token=${S}&callbackURL=${o.callbackURL||e.query?.currentURL||"/"}`;await e.context.options.emailVerification?.sendVerificationEmail?.({user:p,url:D,token:S},e.request)}if(!e.context.options.emailAndPassword.autoSignIn||e.context.options.emailAndPassword.requireEmailVerification)return e.json({token:null,user:{id:p.id,email:p.email,name:p.name,image:p.image,emailVerified:p.emailVerified,createdAt:p.createdAt,updatedAt:p.updatedAt}});let h=await e.context.internalAdapter.createSession(p.id,e.request);if(!h)throw new Oe("BAD_REQUEST",{message:f.FAILED_TO_CREATE_SESSION});return await O(e,{session:h,user:p}),e.json({token:h.token,user:{id:p.id,email:p.email,name:p.name,image:p.image,emailVerified:p.emailVerified,createdAt:p.createdAt,updatedAt:p.updatedAt}})});var Jr=(e="Unknown")=>`<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication Error</title>
    <style>
        :root {
            --bg-color: #f8f9fa;
            --text-color: #212529;
            --accent-color: #000000;
            --error-color: #dc3545;
            --border-color: #e9ecef;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            line-height: 1.5;
        }
        .error-container {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 2.5rem;
            text-align: center;
            max-width: 90%;
            width: 400px;
        }
        h1 {
            color: var(--error-color);
            font-size: 1.75rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }
        p {
            margin-bottom: 1.5rem;
            color: #495057;
        }
        .btn {
            background-color: var(--accent-color);
            color: #ffffff;
            text-decoration: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            transition: all 0.3s ease;
            display: inline-block;
            font-weight: 500;
            border: 2px solid var(--accent-color);
        }
        .btn:hover {
            background-color: #131721;
        }
        .error-code {
            font-size: 0.875rem;
            color: #6c757d;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }
        .icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="error-container">
        <div class="icon">\u26A0\uFE0F</div>
        <h1>Better Auth Error</h1>
        <p>We encountered an issue while processing your request. Please try again or contact the application owner if the problem persists.</p>
        <a href="/" id="returnLink" class="btn">Return to Application</a>
        <div class="error-code">Error Code: <span id="errorCode">${e}</span></div>
    </div>
</body>
</html>`,ji=u("/error",{method:"GET",metadata:{...De,openapi:{description:"Displays an error page",responses:{200:{description:"Success",content:{"text/html":{schema:{type:"string"}}}}}}}},async e=>{let o=new URL(e.request?.url||"").searchParams.get("error")||"Unknown";return new Response(Jr(o),{headers:{"Content-Type":"text/html"}})});import{APIError as m}from"better-call";function Do(e,o){let r=o.plugins?.reduce((a,d)=>({...a,...d.endpoints}),{}),i=o.plugins?.map(a=>a.middlewares?.map(d=>{let A=async c=>d.middleware({...c,context:{...e,...c.context}});return A.path=d.path,A.options=d.middleware.options,A.headers=d.middleware.headers,{path:d.path,middleware:A}})).filter(a=>a!==void 0).flat()||[],n={...{signInSocial:xi,callbackOAuth:zi,getSession:So(),signOut:Fi,signUpEmail:Li(),signInEmail:Bi,forgetPassword:Vi,resetPassword:qi,verifyEmail:Di,sendVerificationEmail:Pi,changeEmail:Qi,changePassword:$i,setPassword:Zi,updateUser:Hi(),deleteUser:Gi,forgetPasswordCallback:Mi,listSessions:Ii(),revokeSession:_i,revokeSessions:Ui,revokeOtherSessions:vi,linkSocialAccount:Ji,listUserAccounts:Wi,deleteUserCallback:No,unlinkAccount:Yi},...r,ok:Ni,error:ji},s={};for(let[a,d]of Object.entries(n))s[a]=async(A={})=>{d.headers=new Headers;let c={setHeader(g,C){d.headers.set(g,C)},setCookie(g,C,k){on(d.headers,g,C,k)},getCookie(g,C){let w=A.headers?.get("cookie");return Xr(w||"",g,C)},getSignedCookie(g,C,k){let w=A.headers;return w?en(w,C,g,k):null},async setSignedCookie(g,C,k,w){await tn(d.headers,g,C,k,w)},redirect(g){return d.headers.set("Location",g),new Le("FOUND")},responseHeader:d.headers},K=await e,l=null,p={...c,...A,path:d.path,context:{...K,...A.context,session:null,setNewSession:function(g){this.newSession=g,l=g}}},y=o.plugins||[],h=y.map(g=>{if(g.hooks?.before)return g.hooks.before}).filter(g=>g!==void 0).flat(),S=y.map(g=>{if(g.hooks?.after)return g.hooks.after}).filter(g=>g!==void 0).flat();o.hooks?.before&&h.push({matcher:()=>!0,handler:o.hooks.before}),o.hooks?.after&&S.push({matcher:()=>!0,handler:o.hooks.after});for(let g of h){if(!g.matcher(p))continue;let C=await g.handler(p);if(C&&"context"in C){p={...p,...C.context};continue}if(C)return C}let D;try{D=await d(p),l&&(p.context.newSession=l)}catch(g){if(l&&(p.context.newSession=l),g instanceof Le){if(!S?.length)throw g.headers=d.headers,g;p.context.returned=g,p.context.returned.headers=d.headers;for(let C of S||[])if(C.matcher(p))try{let w=await C.handler(p);w&&"response"in w&&(p.context.returned=w.response)}catch(w){if(w instanceof Le){p.context.returned=w;continue}throw w}if(p.context.returned instanceof Le)throw p.context.returned.headers=d.headers,p.context.returned;return p.context.returned}throw g}p.context.returned=D,p.responseHeader=d.headers;for(let g of S)if(g.matcher(p))try{let k=await g.handler(p);if(k)if("responseHeader"in k){let w=k.responseHeader;p.responseHeader=w}else p.context.returned=k}catch(k){if(k instanceof Le){p.context.returned=k;continue}throw k}let B=p.context.returned;if(B instanceof Response&&d.headers.forEach((g,C)=>{C==="set-cookie"?B.headers.append(C,g):B.headers.set(C,g)}),B instanceof Le)throw B.headers=d.headers,B;return B},s[a].path=d.path,s[a].method=d.method,s[a].options=d.options,s[a].headers=d.headers;return{api:s,middlewares:i}}async function je(e,{userInfo:o,account:r,callbackURL:i}){let t=await e.context.internalAdapter.findOAuthUser(o.email.toLowerCase(),r.accountId,r.providerId).catch(d=>{throw ne.error(`Better auth was unable to query your database.
Error: `,d),e.redirect(`${e.context.baseURL}/error?error=internal_server_error`)}),n=t?.user,s=!n;if(t){let d=t.accounts.find(A=>A.providerId===r.providerId);if(d){let A=Object.fromEntries(Object.entries({accessToken:r.accessToken,idToken:r.idToken,refreshToken:r.refreshToken,accessTokenExpiresAt:r.accessTokenExpiresAt,refreshTokenExpiresAt:r.refreshTokenExpiresAt}).filter(([c,K])=>K!==void 0));Object.keys(A).length>0&&await e.context.internalAdapter.updateAccount(d.id,A)}else{if(!e.context.options.account?.accountLinking?.trustedProviders?.includes(r.providerId)&&!o.emailVerified||e.context.options.account?.accountLinking?.enabled===!1)return so&&ne.warn(`User already exist but account isn't linked to ${r.providerId}. To read more about how account linking works in Better Auth see https://www.better-auth.com/docs/concepts/users-accounts#account-linking.`),{error:"account not linked",data:null};try{await e.context.internalAdapter.linkAccount({providerId:r.providerId,accountId:o.id.toString(),userId:t.user.id,accessToken:r.accessToken,idToken:r.idToken,refreshToken:r.refreshToken,accessTokenExpiresAt:r.accessTokenExpiresAt,refreshTokenExpiresAt:r.refreshTokenExpiresAt,scope:r.scope})}catch(K){return ne.error("Unable to link account",K),{error:"unable to link account",data:null}}}}else try{if(n=await e.context.internalAdapter.createOAuthUser({...o,email:o.email.toLowerCase(),id:void 0},{accessToken:r.accessToken,idToken:r.idToken,refreshToken:r.refreshToken,accessTokenExpiresAt:r.accessTokenExpiresAt,refreshTokenExpiresAt:r.refreshTokenExpiresAt,scope:r.scope,providerId:r.providerId,accountId:o.id.toString()}).then(d=>d?.user),!o.emailVerified&&n&&e.context.options.emailVerification?.sendOnSignUp){let d=await fe(e.context.secret,n.email,void 0,e.context.options.emailVerification?.expiresIn),A=`${e.context.baseURL}/verify-email?token=${d}&callbackURL=${i}`;await e.context.options.emailVerification?.sendVerificationEmail?.({user:n,url:A,token:d},e.request)}}catch(d){return d instanceof m?{error:d.message,data:null,isRegister:!1}:{error:"unable to create user",data:null,isRegister:!1}}if(!n)return{error:"unable to create user",data:null,isRegister:!1};let a=await e.context.internalAdapter.createSession(n.id,e.request);return a?{data:{session:a,user:n},error:null,isRegister:s}:{error:"unable to create session",data:null,isRegister:!1}}var xi=u("/sign-in/social",{method:"POST",query:H.object({currentURL:H.string().optional()}).optional(),body:H.object({callbackURL:H.string({description:"Callback URL to redirect to after the user has signed in"}).optional(),newUserCallbackURL:H.string().optional(),errorCallbackURL:H.string({description:"Callback URL to redirect to if an error happens"}).optional(),provider:Ei,disableRedirect:H.boolean({description:"Disable automatic redirection to the provider. Useful for handling the redirection yourself"}).optional(),idToken:H.optional(H.object({token:H.string({description:"ID token from the provider"}),nonce:H.string({description:"Nonce used to generate the token"}).optional(),accessToken:H.string({description:"Access token from the provider"}).optional(),refreshToken:H.string({description:"Refresh token from the provider"}).optional(),expiresAt:H.number({description:"Expiry date of the token"}).optional()}),{description:"ID token from the provider to sign in the user with id token"})}),metadata:{openapi:{description:"Sign in with a social provider",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{session:{type:"string"},user:{type:"object"},url:{type:"string"},redirect:{type:"boolean"}},required:["session","user","url","redirect"]}}}}}}}},async e=>{let o=e.context.socialProviders.find(n=>n.id===e.body.provider);if(!o)throw e.context.logger.error("Provider not found. Make sure to add the provider in your auth config",{provider:e.body.provider}),new W("NOT_FOUND",{message:f.PROVIDER_NOT_FOUND});if(e.body.idToken){if(!o.verifyIdToken)throw e.context.logger.error("Provider does not support id token verification",{provider:e.body.provider}),new W("NOT_FOUND",{message:f.ID_TOKEN_NOT_SUPPORTED});let{token:n,nonce:s}=e.body.idToken;if(!await o.verifyIdToken(n,s))throw e.context.logger.error("Invalid id token",{provider:e.body.provider}),new W("UNAUTHORIZED",{message:f.INVALID_TOKEN});let d=await o.getUserInfo({idToken:n,accessToken:e.body.idToken.accessToken,refreshToken:e.body.idToken.refreshToken});if(!d||!d?.user)throw e.context.logger.error("Failed to get user info",{provider:e.body.provider}),new W("UNAUTHORIZED",{message:f.FAILED_TO_GET_USER_INFO});if(!d.user.email)throw e.context.logger.error("User email not found",{provider:e.body.provider}),new W("UNAUTHORIZED",{message:f.USER_EMAIL_NOT_FOUND});let A=await je(e,{userInfo:{email:d.user.email,id:d.user.id,name:d.user.name||"",image:d.user.image,emailVerified:d.user.emailVerified||!1},account:{providerId:o.id,accountId:d.user.id,accessToken:e.body.idToken.accessToken}});if(A.error)throw new W("UNAUTHORIZED",{message:A.error});return await O(e,A.data),e.json({redirect:!1,token:A.data.session.token,url:void 0,user:{id:A.data.user.id,email:A.data.user.email,name:A.data.user.name,image:A.data.user.image,emailVerified:A.data.user.emailVerified,createdAt:A.data.user.createdAt,updatedAt:A.data.user.updatedAt}})}let{codeVerifier:r,state:i}=await Pe(e),t=await o.createAuthorizationURL({state:i,codeVerifier:r,redirectURI:`${e.context.baseURL}/callback/${o.id}`});return e.json({url:t.toString(),redirect:!e.body.disableRedirect})}),Bi=u("/sign-in/email",{method:"POST",body:H.object({email:H.string({description:"Email of the user"}),password:H.string({description:"Password of the user"}),callbackURL:H.string({description:"Callback URL to use as a redirect for email verification"}).optional(),rememberMe:H.boolean({description:"If this is false, the session will not be remembered. Default is `true`."}).default(!0).optional()}),metadata:{openapi:{description:"Sign in with email and password",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{user:{type:"object"},url:{type:"string"},redirect:{type:"boolean"}},required:["session","user","url","redirect"]}}}}}}}},async e=>{if(!e.context.options?.emailAndPassword?.enabled)throw e.context.logger.error("Email and password is not enabled. Make sure to enable it in the options on you `auth.ts` file. Check `https://better-auth.com/docs/authentication/email-password` for more!"),new W("BAD_REQUEST",{message:"Email and password is not enabled"});let{email:o,password:r}=e.body;if(!H.string().email().safeParse(o).success)throw new W("BAD_REQUEST",{message:f.INVALID_EMAIL});let t=await e.context.internalAdapter.findUserByEmail(o,{includeAccounts:!0});if(!t)throw await e.context.password.hash(r),e.context.logger.error("User not found",{email:o}),new W("UNAUTHORIZED",{message:f.INVALID_EMAIL_OR_PASSWORD});let n=t.accounts.find(A=>A.providerId==="credential");if(!n)throw e.context.logger.error("Credential account not found",{email:o}),new W("UNAUTHORIZED",{message:f.INVALID_EMAIL_OR_PASSWORD});let s=n?.password;if(!s)throw e.context.logger.error("Password not found",{email:o}),new W("UNAUTHORIZED",{message:f.INVALID_EMAIL_OR_PASSWORD});if(!await e.context.password.verify({hash:s,password:r}))throw e.context.logger.error("Invalid password"),new W("UNAUTHORIZED",{message:f.INVALID_EMAIL_OR_PASSWORD});if(e.context.options?.emailAndPassword?.requireEmailVerification&&!t.user.emailVerified){if(!e.context.options?.emailVerification?.sendVerificationEmail)throw new W("UNAUTHORIZED",{message:f.EMAIL_NOT_VERIFIED});let A=await fe(e.context.secret,t.user.email,void 0,e.context.options.emailVerification?.expiresIn),c=`${e.context.baseURL}/verify-email?token=${A}&callbackURL=${e.body.callbackURL||"/"}`;throw await e.context.options.emailVerification.sendVerificationEmail({user:t.user,url:c,token:A},e.request),new W("FORBIDDEN",{message:f.EMAIL_NOT_VERIFIED})}let d=await e.context.internalAdapter.createSession(t.user.id,e.headers,e.body.rememberMe===!1);if(!d)throw e.context.logger.error("Failed to create session"),new W("UNAUTHORIZED",{message:f.FAILED_TO_CREATE_SESSION});return await O(e,{session:d,user:t.user},e.body.rememberMe===!1),e.json({redirect:!!e.body.callbackURL,token:d.token,url:e.body.callbackURL,user:{id:t.user.id,email:t.user.email,name:t.user.name,image:t.user.image,emailVerified:t.user.emailVerified,createdAt:t.user.createdAt,updatedAt:t.user.updatedAt}})});import{z as Qe}from"zod";var lo=Qe.object({code:Qe.string().optional(),error:Qe.string().optional(),error_description:Qe.string().optional(),state:Qe.string().optional()}),zi=u("/callback/:id",{method:["GET","POST"],body:lo.optional(),query:lo.optional(),metadata:De},async e=>{let o;try{if(e.method==="GET")o=lo.parse(e.query);else if(e.method==="POST")o=lo.parse(e.body);else throw new Error("Unsupported method")}catch(g){throw e.context.logger.error("INVALID_CALLBACK_REQUEST",g),e.redirect(`${e.context.baseURL}/error?error=invalid_callback_request`)}let{code:r,error:i,state:t,error_description:n}=o;if(!t)throw e.context.logger.error("State not found",i),e.redirect(`${e.context.baseURL}/error?error=state_not_found`);if(!r)throw e.context.logger.error("Code not found"),e.redirect(`${e.context.baseURL}/error?error=${i||"no_code"}&error_description=${n}`);let s=e.context.socialProviders.find(g=>g.id===e.params.id);if(!s)throw e.context.logger.error("Oauth provider with id",e.params.id,"not found"),e.redirect(`${e.context.baseURL}/error?error=oauth_provider_not_found`);let{codeVerifier:a,callbackURL:d,link:A,errorURL:c,newUserURL:K}=await Ao(e),l;try{l=await s.validateAuthorizationCode({code:r,codeVerifier:a,redirectURI:`${e.context.baseURL}/callback/${s.id}`})}catch(g){throw e.context.logger.error("",g),e.redirect(`${e.context.baseURL}/error?error=please_restart_the_process`)}let p=await s.getUserInfo(l).then(g=>g?.user);function y(g){let C=c||d||`${e.context.baseURL}/error`;throw C.includes("?")?C=`${C}&error=${g}`:C=`${C}?error=${g}`,e.redirect(C)}if(!p)return e.context.logger.error("Unable to get user info"),y("unable_to_get_user_info");if(!p.email)return e.context.logger.error("Provider did not return email. This could be due to misconfiguration in the provider settings."),y("email_not_found");if(!d)throw e.context.logger.error("No callback URL found"),e.redirect(`${e.context.baseURL}/error?error=please_restart_the_process`);if(A){if(A.email!==p.email.toLowerCase())return y("email_doesn't_match");if(!await e.context.internalAdapter.createAccount({userId:A.userId,providerId:s.id,accountId:p.id}))return y("unable_to_link_account");let C;try{C=d.toString()}catch{C=d}throw e.redirect(C)}let h=await je(e,{userInfo:{...p,email:p.email,name:p.name||p.email},account:{providerId:s.id,accountId:p.id,...l,scope:l.scopes?.join(",")},callbackURL:d});if(h.error)return e.context.logger.error(h.error.split(" ").join("_")),y(h.error.split(" ").join("_"));let{session:S,user:D}=h.data;await O(e,{session:S,user:D});let B;try{B=(h.isRegister&&K||d).toString()}catch{B=h.isRegister&&K||d}throw e.redirect(B)});import{APIError as rn}from"better-call";var Fi=u("/sign-out",{method:"POST",requireHeaders:!0,metadata:{openapi:{description:"Sign out the current user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{success:{type:"boolean"}}}}}}}}}},async e=>{let o=await e.getSignedCookie(e.context.authCookies.sessionToken.name,e.context.secret);if(!o)throw G(e),new rn("BAD_REQUEST",{message:f.FAILED_TO_GET_SESSION});return await e.context.internalAdapter.deleteSession(o),G(e),e.json({success:!0})});import{z as se}from"zod";import{APIError as We}from"better-call";function Xi(e,o,r){let i=o?new URL(o,e.baseURL):new URL(`${e.baseURL}/error`);return r&&Object.entries(r).forEach(([t,n])=>i.searchParams.set(t,n)),i.href}function nn(e,o,r){let i=new URL(o,e.baseURL);return r&&Object.entries(r).forEach(([t,n])=>i.searchParams.set(t,n)),i.href}var Vi=u("/forget-password",{method:"POST",body:se.object({email:se.string({description:"The email address of the user to send a password reset email to"}).email(),redirectTo:se.string({description:"The URL to redirect the user to reset their password. If the token isn't valid or expired, it'll be redirected with a query parameter `?error=INVALID_TOKEN`. If the token is valid, it'll be redirected with a query parameter `?token=VALID_TOKEN"}).optional()}),metadata:{openapi:{description:"Send a password reset email to the user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"}}}}}}}}}},async e=>{if(!e.context.options.emailAndPassword?.sendResetPassword)throw e.context.logger.error("Reset password isn't enabled.Please pass an emailAndPassword.sendResetPasswordToken function in your auth config!"),new We("BAD_REQUEST",{message:"Reset password isn't enabled"});let{email:o,redirectTo:r}=e.body,i=await e.context.internalAdapter.findUserByEmail(o,{includeAccounts:!0});if(!i)return e.context.logger.error("Reset Password: User not found",{email:o}),e.json({status:!1},{body:{status:!0}});let t=60*60*1,n=x(e.context.options.emailAndPassword.resetPasswordTokenExpiresIn||t,"sec"),s=ee(24);await e.context.internalAdapter.createVerificationValue({value:i.user.id.toString(),identifier:`reset-password:${s}`,expiresAt:n});let a=`${e.context.baseURL}/reset-password/${s}?callbackURL=${r}`;return await e.context.options.emailAndPassword.sendResetPassword({user:i.user,url:a,token:s},e.request),e.json({status:!0})}),Mi=u("/reset-password/:token",{method:"GET",query:se.object({callbackURL:se.string({description:"The URL to redirect the user to reset their password"})}),use:[ge(e=>e.query.callbackURL)],metadata:{openapi:{description:"Redirects the user to the callback URL with the token",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{token:{type:"string"}}}}}}}}}},async e=>{let{token:o}=e.params,{callbackURL:r}=e.query;if(!o||!r)throw e.redirect(Xi(e.context,r,{error:"INVALID_TOKEN"}));let i=await e.context.internalAdapter.findVerificationValue(`reset-password:${o}`);throw!i||i.expiresAt<new Date?e.redirect(Xi(e.context,r,{error:"INVALID_TOKEN"})):e.redirect(nn(e.context,r,{token:o}))}),qi=u("/reset-password",{query:se.optional(se.object({token:se.string().optional(),currentURL:se.string().optional()})),method:"POST",body:se.object({newPassword:se.string({description:"The new password to set"}),token:se.string({description:"The token to reset the password"}).optional()}),metadata:{openapi:{description:"Reset the password for a user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"}}}}}}}}}},async e=>{let o=e.body.token||e.query?.token||(e.query?.currentURL?new URL(e.query.currentURL).searchParams.get("token"):"");if(!o)throw new We("BAD_REQUEST",{message:f.INVALID_TOKEN});let{newPassword:r}=e.body,i=e.context.password?.config.minPasswordLength,t=e.context.password?.config.maxPasswordLength;if(r.length<i)throw new We("BAD_REQUEST",{message:f.PASSWORD_TOO_SHORT});if(r.length>t)throw new We("BAD_REQUEST",{message:f.PASSWORD_TOO_LONG});let n=`reset-password:${o}`,s=await e.context.internalAdapter.findVerificationValue(n);if(!s||s.expiresAt<new Date)throw new We("BAD_REQUEST",{message:f.INVALID_TOKEN});await e.context.internalAdapter.deleteVerificationValue(s.id);let a=s.value,d=await e.context.password.hash(r);return(await e.context.internalAdapter.findAccounts(a)).find(K=>K.providerId==="credential")?(await e.context.internalAdapter.updatePassword(a,d),e.json({status:!0})):(await e.context.internalAdapter.createAccount({userId:a,providerId:"credential",password:d,accountId:a}),e.json({status:!0}))});import{z as F}from"zod";import{APIError as V}from"better-call";var Hi=()=>u("/update-user",{method:"POST",body:F.record(F.string(),F.any()),use:[I],metadata:{openapi:{description:"Update the current user",requestBody:{content:{"application/json":{schema:{type:"object",properties:{name:{type:"string",description:"The name of the user"},image:{type:"string",description:"The image of the user"}}}}}},responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{user:{type:"object"}}}}}}}}}},async e=>{let o=e.body;if(o.email)throw new V("BAD_REQUEST",{message:f.EMAIL_CAN_NOT_BE_UPDATED});let{name:r,image:i,...t}=o,n=e.context.session;if(i===void 0&&r===void 0&&Object.keys(t).length===0)return e.json({status:!0});let s=uo(e.context.options,t,"update"),a=await e.context.internalAdapter.updateUserByEmail(n.user.email,{name:r,image:i,...s});return await O(e,{session:n.session,user:a}),e.json({status:!0})}),$i=u("/change-password",{method:"POST",body:F.object({newPassword:F.string({description:"The new password to set"}),currentPassword:F.string({description:"The current password"}),revokeOtherSessions:F.boolean({description:"Revoke all other sessions"}).optional()}),use:[I],metadata:{openapi:{description:"Change the password of the user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{user:{description:"The user object",$ref:"#/components/schemas/User"}}}}}}}}}},async e=>{let{newPassword:o,currentPassword:r,revokeOtherSessions:i}=e.body,t=e.context.session,n=e.context.password.config.minPasswordLength;if(o.length<n)throw e.context.logger.error("Password is too short"),new V("BAD_REQUEST",{message:f.PASSWORD_TOO_SHORT});let s=e.context.password.config.maxPasswordLength;if(o.length>s)throw e.context.logger.error("Password is too long"),new V("BAD_REQUEST",{message:f.PASSWORD_TOO_LONG});let d=(await e.context.internalAdapter.findAccounts(t.user.id)).find(l=>l.providerId==="credential"&&l.password);if(!d||!d.password)throw new V("BAD_REQUEST",{message:f.CREDENTIAL_ACCOUNT_NOT_FOUND});let A=await e.context.password.hash(o);if(!await e.context.password.verify({hash:d.password,password:r}))throw new V("BAD_REQUEST",{message:f.INVALID_PASSWORD});await e.context.internalAdapter.updateAccount(d.id,{password:A});let K=null;if(i){await e.context.internalAdapter.deleteSessions(t.user.id);let l=await e.context.internalAdapter.createSession(t.user.id,e.headers);if(!l)throw new V("INTERNAL_SERVER_ERROR",{message:f.FAILED_TO_GET_SESSION});await O(e,{session:l,user:t.user}),K=l.token}return e.json({token:K,user:{id:t.user.id,email:t.user.email,name:t.user.name,image:t.user.image,emailVerified:t.user.emailVerified,createdAt:t.user.createdAt,updatedAt:t.user.updatedAt}})}),Zi=u("/set-password",{method:"POST",body:F.object({newPassword:F.string()}),metadata:{SERVER_ONLY:!0},use:[I]},async e=>{let{newPassword:o}=e.body,r=e.context.session,i=e.context.password.config.minPasswordLength;if(o.length<i)throw e.context.logger.error("Password is too short"),new V("BAD_REQUEST",{message:f.PASSWORD_TOO_SHORT});let t=e.context.password.config.maxPasswordLength;if(o.length>t)throw e.context.logger.error("Password is too long"),new V("BAD_REQUEST",{message:f.PASSWORD_TOO_LONG});let s=(await e.context.internalAdapter.findAccounts(r.user.id)).find(d=>d.providerId==="credential"&&d.password),a=await e.context.password.hash(o);if(!s)return await e.context.internalAdapter.linkAccount({userId:r.user.id,providerId:"credential",accountId:r.user.id,password:a}),e.json({status:!0});throw new V("BAD_REQUEST",{message:"user already has a password"})}),Gi=u("/delete-user",{method:"POST",use:[I],body:F.object({callbackURL:F.string().optional(),password:F.string().optional(),token:F.string().optional()}),metadata:{openapi:{description:"Delete the user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object"}}}}}}}},async e=>{if(!e.context.options.user?.deleteUser?.enabled)throw e.context.logger.error("Delete user is disabled. Enable it in the options",{session:e.context.session}),new V("NOT_FOUND");let o=e.context.session;if(e.body.password){let n=(await e.context.internalAdapter.findAccounts(o.user.id)).find(a=>a.providerId==="credential"&&a.password);if(!n||!n.password)throw new V("BAD_REQUEST",{message:f.CREDENTIAL_ACCOUNT_NOT_FOUND});if(!await e.context.password.verify({hash:n.password,password:e.body.password}))throw new V("BAD_REQUEST",{message:f.INVALID_PASSWORD})}else if(e.context.options.session?.freshAge){let t=o.session.createdAt.getTime(),n=e.context.options.session.freshAge;if(Date.now()-t>n)throw new V("BAD_REQUEST",{message:f.SESSION_EXPIRED})}if(e.body.token)return await No({...e,query:{token:e.body.token}}),e.json({success:!0,message:"User deleted"});if(e.context.options.user.deleteUser?.sendDeleteAccountVerification){let t=_(32,"0-9","a-z");await e.context.internalAdapter.createVerificationValue({value:o.user.id,identifier:`delete-account-${t}`,expiresAt:new Date(Date.now()+1e3*60*60*24)});let n=`${e.context.baseURL}/delete-user/callback?token=${t}&callbackURL=${e.body.callbackURL||"/"}`;return await e.context.options.user.deleteUser.sendDeleteAccountVerification({user:o.user,url:n,token:t},e.request),e.json({success:!0,message:"Verification email sent"})}let r=e.context.options.user.deleteUser?.beforeDelete;r&&await r(o.user,e.request),await e.context.internalAdapter.deleteUser(o.user.id),await e.context.internalAdapter.deleteSessions(o.user.id),await e.context.internalAdapter.deleteAccounts(o.user.id),G(e);let i=e.context.options.user.deleteUser?.afterDelete;return i&&await i(o.user,e.request),e.json({success:!0,message:"User deleted"})}),No=u("/delete-user/callback",{method:"GET",query:F.object({token:F.string(),callbackURL:F.string().optional()}),use:[ge(e=>e.query.callbackURL)]},async e=>{if(!e.context.options.user?.deleteUser?.enabled)throw e.context.logger.error("Delete user is disabled. Enable it in the options"),new V("NOT_FOUND");let o=await U(e);if(!o)throw new V("NOT_FOUND",{message:f.FAILED_TO_GET_USER_INFO});let r=await e.context.internalAdapter.findVerificationValue(`delete-account-${e.query.token}`);if(!r||r.expiresAt<new Date)throw r&&await e.context.internalAdapter.deleteVerificationValue(r.id),new V("NOT_FOUND",{message:f.INVALID_TOKEN});if(r.value!==o.user.id)throw new V("NOT_FOUND",{message:f.INVALID_TOKEN});let i=e.context.options.user.deleteUser?.beforeDelete;i&&await i(o.user,e.request),await e.context.internalAdapter.deleteUser(o.user.id),await e.context.internalAdapter.deleteSessions(o.user.id),await e.context.internalAdapter.deleteAccounts(o.user.id),await e.context.internalAdapter.deleteVerificationValue(r.id),G(e);let t=e.context.options.user.deleteUser?.afterDelete;if(t&&await t(o.user,e.request),e.query.callbackURL)throw e.redirect(e.query.callbackURL||"/");return e.json({success:!0,message:"User deleted"})}),Qi=u("/change-email",{method:"POST",query:F.object({currentURL:F.string().optional()}).optional(),body:F.object({newEmail:F.string({description:"The new email to set"}).email(),callbackURL:F.string({description:"The URL to redirect to after email verification"}).optional()}),use:[I],metadata:{openapi:{responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{user:{type:"object"},status:{type:"boolean"}}}}}}}}}},async e=>{if(!e.context.options.user?.changeEmail?.enabled)throw e.context.logger.error("Change email is disabled."),new V("BAD_REQUEST",{message:"Change email is disabled"});if(e.body.newEmail===e.context.session.user.email)throw e.context.logger.error("Email is the same"),new V("BAD_REQUEST",{message:"Email is the same"});if(await e.context.internalAdapter.findUserByEmail(e.body.newEmail))throw e.context.logger.error("Email already exists"),new V("BAD_REQUEST",{message:"Couldn't update your email"});if(e.context.session.user.emailVerified!==!0){let t=await e.context.internalAdapter.updateUserByEmail(e.context.session.user.email,{email:e.body.newEmail});return e.json({status:!0})}if(!e.context.options.user.changeEmail.sendChangeEmailVerification)throw e.context.logger.error("Verification email isn't enabled."),new V("BAD_REQUEST",{message:"Verification email isn't enabled"});let r=await fe(e.context.secret,e.context.session.user.email,e.body.newEmail,e.context.options.emailVerification?.expiresIn),i=`${e.context.baseURL}/verify-email?token=${r}&callbackURL=${e.body.callbackURL||e.query?.currentURL||"/"}`;return await e.context.options.user.changeEmail.sendChangeEmailVerification({user:e.context.session.user,newEmail:e.body.newEmail,url:i,token:r},e.request),e.json({status:!0})});import{z as ve}from"zod";import{APIError as po}from"better-call";var Wi=u("/list-accounts",{method:"GET",use:[I],metadata:{openapi:{description:"List all accounts linked to the user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"array",items:{type:"object",properties:{id:{type:"string"},provider:{type:"string"}}}}}}}}}}},async e=>{let o=e.context.session,r=await e.context.internalAdapter.findAccounts(o.user.id);return e.json(r.map(i=>({id:i.id,provider:i.providerId,createdAt:i.createdAt,updatedAt:i.updatedAt,accountId:i.accountId,scopes:i.scope?.split(",")||[]})))}),Ji=u("/link-social",{method:"POST",requireHeaders:!0,query:ve.object({currentURL:ve.string().optional()}).optional(),body:ve.object({callbackURL:ve.string({description:"The URL to redirect to after the user has signed in"}).optional(),provider:ve.enum(Uo,{description:"The OAuth2 provider to use"})}),use:[I],metadata:{openapi:{description:"Link a social account to the user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{url:{type:"string"},redirect:{type:"boolean"}},required:["url","redirect"]}}}}}}}},async e=>{let o=e.context.session;if((await e.context.internalAdapter.findAccounts(o.user.id)).find(a=>a.providerId===e.body.provider))throw new po("BAD_REQUEST",{message:f.SOCIAL_ACCOUNT_ALREADY_LINKED});let t=e.context.socialProviders.find(a=>a.id===e.body.provider);if(!t)throw e.context.logger.error("Provider not found. Make sure to add the provider in your auth config",{provider:e.body.provider}),new po("NOT_FOUND",{message:f.PROVIDER_NOT_FOUND});let n=await Pe(e,{userId:o.user.id,email:o.user.email}),s=await t.createAuthorizationURL({state:n.state,codeVerifier:n.codeVerifier,redirectURI:`${e.context.baseURL}/callback/${t.id}`});return e.json({url:s.toString(),redirect:!0})}),Yi=u("/unlink-account",{method:"POST",body:ve.object({providerId:ve.string()}),use:[Ri]},async e=>{let o=await e.context.internalAdapter.findAccounts(e.context.session.user.id);if(o.length===1)throw new po("BAD_REQUEST",{message:f.FAILED_TO_UNLINK_LAST_ACCOUNT});if(!o.find(i=>i.providerId===e.body.providerId))throw new po("BAD_REQUEST",{message:f.ACCOUNT_NOT_FOUND});return await e.context.internalAdapter.deleteAccount(e.body.providerId,e.context.session.user.id),e.json({status:!0})});var et=(e,o)=>{let r={};for(let[i,t]of Object.entries(e))r[i]=n=>t({...n,context:{...o,...n.context}}),r[i].path=t.path,r[i].method=t.method,r[i].options=t.options,r[i].headers=t.headers;return r};function ot(e){let o=e;return{newRole(r){return sn(r)}}}function sn(e){return{statements:e,authorize(o,r){for(let[i,t]of Object.entries(o)){let n=e[i];return n?(r==="OR"?t.some(a=>n.includes(a)):t.every(a=>n.includes(a)))?{success:!0}:{success:!1,error:`Unauthorized to access resource "${i}"`}:{success:!1,error:`You are not allowed to access resource: ${i}`}}return{success:!1,error:"Not authorized"}}}}var an={organization:["update","delete"],member:["create","update","delete"],invitation:["create","cancel"]},Lo=ot(an),dn=Lo.newRole({organization:["update"],invitation:["create","cancel"],member:["create","update","delete"]}),An=Lo.newRole({organization:["update","delete"],member:["create","update","delete"],invitation:["create","cancel"]}),cn=Lo.newRole({organization:[],member:[],invitation:[]}),it={admin:dn,owner:An,member:cn};var un={proto:/"(?:_|\\u0{2}5[Ff]){2}(?:p|\\u0{2}70)(?:r|\\u0{2}72)(?:o|\\u0{2}6[Ff])(?:t|\\u0{2}74)(?:o|\\u0{2}6[Ff])(?:_|\\u0{2}5[Ff]){2}"\s*:/,constructor:/"(?:c|\\u0063)(?:o|\\u006[Ff])(?:n|\\u006[Ee])(?:s|\\u0073)(?:t|\\u0074)(?:r|\\u0072)(?:u|\\u0075)(?:c|\\u0063)(?:t|\\u0074)(?:o|\\u006[Ff])(?:r|\\u0072)"\s*:/,protoShort:/"__proto__"\s*:/,constructorShort:/"constructor"\s*:/},ln=/^\s*["[{]|^\s*-?\d{1,16}(\.\d{1,17})?([Ee][+-]?\d+)?\s*$/,tt={true:!0,false:!1,null:null,undefined:void 0,nan:Number.NaN,infinity:Number.POSITIVE_INFINITY,"-infinity":Number.NEGATIVE_INFINITY},pn=/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})(?:\.(\d{1,7}))?(?:Z|([+-])(\d{2}):(\d{2}))$/;function Kn(e){return e instanceof Date&&!isNaN(e.getTime())}function mn(e){let o=pn.exec(e);if(!o)return null;let[,r,i,t,n,s,a,d,A,c,K]=o,l=new Date(Date.UTC(parseInt(r,10),parseInt(i,10)-1,parseInt(t,10),parseInt(n,10),parseInt(s,10),parseInt(a,10),d?parseInt(d.padEnd(3,"0"),10):0));if(A){let p=(parseInt(c,10)*60+parseInt(K,10))*(A==="+"?-1:1);l.setUTCMinutes(l.getUTCMinutes()+p)}return Kn(l)?l:null}function gn(e,o={}){let{strict:r=!1,warnings:i=!1,reviver:t,parseDates:n=!0}=o;if(typeof e!="string")return e;let s=e.trim();if(s[0]==='"'&&s.endsWith('"')&&!s.slice(1,-1).includes('"'))return s.slice(1,-1);let a=s.toLowerCase();if(a.length<=9&&a in tt)return tt[a];if(!ln.test(s)){if(r)throw new SyntaxError("[better-json] Invalid JSON");return e}if(Object.entries(un).some(([A,c])=>{let K=c.test(s);return K&&i&&console.warn(`[better-json] Detected potential prototype pollution attempt using ${A} pattern`),K})&&r)throw new Error("[better-json] Potential prototype pollution attempt detected");try{return JSON.parse(s,(c,K)=>{if(c==="__proto__"||c==="constructor"&&K&&typeof K=="object"&&"prototype"in K){i&&console.warn(`[better-json] Dropping "${c}" key to prevent prototype pollution`);return}if(n&&typeof K=="string"){let l=mn(K);if(l)return l}return t?t(c,K):K})}catch(A){if(r)throw A;return e}}function fn(e,o={strict:!0}){return gn(e,o)}var rt=fn;var $=(e,o)=>{let r=e.adapter;return{findOrganizationBySlug:async i=>await r.findOne({model:"organization",where:[{field:"slug",value:i}]}),createOrganization:async i=>{let t=await r.create({model:"organization",data:{...i.organization,metadata:i.organization.metadata?JSON.stringify(i.organization.metadata):void 0}}),n=await r.create({model:"member",data:{organizationId:t.id,userId:i.user.id,createdAt:new Date,role:o?.creatorRole||"owner"}});return{...t,metadata:t.metadata?JSON.parse(t.metadata):void 0,members:[{...n,user:{id:i.user.id,name:i.user.name,email:i.user.email,image:i.user.image}}]}},findMemberByEmail:async i=>{let t=await r.findOne({model:"user",where:[{field:"email",value:i.email}]});if(!t)return null;let n=await r.findOne({model:"member",where:[{field:"organizationId",value:i.organizationId},{field:"userId",value:t.id}]});return n?{...n,user:{id:t.id,name:t.name,email:t.email,image:t.image}}:null},findMemberByOrgId:async i=>{let[t,n]=await Promise.all([await r.findOne({model:"member",where:[{field:"userId",value:i.userId},{field:"organizationId",value:i.organizationId}]}),await r.findOne({model:"user",where:[{field:"id",value:i.userId}]})]);return!n||!t?null:{...t,user:{id:n.id,name:n.name,email:n.email,image:n.image}}},findMemberById:async i=>{let t=await r.findOne({model:"member",where:[{field:"id",value:i}]});if(!t)return null;let n=await r.findOne({model:"user",where:[{field:"id",value:t.userId}]});return n?{...t,user:{id:n.id,name:n.name,email:n.email,image:n.image}}:null},createMember:async i=>await r.create({model:"member",data:i}),updateMember:async(i,t)=>await r.update({model:"member",where:[{field:"id",value:i}],update:{role:t}}),deleteMember:async i=>await r.delete({model:"member",where:[{field:"id",value:i}]}),updateOrganization:async(i,t)=>{let n=await r.update({model:"organization",where:[{field:"id",value:i}],update:{...t,metadata:typeof t.metadata=="object"?JSON.stringify(t.metadata):t.metadata}});return n?{...n,metadata:n.metadata?rt(n.metadata):void 0}:null},deleteOrganization:async i=>(await r.delete({model:"member",where:[{field:"organizationId",value:i}]}),await r.delete({model:"invitation",where:[{field:"organizationId",value:i}]}),await r.delete({model:"organization",where:[{field:"id",value:i}]}),i),setActiveOrganization:async(i,t)=>await e.internalAdapter.updateSession(i,{activeOrganizationId:t}),findOrganizationById:async i=>await r.findOne({model:"organization",where:[{field:"id",value:i}]}),findFullOrganization:async({organizationId:i,isSlug:t})=>{let n=await r.findOne({model:"organization",where:[{field:t?"slug":"id",value:i}]});if(!n)return null;let[s,a]=await Promise.all([r.findMany({model:"invitation",where:[{field:"organizationId",value:n.id}]}),r.findMany({model:"member",where:[{field:"organizationId",value:n.id}]})]);if(!n)return null;let d=a.map(l=>l.userId),A=await r.findMany({model:"user",where:[{field:"id",value:d,operator:"in"}]}),c=new Map(A.map(l=>[l.id,l])),K=a.map(l=>{let p=c.get(l.userId);if(!p)throw new de("Unexpected error: User not found for member");return{...l,user:{id:p.id,name:p.name,email:p.email,image:p.image}}});return{...n,invitations:s,members:K}},listOrganizations:async i=>{let t=await r.findMany({model:"member",where:[{field:"userId",value:i}]});if(!t||t.length===0)return[];let n=t.map(a=>a.organizationId);return await r.findMany({model:"organization",where:[{field:"id",value:n,operator:"in"}]})},createInvitation:async({invitation:i,user:t})=>{let s=x(o?.invitationExpiresIn||1728e5);return await r.create({model:"invitation",data:{email:i.email,role:i.role,organizationId:i.organizationId,status:"pending",expiresAt:s,inviterId:t.id}})},findInvitationById:async i=>await r.findOne({model:"invitation",where:[{field:"id",value:i}]}),findPendingInvitation:async i=>(await r.findMany({model:"invitation",where:[{field:"email",value:i.email},{field:"organizationId",value:i.organizationId},{field:"status",value:"pending"}]})).filter(n=>new Date(n.expiresAt)>new Date),updateInvitation:async i=>await r.update({model:"invitation",where:[{field:"id",value:i.invitationId}],update:{status:i.status}})}};import"better-call";var Q=L(async e=>({})),J=L({use:[I]},async e=>({session:e.context.session}));import{z as oe}from"zod";import{z}from"zod";var nt=z.string(),hn=z.enum(["pending","accepted","rejected","canceled"]).default("pending"),qu=z.object({id:z.string().default(ee),name:z.string(),slug:z.string(),logo:z.string().nullish(),metadata:z.record(z.string()).or(z.string().transform(e=>JSON.parse(e))).nullish(),createdAt:z.date()}),Hu=z.object({id:z.string().default(ee),organizationId:z.string(),userId:z.string(),role:nt,createdAt:z.date()}),$u=z.object({id:z.string().default(ee),organizationId:z.string(),email:z.string(),role:nt,status:hn,inviterId:z.string(),expiresAt:z.date()});import{APIError as M}from"better-call";var b={YOU_ARE_NOT_ALLOWED_TO_CREATE_A_NEW_ORGANIZATION:"You are not allowed to create a new organization",YOU_HAVE_REACHED_THE_MAXIMUM_NUMBER_OF_ORGANIZATIONS:"You have reached the maximum number of organizations",ORGANIZATION_ALREADY_EXISTS:"Organization already exists",ORGANIZATION_NOT_FOUND:"Organization not found",USER_IS_NOT_A_MEMBER_OF_THE_ORGANIZATION:"User is not a member of the organization",YOU_ARE_NOT_ALLOWED_TO_UPDATE_THIS_ORGANIZATION:"You are not allowed to update this organization",YOU_ARE_NOT_ALLOWED_TO_DELETE_THIS_ORGANIZATION:"You are not allowed to delete this organization",NO_ACTIVE_ORGANIZATION:"No active organization",USER_IS_ALREADY_A_MEMBER_OF_THIS_ORGANIZATION:"User is already a member of this organization",MEMBER_NOT_FOUND:"Member not found",ROLE_NOT_FOUND:"Role not found",YOU_CANNOT_LEAVE_THE_ORGANIZATION_AS_THE_ONLY_OWNER:"You cannot leave the organization as the only owner",YOU_ARE_NOT_ALLOWED_TO_DELETE_THIS_MEMBER:"You are not allowed to delete this member",YOU_ARE_NOT_ALLOWED_TO_INVITE_USERS_TO_THIS_ORGANIZATION:"You are not allowed to invite users to this organization",USER_IS_ALREADY_INVITED_TO_THIS_ORGANIZATION:"User is already invited to this organization",INVITATION_NOT_FOUND:"Invitation not found",YOU_ARE_NOT_THE_RECIPIENT_OF_THE_INVITATION:"You are not the recipient of the invitation",YOU_ARE_NOT_ALLOWED_TO_CANCEL_THIS_INVITATION:"You are not allowed to cancel this invitation",INVITER_IS_NO_LONGER_A_MEMBER_OF_THE_ORGANIZATION:"Inviter is no longer a member of the organization",YOU_ARE_NOT_ALLOWED_TO_INVITE_USER_WITH_THIS_ROLE:"you are not allowed to invite user with this role"};var st=e=>u("/organization/invite-member",{method:"POST",use:[Q,J],body:oe.object({email:oe.string({description:"The email address of the user to invite"}),role:oe.string({description:"The role to assign to the user"}),organizationId:oe.string({description:"The organization ID to invite the user to"}).optional(),resend:oe.boolean({description:"Resend the invitation email, if the user is already invited"}).optional()}),metadata:{openapi:{description:"Invite a user to an organization",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{id:{type:"string"},email:{type:"string"},role:{type:"string"},organizationId:{type:"string"},inviterId:{type:"string"},status:{type:"string"},expiresAt:{type:"string"}},required:["id","email","role","organizationId","inviterId","status","expiresAt"]}}}}}}}},async o=>{if(!o.context.orgOptions.sendInvitationEmail)throw o.context.logger.warn("Invitation email is not enabled. Pass `sendInvitationEmail` to the plugin options to enable it."),new M("BAD_REQUEST",{message:"Invitation email is not enabled"});let r=o.context.session,i=o.body.organizationId||r.session.activeOrganizationId;if(!i)throw new M("BAD_REQUEST",{message:b.ORGANIZATION_NOT_FOUND});let t=$(o.context,o.context.orgOptions),n=await t.findMemberByOrgId({userId:r.user.id,organizationId:i});if(!n)throw new M("BAD_REQUEST",{message:b.MEMBER_NOT_FOUND});let s=o.context.roles[n.role];if(!s)throw new M("BAD_REQUEST",{message:b.ROLE_NOT_FOUND});if(s.authorize({invitation:["create"]}).error)throw new M("FORBIDDEN",{message:b.YOU_ARE_NOT_ALLOWED_TO_INVITE_USERS_TO_THIS_ORGANIZATION});let d=o.context.orgOptions.creatorRole||"owner";if(n.role!==d&&o.body.role===d)throw new M("FORBIDDEN",{message:b.YOU_ARE_NOT_ALLOWED_TO_INVITE_USER_WITH_THIS_ROLE});if(await t.findMemberByEmail({email:o.body.email,organizationId:i}))throw new M("BAD_REQUEST",{message:b.USER_IS_ALREADY_A_MEMBER_OF_THIS_ORGANIZATION});if((await t.findPendingInvitation({email:o.body.email,organizationId:i})).length&&!o.body.resend)throw new M("BAD_REQUEST",{message:b.USER_IS_ALREADY_INVITED_TO_THIS_ORGANIZATION});let K=await t.createInvitation({invitation:{role:o.body.role,email:o.body.email,organizationId:i},user:r.user}),l=await t.findOrganizationById(i);if(!l)throw new M("BAD_REQUEST",{message:b.ORGANIZATION_NOT_FOUND});return await o.context.orgOptions.sendInvitationEmail?.({id:K.id,role:K.role,email:K.email,organization:l,inviter:{...n,user:r.user}},o.request),o.json(K)}),at=u("/organization/accept-invitation",{method:"POST",body:oe.object({invitationId:oe.string({description:"The ID of the invitation to accept"})}),use:[Q,J],metadata:{openapi:{description:"Accept an invitation to an organization",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{invitation:{type:"object"},member:{type:"object"}}}}}}}}}},async e=>{let o=e.context.session,r=$(e.context,e.context.orgOptions),i=await r.findInvitationById(e.body.invitationId);if(!i||i.expiresAt<new Date||i.status!=="pending")throw new M("BAD_REQUEST",{message:b.INVITATION_NOT_FOUND});if(i.email!==o.user.email)throw new M("FORBIDDEN",{message:b.YOU_ARE_NOT_THE_RECIPIENT_OF_THE_INVITATION});let t=await r.updateInvitation({invitationId:e.body.invitationId,status:"accepted"}),n=await r.createMember({organizationId:i.organizationId,userId:o.user.id,role:i.role,createdAt:new Date});return await r.setActiveOrganization(o.session.token,i.organizationId),t?e.json({invitation:t,member:n}):e.json(null,{status:400,body:{message:b.INVITATION_NOT_FOUND}})}),dt=u("/organization/reject-invitation",{method:"POST",body:oe.object({invitationId:oe.string({description:"The ID of the invitation to reject"})}),use:[Q,J],metadata:{openapi:{description:"Reject an invitation to an organization",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{invitation:{type:"object"},member:{type:"null"}}}}}}}}}},async e=>{let o=e.context.session,r=$(e.context,e.context.orgOptions),i=await r.findInvitationById(e.body.invitationId);if(!i||i.expiresAt<new Date||i.status!=="pending")throw new M("BAD_REQUEST",{message:"Invitation not found!"});if(i.email!==o.user.email)throw new M("FORBIDDEN",{message:b.YOU_ARE_NOT_THE_RECIPIENT_OF_THE_INVITATION});let t=await r.updateInvitation({invitationId:e.body.invitationId,status:"rejected"});return e.json({invitation:t,member:null})}),At=u("/organization/cancel-invitation",{method:"POST",body:oe.object({invitationId:oe.string({description:"The ID of the invitation to cancel"})}),use:[Q,J],openapi:{description:"Cancel an invitation to an organization",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{invitation:{type:"object"}}}}}}}}},async e=>{let o=e.context.session,r=$(e.context,e.context.orgOptions),i=await r.findInvitationById(e.body.invitationId);if(!i)throw new M("BAD_REQUEST",{message:b.INVITATION_NOT_FOUND});let t=await r.findMemberByOrgId({userId:o.user.id,organizationId:i.organizationId});if(!t)throw new M("BAD_REQUEST",{message:b.MEMBER_NOT_FOUND});if(e.context.roles[t.role].authorize({invitation:["cancel"]}).error)throw new M("FORBIDDEN",{message:b.YOU_ARE_NOT_ALLOWED_TO_CANCEL_THIS_INVITATION});let s=await r.updateInvitation({invitationId:e.body.invitationId,status:"canceled"});return e.json(s)}),ct=u("/organization/get-invitation",{method:"GET",use:[Q],requireHeaders:!0,query:oe.object({id:oe.string({description:"The ID of the invitation to get"})}),metadata:{openapi:{description:"Get an invitation by ID",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{id:{type:"string"},email:{type:"string"},role:{type:"string"},organizationId:{type:"string"},inviterId:{type:"string"},status:{type:"string"},expiresAt:{type:"string"},organizationName:{type:"string"},organizationSlug:{type:"string"},inviterEmail:{type:"string"}},required:["id","email","role","organizationId","inviterId","status","expiresAt","organizationName","organizationSlug","inviterEmail"]}}}}}}}},async e=>{let o=await U(e);if(!o)throw new M("UNAUTHORIZED",{message:"Not authenticated"});let r=$(e.context,e.context.orgOptions),i=await r.findInvitationById(e.query.id);if(!i||i.status!=="pending"||i.expiresAt<new Date)throw new M("BAD_REQUEST",{message:"Invitation not found!"});if(i.email!==o.user.email)throw new M("FORBIDDEN",{message:b.YOU_ARE_NOT_THE_RECIPIENT_OF_THE_INVITATION});let t=await r.findOrganizationById(i.organizationId);if(!t)throw new M("BAD_REQUEST",{message:b.ORGANIZATION_NOT_FOUND});let n=await r.findMemberByOrgId({userId:i.inviterId,organizationId:i.organizationId});if(!n)throw new M("BAD_REQUEST",{message:b.INVITER_IS_NO_LONGER_A_MEMBER_OF_THE_ORGANIZATION});return e.json({...i,organizationName:t.name,organizationSlug:t.slug,inviterEmail:n.user.email})});import{z as ce}from"zod";import{APIError as Se}from"better-call";var ut=()=>u("/organization/add-member",{method:"POST",body:ce.object({userId:ce.string(),role:ce.string(),organizationId:ce.string().optional()}),use:[Q],metadata:{SERVER_ONLY:!0}},async e=>{let o=e.body.userId?await U(e).catch(a=>null):null,r=e.body.organizationId||o?.session.activeOrganizationId;if(!r)return e.json(null,{status:400,body:{message:b.NO_ACTIVE_ORGANIZATION}});let i=$(e.context,e.context.orgOptions),t=await e.context.internalAdapter.findUserById(e.body.userId);if(!t)throw new Se("BAD_REQUEST",{message:f.USER_NOT_FOUND});if(await i.findMemberByEmail({email:t.email,organizationId:r}))throw new Se("BAD_REQUEST",{message:b.USER_IS_ALREADY_A_MEMBER_OF_THIS_ORGANIZATION});let s=await i.createMember({id:ee(),organizationId:r,userId:t.id,role:e.body.role,createdAt:new Date});return e.json(s)}),lt=u("/organization/remove-member",{method:"POST",body:ce.object({memberIdOrEmail:ce.string({description:"The ID or email of the member to remove"}),organizationId:ce.string({description:"The ID of the organization to remove the member from. If not provided, the active organization will be used"}).optional()}),use:[Q,J],metadata:{openapi:{description:"Remove a member from an organization",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{member:{type:"object",properties:{id:{type:"string"},userId:{type:"string"},organizationId:{type:"string"},role:{type:"string"}},required:["id","userId","organizationId","role"]}},required:["member"]}}}}}}}},async e=>{let o=e.context.session,r=e.body.organizationId||o.session.activeOrganizationId;if(!r)return e.json(null,{status:400,body:{message:b.NO_ACTIVE_ORGANIZATION}});let i=$(e.context,e.context.orgOptions),t=await i.findMemberByOrgId({userId:o.user.id,organizationId:r});if(!t)throw new Se("BAD_REQUEST",{message:b.MEMBER_NOT_FOUND});let n=e.context.roles[t.role];if(!n)throw new Se("BAD_REQUEST",{message:b.ROLE_NOT_FOUND});let s=o.user.email===e.body.memberIdOrEmail||t.id===e.body.memberIdOrEmail;if(s&&t.role===(e.context.orgOptions?.creatorRole||"owner"))throw new Se("BAD_REQUEST",{message:b.YOU_CANNOT_LEAVE_THE_ORGANIZATION_AS_THE_ONLY_OWNER});if(!(s||n.authorize({member:["delete"]}).success))throw new Se("UNAUTHORIZED",{message:b.YOU_ARE_NOT_ALLOWED_TO_DELETE_THIS_MEMBER});let A=null;if(e.body.memberIdOrEmail.includes("@")?A=await i.findMemberByEmail({email:e.body.memberIdOrEmail,organizationId:r}):A=await i.findMemberById(e.body.memberIdOrEmail),A?.organizationId!==r)throw new Se("BAD_REQUEST",{message:b.MEMBER_NOT_FOUND});return await i.deleteMember(A.id),o.user.id===A.userId&&o.session.activeOrganizationId===A.organizationId&&await i.setActiveOrganization(o.session.token,null),e.json({member:A})}),pt=e=>u("/organization/update-member-role",{method:"POST",body:ce.object({role:ce.string(),memberId:ce.string(),organizationId:ce.string().optional()}),use:[Q,J],metadata:{openapi:{description:"Update the role of a member in an organization",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{member:{type:"object",properties:{id:{type:"string"},userId:{type:"string"},organizationId:{type:"string"},role:{type:"string"}},required:["id","userId","organizationId","role"]}},required:["member"]}}}}}}}},async o=>{let r=o.context.session,i=o.body.organizationId||r.session.activeOrganizationId;if(!i)return o.json(null,{status:400,body:{message:b.NO_ACTIVE_ORGANIZATION}});let t=$(o.context,o.context.orgOptions),n=await t.findMemberByOrgId({userId:r.user.id,organizationId:i});if(!n)return o.json(null,{status:400,body:{message:b.MEMBER_NOT_FOUND}});let s=o.context.roles[n.role];if(!s)return o.json(null,{status:400,body:{message:b.ROLE_NOT_FOUND}});if(s.authorize({member:["update"]}).error||o.body.role==="owner"&&n.role!=="owner")return o.json(null,{body:{message:"You are not allowed to update this member"},status:403});let d=await t.updateMember(o.body.memberId,o.body.role);return d?o.json(d):o.json(null,{status:400,body:{message:b.MEMBER_NOT_FOUND}})}),Kt=u("/organization/get-active-member",{method:"GET",use:[Q,J],metadata:{openapi:{description:"Get the active member in the organization",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{id:{type:"string"},userId:{type:"string"},organizationId:{type:"string"},role:{type:"string"}},required:["id","userId","organizationId","role"]}}}}}}}},async e=>{let o=e.context.session,r=o.session.activeOrganizationId;if(!r)return e.json(null,{status:400,body:{message:b.NO_ACTIVE_ORGANIZATION}});let t=await $(e.context,e.context.orgOptions).findMemberByOrgId({userId:o.user.id,organizationId:r});return t?e.json(t):e.json(null,{status:400,body:{message:b.MEMBER_NOT_FOUND}})});import{z as P}from"zod";import{APIError as ue}from"better-call";var mt=u("/organization/create",{method:"POST",body:P.object({name:P.string({description:"The name of the organization"}),slug:P.string({description:"The slug of the organization"}),userId:P.string({description:"The user id of the organization creator. If not provided, the current user will be used. Should only be used by admins or when called by the server."}).optional(),logo:P.string({description:"The logo of the organization"}).optional(),metadata:P.record(P.string(),P.any(),{description:"The metadata of the organization"}).optional()}),use:[Q],metadata:{openapi:{description:"Create an organization",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",description:"The organization that was created",$ref:"#/components/schemas/Organization"}}}}}}}},async e=>{let o=await U(e);if(!o&&(e.request||e.headers))throw new ue("UNAUTHORIZED");let r=o?.user||null;if(!r){if(!e.body.userId)throw new ue("UNAUTHORIZED");r=await e.context.internalAdapter.findUserById(e.body.userId)}if(!r)return e.json(null,{status:401});let i=e.context.orgOptions;if(!(typeof i?.allowUserToCreateOrganization=="function"?await i.allowUserToCreateOrganization(r):i?.allowUserToCreateOrganization===void 0?!0:i.allowUserToCreateOrganization))throw new ue("FORBIDDEN",{message:b.YOU_ARE_NOT_ALLOWED_TO_CREATE_A_NEW_ORGANIZATION});let n=$(e.context,i),s=await n.listOrganizations(r.id);if(typeof i.organizationLimit=="number"?s.length>=i.organizationLimit:typeof i.organizationLimit=="function"?await i.organizationLimit(r):!1)throw new ue("FORBIDDEN",{message:b.YOU_HAVE_REACHED_THE_MAXIMUM_NUMBER_OF_ORGANIZATIONS});if(await n.findOrganizationBySlug(e.body.slug))throw new ue("BAD_REQUEST",{message:b.ORGANIZATION_ALREADY_EXISTS});let A=await n.createOrganization({organization:{id:ee(),slug:e.body.slug,name:e.body.name,logo:e.body.logo,createdAt:new Date,metadata:e.body.metadata},user:r});return e.context.session&&await n.setActiveOrganization(e.context.session.session.token,A.id),e.json(A)}),gt=u("/organization/update",{method:"POST",body:P.object({data:P.object({name:P.string({description:"The name of the organization"}).optional(),slug:P.string({description:"The slug of the organization"}).optional(),logo:P.string({description:"The logo of the organization"}).optional(),metadata:P.record(P.string(),P.any(),{description:"The metadata of the organization"}).optional()}).partial(),organizationId:P.string().optional()}),requireHeaders:!0,use:[Q],metadata:{openapi:{description:"Update an organization",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",description:"The updated organization",$ref:"#/components/schemas/Organization"}}}}}}}},async e=>{let o=await e.context.getSession(e);if(!o)throw new ue("UNAUTHORIZED",{message:"User not found"});let r=e.body.organizationId||o.session.activeOrganizationId;if(!r)return e.json(null,{status:400,body:{message:b.ORGANIZATION_NOT_FOUND}});let i=$(e.context,e.context.orgOptions),t=await i.findMemberByOrgId({userId:o.user.id,organizationId:r});if(!t)return e.json(null,{status:400,body:{message:b.USER_IS_NOT_A_MEMBER_OF_THE_ORGANIZATION}});let n=e.context.roles[t.role];if(!n)return e.json(null,{status:400,body:{message:"Role not found!"}});if(n.authorize({organization:["update"]}).error)return e.json(null,{body:{message:b.YOU_ARE_NOT_ALLOWED_TO_UPDATE_THIS_ORGANIZATION},status:403});let a=await i.updateOrganization(r,e.body.data);return e.json(a)}),ft=u("/organization/delete",{method:"POST",body:P.object({organizationId:P.string({description:"The organization id to delete"})}),requireHeaders:!0,use:[Q],metadata:{openapi:{description:"Delete an organization",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"string",description:"The organization id that was deleted"}}}}}}}},async e=>{let o=await e.context.getSession(e);if(!o)return e.json(null,{status:401});let r=e.body.organizationId;if(!r)return e.json(null,{status:400,body:{message:b.ORGANIZATION_NOT_FOUND}});let i=$(e.context,e.context.orgOptions),t=await i.findMemberByOrgId({userId:o.user.id,organizationId:r});if(!t)return e.json(null,{status:400,body:{message:b.USER_IS_NOT_A_MEMBER_OF_THE_ORGANIZATION}});let n=e.context.roles[t.role];if(!n)return e.json(null,{status:400,body:{message:"Role not found!"}});if(n.authorize({organization:["delete"]}).error)throw new ue("FORBIDDEN",{message:b.YOU_ARE_NOT_ALLOWED_TO_DELETE_THIS_ORGANIZATION});return r===o.session.activeOrganizationId&&await i.setActiveOrganization(o.session.token,null),await i.deleteOrganization(r),e.json(r)}),ht=u("/organization/get-full-organization",{method:"GET",query:P.optional(P.object({organizationId:P.string({description:"The organization id to get"}).optional(),organizationSlug:P.string({description:"The organization slug to get"}).optional()})),requireHeaders:!0,use:[Q,J],metadata:{openapi:{description:"Get the full organization",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",description:"The organization",$ref:"#/components/schemas/Organization"}}}}}}}},async e=>{let o=e.context.session,r=e.query?.organizationSlug||e.query?.organizationId||o.session.activeOrganizationId;if(!r)return e.json(null,{status:200});let t=await $(e.context,e.context.orgOptions).findFullOrganization({organizationId:r,isSlug:!!e.query?.organizationSlug});if(!t?.members.find(s=>s.userId===o.user.id))throw new ue("FORBIDDEN",{message:b.USER_IS_NOT_A_MEMBER_OF_THE_ORGANIZATION});if(!t)throw new ue("BAD_REQUEST",{message:b.ORGANIZATION_NOT_FOUND});return e.json(t)}),yt=u("/organization/set-active",{method:"POST",body:P.object({organizationId:P.string({description:"The organization id to set as active. It can be null to unset the active organization"}).nullable().optional(),organizationSlug:P.string({description:"The organization slug to set as active. It can be null to unset the active organization if organizationId is not provided"}).optional()}),use:[J,Q],metadata:{openapi:{description:"Set the active organization",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",description:"The organization",$ref:"#/components/schemas/Organization"}}}}}}}},async e=>{let o=$(e.context,e.context.orgOptions),r=e.context.session,i=e.body.organizationSlug||e.body.organizationId;if(i===null){if(!r.session.activeOrganizationId)return e.json(null);let d=await o.setActiveOrganization(r.session.token,null);return await O(e,{session:d,user:r.user}),e.json(null)}if(!i){let a=r.session.activeOrganizationId;if(!a)return e.json(null);i=a}let t=await o.findFullOrganization({organizationId:i,isSlug:!!e.body.organizationSlug});if(!t?.members.find(a=>a.userId===r.user.id))throw await o.setActiveOrganization(r.session.token,null),new ue("FORBIDDEN",{message:b.USER_IS_NOT_A_MEMBER_OF_THE_ORGANIZATION});if(!t)throw new ue("BAD_REQUEST",{message:b.ORGANIZATION_NOT_FOUND});let s=await o.setActiveOrganization(r.session.token,t.id);return await O(e,{session:s,user:r.user}),e.json(t)}),wt=u("/organization/list",{method:"GET",use:[Q,J],metadata:{openapi:{description:"List all organizations",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"array",items:{$ref:"#/components/schemas/Organization"}}}}}}}}},async e=>{let r=await $(e.context,e.context.orgOptions).listOrganizations(e.context.session.user.id);return e.json(r)});var jl=e=>{let o={createOrganization:mt,updateOrganization:gt,deleteOrganization:ft,setActiveOrganization:yt,getFullOrganization:ht,listOrganizations:wt,createInvitation:st(e),cancelInvitation:At,acceptInvitation:at,getInvitation:ct,rejectInvitation:dt,addMember:ut(),removeMember:lt,updateMemberRole:pt(e),getActiveMember:Kt},r={...it,...e?.roles};return{id:"organization",endpoints:{...et(o,{orgOptions:e||{},roles:r,getSession:async t=>await U(t)}),hasPermission:u("/organization/has-permission",{method:"POST",requireHeaders:!0,body:xe.object({organizationId:xe.string().optional(),permission:xe.record(xe.string(),xe.array(xe.string()))}),use:[J],metadata:{openapi:{description:"Check if the user has permission",requestBody:{content:{"application/json":{schema:{type:"object",properties:{permission:{type:"object",description:"The permission to check"}},required:["permission"]}}}},responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{error:{type:"string"},success:{type:"boolean"}},required:["success"]}}}}}}}},async t=>{if(!t.body.permission||Object.keys(t.body.permission).length>1)throw new jo("BAD_REQUEST",{message:"invalid permission check. you can only check one resource permission at a time."});let n=t.body.organizationId||t.context.session.session.activeOrganizationId;if(!n)throw new jo("BAD_REQUEST",{message:b.NO_ACTIVE_ORGANIZATION});let a=await $(t.context).findMemberByOrgId({userId:t.context.session.user.id,organizationId:n});if(!a)throw new jo("UNAUTHORIZED",{message:b.USER_IS_NOT_A_MEMBER_OF_THE_ORGANIZATION});let A=r[a.role].authorize(t.body.permission);return A.error?t.json({error:A.error,success:!1},{status:403}):t.json({error:null,success:!0})})},schema:{session:{fields:{activeOrganizationId:{type:"string",required:!1,fieldName:e?.schema?.session?.fields?.activeOrganizationId}}},organization:{modelName:e?.schema?.organization?.modelName,fields:{name:{type:"string",required:!0,fieldName:e?.schema?.organization?.fields?.name},slug:{type:"string",unique:!0,fieldName:e?.schema?.organization?.fields?.slug},logo:{type:"string",required:!1,fieldName:e?.schema?.organization?.fields?.logo},createdAt:{type:"date",required:!0,fieldName:e?.schema?.organization?.fields?.createdAt},metadata:{type:"string",required:!1,fieldName:e?.schema?.organization?.fields?.metadata}}},member:{modelName:e?.schema?.member?.modelName,fields:{organizationId:{type:"string",required:!0,references:{model:"organization",field:"id"},fieldName:e?.schema?.member?.fields?.organizationId},userId:{type:"string",required:!0,fieldName:e?.schema?.member?.fields?.userId,references:{model:"user",field:"id"}},role:{type:"string",required:!0,defaultValue:"member",fieldName:e?.schema?.member?.fields?.role},createdAt:{type:"date",required:!0,fieldName:e?.schema?.member?.fields?.createdAt}}},invitation:{modelName:e?.schema?.invitation?.modelName,fields:{organizationId:{type:"string",required:!0,references:{model:"organization",field:"id"},fieldName:e?.schema?.invitation?.fields?.organizationId},email:{type:"string",required:!0,fieldName:e?.schema?.invitation?.fields?.email},role:{type:"string",required:!1,fieldName:e?.schema?.invitation?.fields?.role},status:{type:"string",required:!0,defaultValue:"pending",fieldName:e?.schema?.invitation?.fields?.status},expiresAt:{type:"date",required:!0,fieldName:e?.schema?.invitation?.fields?.expiresAt},inviterId:{type:"string",references:{model:"user",field:"id"},fieldName:e?.schema?.invitation?.fields?.inviterId,required:!0}}}},$Infer:{Organization:{},Invitation:{},Member:{},ActiveOrganization:{}},$ERROR_CODES:b}};import{z as fo}from"zod";import{z as Te}from"zod";import{APIError as Je}from"better-call";var Ko="two_factor";var mo="trust_device";import{z as Ct}from"zod";import{createHMAC as yn}from"@better-auth/utils/hmac";var ke=L({body:Ct.object({trustDevice:Ct.boolean().optional()})},async e=>{let o=await U(e);if(!o){let r=e.context.createAuthCookie(Ko),i=await e.getSignedCookie(r.name,e.context.secret);if(!i)throw new Je("UNAUTHORIZED",{message:"invalid two factor cookie"});let t=await e.context.internalAdapter.findUserById(i);if(!t)throw new Je("UNAUTHORIZED",{message:"invalid two factor cookie"});let n=await e.context.internalAdapter.createSession(i,e.request);if(!n)throw new Je("INTERNAL_SERVER_ERROR",{message:"failed to create session"});return{valid:async()=>{if(await O(e,{session:n,user:t}),e.body.trustDevice){let s=e.context.createAuthCookie(mo,{maxAge:2592e3}),a=await yn("SHA-256","base64urlnopad").sign(e.context.secret,`${t.id}!${n.token}`);await e.setSignedCookie(s.name,`${a}!${n.token}`,e.context.secret,s.attributes)}return e.json({token:n.token,user:{id:t.id,email:t.email,emailVerified:t.emailVerified,name:t.name,image:t.image,createdAt:t.createdAt,updatedAt:t.updatedAt}})},invalid:async()=>{throw new Je("UNAUTHORIZED",{message:"invalid two factor authentication"})},session:{session:n,user:t}}}return{valid:async()=>e.json({token:o.session.token,user:{id:o.user.id,email:o.user.email,emailVerified:o.user.emailVerified,name:o.user.name,image:o.user.image,createdAt:o.user.createdAt,updatedAt:o.user.updatedAt}}),invalid:async()=>{throw new Je("UNAUTHORIZED",{message:"invalid two factor authentication"})},session:o}});import{APIError as Ye}from"better-call";var Y={OTP_NOT_ENABLED:"OTP not enabled",OTP_HAS_EXPIRED:"OTP has expired",TOTP_NOT_ENABLED:"TOTP not enabled",TWO_FACTOR_NOT_ENABLED:"Two factor isn't enabled",BACKUP_CODES_NOT_ENABLED:"Backup codes aren't enabled",INVALID_BACKUP_CODE:"Invalid backup code"};function wn(e){return Array.from({length:e?.amount??10}).fill(null).map(()=>_(e?.length??10,"a-z","0-9","A-Z")).map(o=>`${o.slice(0,5)}-${o.slice(5)}`)}async function xo(e,o){let r=e,i=o?.customBackupCodesGenerate?o.customBackupCodesGenerate():wn(),t=await Ke({data:JSON.stringify(i),key:r});return{backupCodes:i,encryptedBackupCodes:t}}async function Cn(e,o){let r=await bt(e.backupCodes,o);return r?{status:r.includes(e.code),updated:r.filter(i=>i!==e.code)}:{status:!1,updated:null}}async function bt(e,o){let r=Buffer.from(await we({key:o,data:e})).toString("utf-8"),i=JSON.parse(r),t=Te.array(Te.string()).safeParse(i);return t.success?t.data:null}var Ot=e=>{let o="twoFactor";return{id:"backup_code",endpoints:{verifyBackupCode:u("/two-factor/verify-backup-code",{method:"POST",body:Te.object({code:Te.string(),disableSession:Te.boolean().optional()}),use:[ke]},async r=>{let i=r.context.session.user,t=await r.context.adapter.findOne({model:o,where:[{field:"userId",value:i.id}]});if(!t)throw new Ye("BAD_REQUEST",{message:Y.BACKUP_CODES_NOT_ENABLED});let n=await Cn({backupCodes:t.backupCodes,code:r.body.code},r.context.secret);if(!n.status)throw new Ye("UNAUTHORIZED",{message:Y.INVALID_BACKUP_CODE});let s=await Ke({key:r.context.secret,data:JSON.stringify(n.updated)});return await r.context.adapter.updateMany({model:o,update:{backupCodes:s},where:[{field:"userId",value:i.id}]}),r.body.disableSession||await O(r,{session:r.context.session.session,user:i}),r.json({user:i,session:r.context.session})}),generateBackupCodes:u("/two-factor/generate-backup-codes",{method:"POST",body:Te.object({password:Te.string()}),use:[I]},async r=>{let i=r.context.session.user;if(!i.twoFactorEnabled)throw new Ye("BAD_REQUEST",{message:Y.TWO_FACTOR_NOT_ENABLED});await r.context.password.checkPassword(i.id,r);let t=await xo(r.context.secret,e);return await r.context.adapter.update({model:o,update:{backupCodes:t.encryptedBackupCodes},where:[{field:"userId",value:r.context.session.user.id}]}),r.json({status:!0,backupCodes:t.backupCodes})}),viewBackupCodes:u("/two-factor/view-backup-codes",{method:"GET",body:Te.object({userId:Te.string()}),metadata:{SERVER_ONLY:!0}},async r=>{let i=await r.context.adapter.findOne({model:o,where:[{field:"userId",value:r.body.userId}]});if(!i)throw new Ye("BAD_REQUEST",{message:"Backup codes aren't enabled"});let t=await bt(i.backupCodes,r.context.secret);if(!t)throw new Ye("BAD_REQUEST",{message:Y.BACKUP_CODES_NOT_ENABLED});return r.json({status:!0,backupCodes:t})})}}};import{APIError as Xe}from"better-call";import{z as Tt}from"zod";var Et=e=>{let o={...e,digits:e?.digits||6,period:(e?.period||3)*60*1e3},r="twoFactor",i=u("/two-factor/send-otp",{method:"POST",use:[ke],metadata:{openapi:{summary:"Send two factor OTP",description:"Send two factor OTP to the user",responses:{200:{description:"Successful response",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"}}}}}}}}}},async n=>{if(!e||!e.sendOTP)throw n.context.logger.error("send otp isn't configured. Please configure the send otp function on otp options."),new Xe("BAD_REQUEST",{message:"otp isn't configured"});let s=n.context.session.user;if(!await n.context.adapter.findOne({model:r,where:[{field:"userId",value:s.id}]}))throw new Xe("BAD_REQUEST",{message:Y.OTP_NOT_ENABLED});let d=_(o.digits,"0-9");return await n.context.internalAdapter.createVerificationValue({value:d,identifier:`2fa-otp-${s.id}`,expiresAt:new Date(Date.now()+o.period)}),await e.sendOTP({user:s,otp:d},n.request),n.json({status:!0})}),t=u("/two-factor/verify-otp",{method:"POST",body:Tt.object({code:Tt.string({description:"The otp code to verify"})}),use:[ke],metadata:{openapi:{summary:"Verify two factor OTP",description:"Verify two factor OTP",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"}}}}}}}}}},async n=>{let s=n.context.session.user;if(!s.twoFactorEnabled)throw new Xe("BAD_REQUEST",{message:"two factor isn't enabled"});if(!await n.context.adapter.findOne({model:r,where:[{field:"userId",value:s.id}]}))throw new Xe("BAD_REQUEST",{message:Y.OTP_NOT_ENABLED});let d=await n.context.internalAdapter.findVerificationValue(`2fa-otp-${s.id}`);if(!d||d.expiresAt<new Date)throw new Xe("BAD_REQUEST",{message:Y.OTP_HAS_EXPIRED});return d.value===n.body.code?n.context.valid():n.context.invalid()});return{id:"otp",endpoints:{sendTwoFactorOTP:i,verifyTwoFactorOTP:t}}};import{APIError as Be}from"better-call";import{z as go}from"zod";import{createOTP as Bo}from"@better-auth/utils/otp";var Rt=e=>{let o={...e,digits:e?.digits||6,period:e?.period||30},r="twoFactor",i=u("/totp/generate",{method:"POST",use:[I],metadata:{openapi:{summary:"Generate TOTP code",description:"Use this endpoint to generate a TOTP code",responses:{200:{description:"Successful response",content:{"application/json":{schema:{type:"object",properties:{code:{type:"string"}}}}}}}}}},async s=>{if(e?.disable)throw s.context.logger.error("totp isn't configured. please pass totp option on two factor plugin to enable totp"),new Be("BAD_REQUEST",{message:"totp isn't configured"});let a=s.context.session.user,d=await s.context.adapter.findOne({model:r,where:[{field:"userId",value:a.id}]});if(!d)throw new Be("BAD_REQUEST",{message:Y.TOTP_NOT_ENABLED});return{code:await Bo(d.secret,{period:o.period,digits:o.digits}).totp()}}),t=u("/two-factor/get-totp-uri",{method:"POST",use:[I],body:go.object({password:go.string({description:"User password"})}),metadata:{openapi:{summary:"Get TOTP URI",description:"Use this endpoint to get the TOTP URI",responses:{200:{description:"Successful response",content:{"application/json":{schema:{type:"object",properties:{totpURI:{type:"string"}}}}}}}}}},async s=>{if(e?.disable)throw s.context.logger.error("totp isn't configured. please pass totp option on two factor plugin to enable totp"),new Be("BAD_REQUEST",{message:"totp isn't configured"});let a=s.context.session.user,d=await s.context.adapter.findOne({model:r,where:[{field:"userId",value:a.id}]});if(!d||!a.twoFactorEnabled)throw new Be("BAD_REQUEST",{message:Y.TOTP_NOT_ENABLED});let A=await we({key:s.context.secret,data:d.secret});return await s.context.password.checkPassword(a.id,s),{totpURI:Bo(A,{digits:o.digits,period:o.period}).url(e?.issuer||s.context.appName,a.email)}}),n=u("/two-factor/verify-totp",{method:"POST",body:go.object({code:go.string({description:"The otp code to verify"})}),use:[ke],metadata:{openapi:{summary:"Verify two factor TOTP",description:"Verify two factor TOTP",responses:{200:{description:"Successful response",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"}}}}}}}}}},async s=>{if(e?.disable)throw s.context.logger.error("totp isn't configured. please pass totp option on two factor plugin to enable totp"),new Be("BAD_REQUEST",{message:"totp isn't configured"});let a=s.context.session.user,d=await s.context.adapter.findOne({model:r,where:[{field:"userId",value:a.id}]});if(!d)throw new Be("BAD_REQUEST",{message:Y.TOTP_NOT_ENABLED});let A=await we({key:s.context.secret,data:d.secret});if(!await Bo(A,{period:o.period,digits:o.digits}).verify(s.body.code))return s.context.invalid();if(!a.twoFactorEnabled){let K=await s.context.internalAdapter.updateUser(a.id,{twoFactorEnabled:!0}),l=await s.context.internalAdapter.createSession(a.id,s.request,!1,s.context.session.session).catch(p=>{throw p});await s.context.internalAdapter.deleteSession(s.context.session.session.token),await O(s,{session:l,user:K})}return s.context.valid()});return{id:"totp",endpoints:{generateTOTP:i,getTOTPURI:t,verifyTOTP:n}}};import{APIError as Ep}from"better-call";async function zo(e,o){let i=(await e.context.internalAdapter.findAccounts(o.userId))?.find(s=>s.providerId==="credential"),t=i?.password;return!i||!t?!1:await e.context.password.verify({hash:t,password:o.password})}import{APIError as _t}from"better-call";var It={user:{fields:{twoFactorEnabled:{type:"boolean",required:!1,defaultValue:!1,input:!1}}},twoFactor:{fields:{secret:{type:"string",required:!0,returned:!1},backupCodes:{type:"string",required:!0,returned:!1},userId:{type:"string",required:!0,returned:!1,references:{model:"user",field:"id"}}}}};import{createOTP as bn}from"@better-auth/utils/otp";import{createHMAC as Ut}from"@better-auth/utils/hmac";var _p=e=>({id:"two-factor",$InferServerPlugin:{},atomListeners:[{matcher:o=>o.startsWith("/two-factor/"),signal:"$sessionSignal"}],pathMethods:{"/two-factor/disable":"POST","/two-factor/enable":"POST","/two-factor/send-otp":"POST","/two-factor/generate-backup-codes":"POST"},fetchPlugins:[{id:"two-factor",name:"two-factor",hooks:{async onSuccess(o){o.data?.twoFactorRedirect&&e?.onTwoFactorRedirect&&await e.onTwoFactorRedirect()}}}]});var Zp=e=>{let o={twoFactorTable:"twoFactor"},r=Rt(e?.totpOptions),i=Ot(e?.backupCodeOptions),t=Et(e?.otpOptions);return{id:"two-factor",endpoints:{...r.endpoints,...t.endpoints,...i.endpoints,enableTwoFactor:u("/two-factor/enable",{method:"POST",body:fo.object({password:fo.string({description:"User password"}).min(8)}),use:[I],metadata:{openapi:{summary:"Enable two factor authentication",description:"Use this endpoint to enable two factor authentication. This will generate a TOTP URI and backup codes. Once the user verifies the TOTP URI, the two factor authentication will be enabled.",responses:{200:{description:"Successful response",content:{"application/json":{schema:{type:"object",properties:{totpURI:{type:"string",description:"TOTP URI"},backupCodes:{type:"array",items:{type:"string"},description:"Backup codes"}}}}}}}}}},async n=>{let s=n.context.session.user,{password:a}=n.body;if(!await zo(n,{password:a,userId:s.id}))throw new _t("BAD_REQUEST",{message:f.INVALID_PASSWORD});let A=_(32),c=await Ke({key:n.context.secret,data:A}),K=await xo(n.context.secret,e?.backupCodeOptions);if(e?.skipVerificationOnEnable){let p=await n.context.internalAdapter.updateUser(s.id,{twoFactorEnabled:!0}),y=await n.context.internalAdapter.createSession(p.id,n.request,!1,n.context.session.session);await O(n,{session:y,user:p}),await n.context.internalAdapter.deleteSession(n.context.session.session.token)}await n.context.adapter.deleteMany({model:o.twoFactorTable,where:[{field:"userId",value:s.id}]}),await n.context.adapter.create({model:o.twoFactorTable,data:{secret:c,backupCodes:K.encryptedBackupCodes,userId:s.id}});let l=bn(A,{digits:e?.totpOptions?.digits||6,period:e?.totpOptions?.period}).url(e?.issuer||n.context.appName,s.email);return n.json({totpURI:l,backupCodes:K.backupCodes})}),disableTwoFactor:u("/two-factor/disable",{method:"POST",body:fo.object({password:fo.string({description:"User password"}).min(8)}),use:[I],metadata:{openapi:{summary:"Disable two factor authentication",description:"Use this endpoint to disable two factor authentication.",responses:{200:{description:"Successful response",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"}}}}}}}}}},async n=>{let s=n.context.session.user,{password:a}=n.body;if(!await zo(n,{password:a,userId:s.id}))throw new _t("BAD_REQUEST",{message:"Invalid password"});let A=await n.context.internalAdapter.updateUser(s.id,{twoFactorEnabled:!1});await n.context.adapter.delete({model:o.twoFactorTable,where:[{field:"userId",value:A.id}]});let c=await n.context.internalAdapter.createSession(A.id,n.request,!1,n.context.session.session);return await O(n,{session:c,user:A}),await n.context.internalAdapter.deleteSession(n.context.session.session.token),n.json({status:!0})})},options:e,hooks:{after:[{matcher(n){return n.path==="/sign-in/email"||n.path==="/sign-in/username"||n.path==="/sign-in/phone-number"},handler:L(async n=>{let s=n.context.newSession;if(!s||!s?.user.twoFactorEnabled)return;let a=n.context.createAuthCookie(mo),d=await n.getSignedCookie(a.name,n.context.secret);if(d){let[c,K]=d.split("!"),l=await Ut("SHA-256","base64urlnopad").sign(n.context.secret,`${s.user.id}!${K}`);if(c===l){let p=await Ut("SHA-256","base64urlnopad").sign(n.context.secret,`${s.user.id}!${K}`);await n.setSignedCookie(a.name,`${p}!${s.session.token}`,n.context.secret,a.attributes);return}}G(n),await n.context.internalAdapter.deleteSession(s.session.token);let A=n.context.createAuthCookie(Ko,{maxAge:60*10});return await n.setSignedCookie(A.name,s.user.id,n.context.secret,A.attributes),n.json({twoFactorRedirect:!0})})}]},schema:he(It,e?.schema),rateLimit:[{pathMatcher(n){return n.startsWith("/two-factor/")},window:10,max:3}]}};import{z as ho}from"zod";import{APIError as ze}from"better-call";var vt=()=>{let e={INVALID_USERNAME_OR_PASSWORD:"invalid username or password",EMAIL_NOT_VERIFIED:"email not verified",UNEXPECTED_ERROR:"unexpected error",USERNAME_IS_ALREADY_TAKEN:"username is already taken. please try another."};return{id:"username",endpoints:{signInUsername:u("/sign-in/username",{method:"POST",body:ho.object({username:ho.string({description:"The username of the user"}),password:ho.string({description:"The password of the user"}),rememberMe:ho.boolean({description:"Remember the user session"}).optional()}),metadata:{openapi:{summary:"Sign in with username",description:"Sign in with username",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{user:{$ref:"#/components/schemas/User"},session:{$ref:"#/components/schemas/Session"}}}}}}}}}},async o=>{let r=await o.context.adapter.findOne({model:"user",where:[{field:"username",value:o.body.username.toLowerCase()}]});if(!r)throw await o.context.password.hash(o.body.password),o.context.logger.error("User not found",{username:vt}),new ze("UNAUTHORIZED",{message:e.INVALID_USERNAME_OR_PASSWORD});if(!r.emailVerified&&o.context.options.emailAndPassword?.requireEmailVerification)throw await Po(o,r),new ze("UNAUTHORIZED",{message:e.INVALID_USERNAME_OR_PASSWORD});let i=await o.context.adapter.findOne({model:"account",where:[{field:"userId",value:r.id},{field:"providerId",value:"credential"}]});if(!i)throw new ze("UNAUTHORIZED",{message:e.INVALID_USERNAME_OR_PASSWORD});let t=i?.password;if(!t)throw o.context.logger.error("Password not found",{username:vt}),new ze("UNAUTHORIZED",{message:e.INVALID_USERNAME_OR_PASSWORD});if(!await o.context.password.verify({hash:t,password:o.body.password}))throw o.context.logger.error("Invalid password"),new ze("UNAUTHORIZED",{message:e.INVALID_USERNAME_OR_PASSWORD});let s=await o.context.internalAdapter.createSession(r.id,o.request,o.body.rememberMe===!1);return s?(await O(o,{session:s,user:r},o.body.rememberMe===!1),o.json({token:s.token,user:{id:r.id,email:r.email,emailVerified:r.emailVerified,name:r.name,image:r.image,createdAt:r.createdAt,updatedAt:r.updatedAt}})):o.json(null,{status:500,body:{message:f.FAILED_TO_CREATE_SESSION,status:500}})})},schema:{user:{fields:{username:{type:"string",required:!1,unique:!0,returned:!0,transform:{input(o){return o?.toString().toLowerCase()}}}}}},hooks:{before:[{matcher(o){return o.path==="/sign-up/email"},async handler(o){let r=o.body.username;if(r&&await o.context.adapter.findOne({model:"user",where:[{field:"username",value:r.toLowerCase()}]}))throw new ze("UNPROCESSABLE_ENTITY",{message:e.USERNAME_IS_ALREADY_TAKEN})}}]},$ERROR_CODES:Y}};import{serializeSigned as On}from"better-call";import{createHMAC as Tn}from"@better-auth/utils/hmac";var AK=e=>({id:"bearer",hooks:{before:[{matcher(o){return!!(o.request?.headers.get("authorization")||o.headers?.get("authorization"))},handler:async o=>{let r=o.request?.headers.get("authorization")?.replace("Bearer ","")||o.headers?.get("authorization")?.replace("Bearer ","");if(!r)return;let i="";if(r.includes("."))i=r.replace("=","");else{if(e?.requireSignature)return;i=(await On("",r,o.context.secret)).replace("=","")}try{let t=decodeURIComponent(i);if(!await Tn("SHA-256","base64urlnopad").verify(o.context.secret,t.split(".")[0],t.split(".")[1]))return}catch{return}return o.request&&o.request.headers.append("cookie",`${o.context.authCookies.sessionToken.name}=${i}`),o.headers&&o.headers.append("cookie",`${o.context.authCookies.sessionToken.name}=${i}`),{context:o}}}],after:[{matcher(o){return!!o.responseHeader.get("set-cookie")},handler:L(async o=>{let r=o.responseHeader.get("set-cookie");if(!r)return;let i=Ee(r),t=o.context.authCookies.sessionToken.name,n=i.get(t);if(!n||!n.value||n["max-age"]===0)return;let s=n.value;return o.responseHeader.set("set-auth-token",s),{responseHeader:o.responseHeader}})}]}});import{z as Fe}from"zod";import{APIError as En}from"better-call";var hK=e=>({id:"magic-link",endpoints:{signInMagicLink:u("/sign-in/magic-link",{method:"POST",requireHeaders:!0,body:Fe.object({email:Fe.string({description:"Email address to send the magic link"}).email(),callbackURL:Fe.string({description:"URL to redirect after magic link verification"}).optional()}),metadata:{openapi:{description:"Sign in with magic link",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"}}}}}}}}}},async o=>{let{email:r}=o.body;if(e.disableSignUp&&!await o.context.internalAdapter.findUserByEmail(r))throw new En("BAD_REQUEST",{message:f.USER_NOT_FOUND});let i=_(32,"a-z","A-Z");await o.context.internalAdapter.createVerificationValue({identifier:i,value:r,expiresAt:new Date(Date.now()+(e.expiresIn||60*5)*1e3)});let t=`${o.context.baseURL}/magic-link/verify?token=${i}&callbackURL=${o.body.callbackURL||"/"}`;return await e.sendMagicLink({email:r,url:t,token:i},o.request),o.json({status:!0})}),magicLinkVerify:u("/magic-link/verify",{method:"GET",query:Fe.object({token:Fe.string({description:"Verification token"}),callbackURL:Fe.string({description:"URL to redirect after magic link verification, if not provided will return session"}).optional()}),use:[ge(o=>o.query.callbackURL)],requireHeaders:!0,metadata:{openapi:{description:"Verify magic link",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{session:{$ref:"#/components/schemas/Session"},user:{$ref:"#/components/schemas/User"}}}}}}}}}},async o=>{let{token:r,callbackURL:i}=o.query,t=i?.startsWith("http")?i:i?`${o.context.options.baseURL}${i}`:o.context.options.baseURL,n=await o.context.internalAdapter.findVerificationValue(r);if(!n)throw o.redirect(`${t}?error=INVALID_TOKEN`);if(n.expiresAt<new Date)throw await o.context.internalAdapter.deleteVerificationValue(n.id),o.redirect(`${t}?error=EXPIRED_TOKEN`);await o.context.internalAdapter.deleteVerificationValue(n.id);let s=n.value,a=await o.context.internalAdapter.findUserByEmail(s).then(A=>A?.user);if(!a){if(e.disableSignUp)throw o.redirect(`${t}?error=failed_to_create_user`);if(a=await o.context.internalAdapter.createUser({email:s,emailVerified:!0,name:s}),!a)throw o.redirect(`${t}?error=failed_to_create_user`)}a.emailVerified||await o.context.internalAdapter.updateUser(a.id,{emailVerified:!0});let d=await o.context.internalAdapter.createSession(a.id,o.headers);if(!d)throw o.redirect(`${t}?error=failed_to_create_session`);if(await O(o,{session:d,user:a}),!i)return o.json({token:d.token,user:{id:a.id,email:a.email,emailVerified:a.emailVerified,name:a.name,image:a.image,createdAt:a.createdAt,updatedAt:a.updatedAt}});throw o.redirect(i)})},rateLimit:[{pathMatcher(o){return o.startsWith("/sign-in/magic-link")||o.startsWith("/magic-link/verify")},window:e.rateLimit?.window||60,max:e.rateLimit?.max||5}]});import{z as le}from"zod";import{APIError as X}from"better-call";function Rn(e){return _(e,"0-9")}var UK=e=>{let o={expiresIn:e?.expiresIn||300,otpLength:e?.otpLength||6,...e,phoneNumber:"phoneNumber",phoneNumberVerified:"phoneNumberVerified",code:"code",createdAt:"createdAt"},r={INVALID_PHONE_NUMBER:"Invalid phone number",INVALID_PHONE_NUMBER_OR_PASSWORD:"Invalid phone number or password",UNEXPECTED_ERROR:"Unexpected error",OTP_NOT_FOUND:"OTP not found"};return{id:"phone-number",endpoints:{signInPhoneNumber:u("/sign-in/phone-number",{method:"POST",body:le.object({phoneNumber:le.string({description:"Phone number to sign in"}),password:le.string({description:"Password to use for sign in"}),rememberMe:le.boolean({description:"Remember the session"}).optional()}),metadata:{openapi:{summary:"Sign in with phone number",description:"Use this endpoint to sign in with phone number",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{user:{$ref:"#/components/schemas/User"},session:{$ref:"#/components/schemas/Session"}}}}}},400:{description:"Invalid phone number or password"}}}}},async i=>{let{password:t,phoneNumber:n}=i.body;if(o.phoneNumberValidator&&!await o.phoneNumberValidator(i.body.phoneNumber))throw new X("BAD_REQUEST",{message:r.INVALID_PHONE_NUMBER});let s=await i.context.adapter.findOne({model:"user",where:[{field:"phoneNumber",value:n}]});if(!s)throw new X("UNAUTHORIZED",{message:r.INVALID_PHONE_NUMBER_OR_PASSWORD});let d=(await i.context.internalAdapter.findAccountByUserId(s.id)).find(l=>l.providerId==="credential");if(!d)throw i.context.logger.error("Credential account not found",{phoneNumber:n}),new X("UNAUTHORIZED",{message:r.INVALID_PHONE_NUMBER_OR_PASSWORD});let A=d?.password;if(!A)throw i.context.logger.error("Password not found",{phoneNumber:n}),new X("UNAUTHORIZED",{message:r.UNEXPECTED_ERROR});if(!await i.context.password.verify({hash:A,password:t}))throw i.context.logger.error("Invalid password"),new X("UNAUTHORIZED",{message:r.INVALID_PHONE_NUMBER_OR_PASSWORD});let K=await i.context.internalAdapter.createSession(s.id,i.headers,i.body.rememberMe===!1);if(!K)throw i.context.logger.error("Failed to create session"),new X("UNAUTHORIZED",{message:f.FAILED_TO_CREATE_SESSION});return await O(i,{session:K,user:s},i.body.rememberMe===!1),i.json({token:K.token,user:{id:s.id,email:s.email,emailVerified:s.emailVerified,name:s.name,image:s.image,phoneNumber:s.phoneNumber,phoneNumberVerified:s.phoneNumberVerified,createdAt:s.createdAt,updatedAt:s.updatedAt}})}),sendPhoneNumberOTP:u("/phone-number/send-otp",{method:"POST",body:le.object({phoneNumber:le.string({description:"Phone number to send OTP"})}),metadata:{openapi:{summary:"Send OTP to phone number",description:"Use this endpoint to send OTP to phone number",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"}}}}}}}}}},async i=>{if(!e?.sendOTP)throw i.context.logger.warn("sendOTP not implemented"),new X("NOT_IMPLEMENTED",{message:"sendOTP not implemented"});if(o.phoneNumberValidator&&!await o.phoneNumberValidator(i.body.phoneNumber))throw new X("BAD_REQUEST",{message:r.INVALID_PHONE_NUMBER});let t=Rn(o.otpLength);return await i.context.internalAdapter.createVerificationValue({value:t,identifier:i.body.phoneNumber,expiresAt:x(o.expiresIn,"sec")}),await e.sendOTP({phoneNumber:i.body.phoneNumber,code:t},i.request),i.json({code:t},{body:{message:"Code sent"}})}),verifyPhoneNumber:u("/phone-number/verify",{method:"POST",body:le.object({phoneNumber:le.string({description:"Phone number to verify"}),code:le.string({description:"OTP code"}),disableSession:le.boolean({description:"Disable session creation after verification"}).optional(),updatePhoneNumber:le.boolean({description:"Check if there is a session and update the phone number"}).optional()}),metadata:{openapi:{summary:"Verify phone number",description:"Use this endpoint to verify phone number",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{user:{$ref:"#/components/schemas/User"},session:{$ref:"#/components/schemas/Session"}}}}}},400:{description:"Invalid OTP"}}}}},async i=>{let t=await i.context.internalAdapter.findVerificationValue(i.body.phoneNumber);if(!t||t.expiresAt<new Date)throw t&&t.expiresAt<new Date?(await i.context.internalAdapter.deleteVerificationValue(t.id),new X("BAD_REQUEST",{message:"OTP expired"})):new X("BAD_REQUEST",{message:r.OTP_NOT_FOUND});if(t.value!==i.body.code)throw new X("BAD_REQUEST",{message:"Invalid OTP"});if(await i.context.internalAdapter.deleteVerificationValue(t.id),i.body.updatePhoneNumber){let s=await U(i);if(!s)throw new X("UNAUTHORIZED",{message:f.USER_NOT_FOUND});let a=await i.context.internalAdapter.updateUser(s.user.id,{[o.phoneNumber]:i.body.phoneNumber,[o.phoneNumberVerified]:!0});return i.json({status:!0,token:s.session.token,user:{id:a.id,email:a.email,emailVerified:a.emailVerified,name:a.name,image:a.image,phoneNumber:a.phoneNumber,phoneNumberVerified:a.phoneNumberVerified,createdAt:a.createdAt,updatedAt:a.updatedAt}})}let n=await i.context.adapter.findOne({model:"user",where:[{value:i.body.phoneNumber,field:o.phoneNumber}]});if(await e?.callbackOnVerification?.({phoneNumber:i.body.phoneNumber,user:n},i.request),n)n=await i.context.internalAdapter.updateUser(n.id,{[o.phoneNumberVerified]:!0});else if(e?.signUpOnVerification){if(n=await i.context.internalAdapter.createUser({email:e.signUpOnVerification.getTempEmail(i.body.phoneNumber),name:e.signUpOnVerification.getTempName?e.signUpOnVerification.getTempName(i.body.phoneNumber):i.body.phoneNumber,[o.phoneNumber]:i.body.phoneNumber,[o.phoneNumberVerified]:!0}),!n)throw new X("INTERNAL_SERVER_ERROR",{message:f.FAILED_TO_CREATE_USER})}else return i.json(null);if(!n)throw new X("INTERNAL_SERVER_ERROR",{message:f.FAILED_TO_UPDATE_USER});if(!i.body.disableSession){let s=await i.context.internalAdapter.createSession(n.id,i.request);if(!s)throw new X("INTERNAL_SERVER_ERROR",{message:f.FAILED_TO_CREATE_SESSION});return await O(i,{session:s,user:n}),i.json({status:!0,token:s.token,user:{id:n.id,email:n.email,emailVerified:n.emailVerified,name:n.name,image:n.image,phoneNumber:n.phoneNumber,phoneNumberVerified:n.phoneNumberVerified,createdAt:n.createdAt,updatedAt:n.updatedAt}})}return i.json({status:!0,token:null,user:{id:n.id,email:n.email,emailVerified:n.emailVerified,name:n.name,image:n.image,phoneNumber:n.phoneNumber,phoneNumberVerified:n.phoneNumberVerified,createdAt:n.createdAt,updatedAt:n.updatedAt}})})},schema:he(In,e?.schema),$ERROR_CODES:r}},In={user:{fields:{phoneNumber:{type:"string",required:!1,unique:!0,returned:!0},phoneNumberVerified:{type:"boolean",required:!1,returned:!0,input:!1}}}};var _n={user:{fields:{isAnonymous:{type:"boolean",required:!1}}}},NK=e=>{let o={FAILED_TO_CREATE_USER:"Failed to create user",COULD_NOT_CREATE_SESSION:"Could not create session",ANONYMOUS_USERS_CANNOT_SIGN_IN_AGAIN_ANONYMOUSLY:"Anonymous users cannot sign in again anonymously"};return{id:"anonymous",endpoints:{signInAnonymous:u("/sign-in/anonymous",{method:"POST",metadata:{openapi:{description:"Sign in anonymously",responses:{200:{description:"Sign in anonymously",content:{"application/json":{schema:{type:"object",properties:{user:{$ref:"#/components/schemas/User"},session:{$ref:"#/components/schemas/Session"}}}}}}}}}},async r=>{let{emailDomainName:i=Re(r.context.baseURL)}=e||{},t=r.context.generateId({model:"user"}),n=`temp-${t}@${i}`,s=await r.context.internalAdapter.createUser({id:t,email:n,emailVerified:!1,isAnonymous:!0,name:"Anonymous",createdAt:new Date,updatedAt:new Date});if(!s)return r.json(null,{status:500,body:{message:o.FAILED_TO_CREATE_USER,status:500}});let a=await r.context.internalAdapter.createSession(s.id,r.request);return a?(await O(r,{session:a,user:s}),r.json({token:a.token,user:{id:s.id,email:s.email,emailVerified:s.emailVerified,name:s.name,createdAt:s.createdAt,updatedAt:s.updatedAt}})):r.json(null,{status:400,body:{message:o.COULD_NOT_CREATE_SESSION}})})},hooks:{after:[{matcher(r){return!!r.responseHeader.get("set-cookie")?.includes(r.context.authCookies.sessionToken.name)&&(r.path.startsWith("/sign-in")||r.path.startsWith("/callback")||r.path.startsWith("/oauth2/callback")||r.path.startsWith("/magic-link/verify")||r.path.startsWith("/email-otp/verify-email"))},handler:L(async r=>{let t=r.responseHeader.get("set-cookie"),n=r.context.authCookies.sessionToken.name;if(!Ee(t||"").get(n)?.value.split(".")[0])return;let a=await U(r,{disableRefresh:!0});if(!a||!a.user.isAnonymous)return;if(r.path==="/sign-in/anonymous")throw new m("BAD_REQUEST",{message:o.ANONYMOUS_USERS_CANNOT_SIGN_IN_AGAIN_ANONYMOUSLY});let d=r.context.newSession;d&&(e?.onLinkAccount&&await e?.onLinkAccount?.({anonymousUser:a,newUser:d}),e?.disableDeleteAnonymousUser||await r.context.internalAdapter.deleteUser(a.user.id))})}]},schema:he(_n,e?.schema),$ERROR_CODES:o}};import{z as T}from"zod";import{APIError as Un}from"better-call";var St=async e=>{let o=e.context.returned;return o?o instanceof Response?o.status!==200?null:await o.clone().json():o instanceof Un?null:o:null};var GK=e=>{let o={defaultRole:"user",adminRole:"admin",...e},r={FAILED_TO_CREATE_USER:"Failed to create user",USER_ALREADY_EXISTS:"User already exists",USER_NOT_FOUND:"User not found",YOU_CANNOT_BAN_YOURSELF:"You cannot ban yourself",ONLY_ADMINS_CAN_ACCESS_THIS_ENDPOINT:"Only admins can access this endpoint"},i=L(async t=>{let n=await U(t);if(!n?.session)throw new m("UNAUTHORIZED");let s=n.user;if(!s.role||(Array.isArray(o.adminRole)?!o.adminRole.includes(s.role):s.role!==o.adminRole))throw new m("FORBIDDEN",{message:"Only admins can access this endpoint"});return{session:{user:s,session:n.session}}});return{id:"admin",init(t){return{options:{databaseHooks:{user:{create:{async before(n){if(e?.defaultRole!==!1)return{data:{role:e?.defaultRole??"user",...n}}}}},session:{create:{async before(n){let s=await t.internalAdapter.findUserById(n.userId);if(s.banned){if(s.banExpires&&s.banExpires.getTime()<Date.now()){await t.internalAdapter.updateUser(n.userId,{banned:!1,banReason:null,banExpires:null});return}return!1}}}}}}}},hooks:{after:[{matcher(t){return t.path==="/list-sessions"},handler:L(async t=>{let n=await St(t);if(!n)return;let s=n.filter(a=>!a.impersonatedBy);return t.json(s)})}]},endpoints:{setRole:u("/admin/set-role",{method:"POST",body:T.object({userId:T.string({description:"The user id"}),role:T.string({description:"The role to set. `admin` or `user` by default"})}),use:[i],metadata:{openapi:{operationId:"setRole",summary:"Set the role of a user",description:"Set the role of a user",responses:{200:{description:"User role updated",content:{"application/json":{schema:{type:"object",properties:{user:{$ref:"#/components/schemas/User"}}}}}}}}}},async t=>{let n=await t.context.internalAdapter.updateUser(t.body.userId,{role:t.body.role});return t.json({user:n})}),createUser:u("/admin/create-user",{method:"POST",body:T.object({email:T.string({description:"The email of the user"}),password:T.string({description:"The password of the user"}),name:T.string({description:"The name of the user"}),role:T.string({description:"The role of the user"}),data:T.optional(T.record(T.any(),{description:"Extra fields for the user. Including custom additional fields."}))}),use:[i],metadata:{openapi:{operationId:"createUser",summary:"Create a new user",description:"Create a new user",responses:{200:{description:"User created",content:{"application/json":{schema:{type:"object",properties:{user:{$ref:"#/components/schemas/User"}}}}}}}}}},async t=>{if(await t.context.internalAdapter.findUserByEmail(t.body.email))throw new m("BAD_REQUEST",{message:r.USER_ALREADY_EXISTS});let s=await t.context.internalAdapter.createUser({email:t.body.email,name:t.body.name,role:t.body.role,...t.body.data});if(!s)throw new m("INTERNAL_SERVER_ERROR",{message:r.FAILED_TO_CREATE_USER});let a=await t.context.password.hash(t.body.password);return await t.context.internalAdapter.linkAccount({accountId:s.id,providerId:"credential",password:a,userId:s.id}),t.json({user:s})}),listUsers:u("/admin/list-users",{method:"GET",use:[i],query:T.object({searchValue:T.string({description:"The value to search for"}).optional(),searchField:T.enum(["email","name"],{description:"The field to search in, defaults to email. Can be `email` or `name`"}).optional(),searchOperator:T.enum(["contains","starts_with","ends_with"],{description:"The operator to use for the search. Can be `contains`, `starts_with` or `ends_with`"}).optional(),limit:T.string({description:"The number of users to return"}).or(T.number()).optional(),offset:T.string({description:"The offset to start from"}).or(T.number()).optional(),sortBy:T.string({description:"The field to sort by"}).optional(),sortDirection:T.enum(["asc","desc"],{description:"The direction to sort by"}).optional(),filterField:T.string({description:"The field to filter by"}).optional(),filterValue:T.string({description:"The value to filter by"}).or(T.number()).or(T.boolean()).optional(),filterOperator:T.enum(["eq","ne","lt","lte","gt","gte"],{description:"The operator to use for the filter"}).optional()}),metadata:{openapi:{operationId:"listUsers",summary:"List users",description:"List users",responses:{200:{description:"List of users",content:{"application/json":{schema:{type:"object",properties:{users:{type:"array",items:{$ref:"#/components/schemas/User"}}}}}}}}}}},async t=>{let n=[];t.query?.searchValue&&n.push({field:t.query.searchField||"email",operator:t.query.searchOperator||"contains",value:t.query.searchValue}),t.query?.filterValue&&n.push({field:t.query.filterField||"email",operator:t.query.filterOperator||"eq",value:t.query.filterValue});try{let s=await t.context.internalAdapter.listUsers(Number(t.query?.limit)||void 0,Number(t.query?.offset)||void 0,t.query?.sortBy?{field:t.query.sortBy,direction:t.query.sortDirection||"asc"}:void 0,n.length?n:void 0);return t.json({users:s})}catch(s){return console.log(s),t.json({users:[]})}}),listUserSessions:u("/admin/list-user-sessions",{method:"POST",use:[i],body:T.object({userId:T.string({description:"The user id"})}),metadata:{openapi:{operationId:"listUserSessions",summary:"List user sessions",description:"List user sessions",responses:{200:{description:"List of user sessions",content:{"application/json":{schema:{type:"object",properties:{sessions:{type:"array",items:{$ref:"#/components/schemas/Session"}}}}}}}}}}},async t=>({sessions:await t.context.internalAdapter.listSessions(t.body.userId)})),unbanUser:u("/admin/unban-user",{method:"POST",body:T.object({userId:T.string({description:"The user id"})}),use:[i],metadata:{openapi:{operationId:"unbanUser",summary:"Unban a user",description:"Unban a user",responses:{200:{description:"User unbanned",content:{"application/json":{schema:{type:"object",properties:{user:{$ref:"#/components/schemas/User"}}}}}}}}}},async t=>{let n=await t.context.internalAdapter.updateUser(t.body.userId,{banned:!1});return t.json({user:n})}),banUser:u("/admin/ban-user",{method:"POST",body:T.object({userId:T.string({description:"The user id"}),banReason:T.string({description:"The reason for the ban"}).optional(),banExpiresIn:T.number({description:"The number of seconds until the ban expires"}).optional()}),use:[i],metadata:{openapi:{operationId:"banUser",summary:"Ban a user",description:"Ban a user",responses:{200:{description:"User banned",content:{"application/json":{schema:{type:"object",properties:{user:{$ref:"#/components/schemas/User"}}}}}}}}}},async t=>{if(t.body.userId===t.context.session.user.id)throw new m("BAD_REQUEST",{message:r.YOU_CANNOT_BAN_YOURSELF});let n=await t.context.internalAdapter.updateUser(t.body.userId,{banned:!0,banReason:t.body.banReason||e?.defaultBanReason||"No reason",banExpires:t.body.banExpiresIn?x(t.body.banExpiresIn,"sec"):e?.defaultBanExpiresIn?x(e.defaultBanExpiresIn,"sec"):void 0});return await t.context.internalAdapter.deleteSessions(t.body.userId),t.json({user:n})}),impersonateUser:u("/admin/impersonate-user",{method:"POST",body:T.object({userId:T.string({description:"The user id"})}),use:[i],metadata:{openapi:{operationId:"impersonateUser",summary:"Impersonate a user",description:"Impersonate a user",responses:{200:{description:"Impersonation session created",content:{"application/json":{schema:{type:"object",properties:{session:{$ref:"#/components/schemas/Session"},user:{$ref:"#/components/schemas/User"}}}}}}}}}},async t=>{let n=await t.context.internalAdapter.findUserById(t.body.userId);if(!n)throw new m("NOT_FOUND",{message:"User not found"});let s=await t.context.internalAdapter.createSession(n.id,void 0,!0,{impersonatedBy:t.context.session.user.id,expiresAt:e?.impersonationSessionDuration?x(e.impersonationSessionDuration,"sec"):x(60*60,"sec")});if(!s)throw new m("INTERNAL_SERVER_ERROR",{message:r.FAILED_TO_CREATE_USER});let a=t.context.authCookies;return G(t),await t.setSignedCookie("admin_session",t.context.session.session.token,t.context.secret,a.sessionToken.options),await O(t,{session:s,user:n},!0),t.json({session:s,user:n})}),stopImpersonating:u("/admin/stop-impersonating",{method:"POST"},async t=>{let n=await U(t);if(!n)throw new m("UNAUTHORIZED");if(!n.session.impersonatedBy)throw new m("BAD_REQUEST",{message:"You are not impersonating anyone"});let s=await t.context.internalAdapter.findUserById(n.session.impersonatedBy);if(!s)throw new m("INTERNAL_SERVER_ERROR",{message:"Failed to find user"});let a=await t.getSignedCookie("admin_session",t.context.secret);if(!a)throw new m("INTERNAL_SERVER_ERROR",{message:"Failed to find admin session"});let d=await t.context.internalAdapter.findSession(a);if(!d||d.session.userId!==s.id)throw new m("INTERNAL_SERVER_ERROR",{message:"Failed to find admin session"});return await O(t,d),t.json(d)}),revokeUserSession:u("/admin/revoke-user-session",{method:"POST",body:T.object({sessionToken:T.string({description:"The session token"})}),use:[i],metadata:{openapi:{operationId:"revokeUserSession",summary:"Revoke a user session",description:"Revoke a user session",responses:{200:{description:"Session revoked",content:{"application/json":{schema:{type:"object",properties:{success:{type:"boolean"}}}}}}}}}},async t=>(await t.context.internalAdapter.deleteSession(t.body.sessionToken),t.json({success:!0}))),revokeUserSessions:u("/admin/revoke-user-sessions",{method:"POST",body:T.object({userId:T.string({description:"The user id"})}),use:[i],metadata:{openapi:{operationId:"revokeUserSessions",summary:"Revoke all user sessions",description:"Revoke all user sessions",responses:{200:{description:"Sessions revoked",content:{"application/json":{schema:{type:"object",properties:{success:{type:"boolean"}}}}}}}}}},async t=>(await t.context.internalAdapter.deleteSessions(t.body.userId),t.json({success:!0}))),removeUser:u("/admin/remove-user",{method:"POST",body:T.object({userId:T.string({description:"The user id"})}),use:[i],metadata:{openapi:{operationId:"removeUser",summary:"Remove a user",description:"Delete a user and all their sessions and accounts. Cannot be undone.",responses:{200:{description:"User removed",content:{"application/json":{schema:{type:"object",properties:{success:{type:"boolean"}}}}}}}}}},async t=>(await t.context.internalAdapter.deleteUser(t.body.userId),t.json({success:!0})))},$ERROR_CODES:r,schema:he(vn,o.schema)}},vn={user:{fields:{role:{type:"string",required:!1,input:!1},banned:{type:"boolean",defaultValue:!1,required:!1,input:!1},banReason:{type:"string",required:!1,input:!1},banExpires:{type:"date",required:!1,input:!1}}},session:{fields:{impersonatedBy:{type:"string",required:!1}}}};import{APIError as Ve}from"better-call";import{z as pe}from"zod";import{decodeJwt as Sn}from"jose";async function kt(e,o){if(e.idToken){let i=Sn(e.idToken);if(i&&i.sub&&i.email)return{id:i.sub,emailVerified:i.email_verified,image:i.picture,...i}}if(!o)return null;let r=await R(o,{method:"GET",headers:{Authorization:`Bearer ${e.accessToken}`}});return{id:r.data?.sub,emailVerified:r.data?.email_verified,email:r.data?.email,image:r.data?.picture,name:r.data?.name,...r.data}}var nm=e=>{let o={INVALID_OAUTH_CONFIGURATION:"Invalid OAuth configuration"};return{id:"generic-oauth",init:r=>({context:{socialProviders:e.config.map(t=>{let n=t.userInfoUrl;return{id:t.providerId,name:t.providerId,createAuthorizationURL(s){return j({id:t.providerId,options:{clientId:t.clientId,clientSecret:t.clientSecret,redirectURI:t.redirectURI},authorizationEndpoint:t.authorizationUrl,state:s.state,codeVerifier:t.pkce?s.codeVerifier:void 0,scopes:t.scopes||[],redirectURI:`${r.baseURL}/oauth2/callback/${t.providerId}`})},async validateAuthorizationCode(s){let a=t.tokenUrl;if(t.discoveryUrl){let d=await R(t.discoveryUrl,{method:"GET"});d.data&&(a=d.data.token_endpoint,n=d.data.userinfo_endpoint)}if(!a)throw new Ve("BAD_REQUEST",{message:"Invalid OAuth configuration. Token URL not found."});return v({code:s.code,codeVerifier:s.codeVerifier,redirectURI:s.redirectURI,options:{clientId:t.clientId,clientSecret:t.clientSecret},tokenEndpoint:a})},async getUserInfo(s){if(!n)return null;let a=t.getUserInfo?await t.getUserInfo(s):await kt(s,n);return a?{user:{id:a?.id,email:a?.email,emailVerified:a?.emailVerified,image:a?.image,name:a?.name,...t.mapProfileToUser?.(a)},data:a}:null}}}).concat(r.socialProviders)}}),endpoints:{signInWithOAuth2:u("/sign-in/oauth2",{method:"POST",query:pe.object({currentURL:pe.string({description:"Redirect to the current URL after sign in"}).optional()}).optional(),body:pe.object({providerId:pe.string({description:"The provider ID for the OAuth provider"}),callbackURL:pe.string({description:"The URL to redirect to after sign in"}).optional(),errorCallbackURL:pe.string({description:"The URL to redirect to if an error occurs"}).optional(),disableRedirect:pe.boolean({description:"Disable redirect"}).optional()}),metadata:{openapi:{description:"Sign in with OAuth2",responses:{200:{description:"Sign in with OAuth2",content:{"application/json":{schema:{type:"object",properties:{url:{type:"string"},redirect:{type:"boolean"}}}}}}}}}},async r=>{let{providerId:i}=r.body,t=e.config.find(w=>w.providerId===i);if(!t)throw new Ve("BAD_REQUEST",{message:`No config found for provider ${i}`});let{discoveryUrl:n,authorizationUrl:s,tokenUrl:a,clientId:d,clientSecret:A,scopes:c,redirectURI:K,responseType:l,pkce:p,prompt:y,accessType:h,authorizationUrlParams:S}=t,D=s,B=a;if(n){let w=await R(n,{onError(te){r.context.logger.error(te.error.message,te.error,{discoveryUrl:n})}});w.data&&(D=w.data.authorization_endpoint,B=w.data.token_endpoint)}if(!D||!B)throw new Ve("BAD_REQUEST",{message:o.INVALID_OAUTH_CONFIGURATION});if(S){let w=new URL(D);for(let[te,qe]of Object.entries(S))w.searchParams.set(te,qe);D=w.toString()}let{state:g,codeVerifier:C}=await Pe(r),k=await j({id:i,options:{clientId:d,clientSecret:A,redirectURI:K},authorizationEndpoint:D,state:g,codeVerifier:p?C:void 0,scopes:c||[],redirectURI:`${r.context.baseURL}/oauth2/callback/${i}`});return l&&l!=="code"&&k.searchParams.set("response_type",l),y&&k.searchParams.set("prompt",y),h&&k.searchParams.set("access_type",h),r.json({url:k.toString(),redirect:!r.body.disableRedirect})}),oAuth2Callback:u("/oauth2/callback/:providerId",{method:"GET",query:pe.object({code:pe.string({description:"The OAuth2 code"}).optional(),error:pe.string({description:"The error message, if any"}).optional(),state:pe.string({description:"The state parameter from the OAuth2 request"}).optional()}),metadata:{openapi:{description:"OAuth2 callback",responses:{200:{description:"OAuth2 callback",content:{"application/json":{schema:{type:"object",properties:{url:{type:"string"}}}}}}}}}},async r=>{if(r.query.error||!r.query.code)throw r.redirect(`${r.context.options.baseURL}?error=${r.query.error||"oAuth_code_missing"}`);let i=e.config.find(g=>g.providerId===r.params.providerId);if(!i)throw new Ve("BAD_REQUEST",{message:`No config found for provider ${r.params.providerId}`});let t,n=await Ao(r),{callbackURL:s,codeVerifier:a,errorURL:d}=n,A=r.query.code,c=i.tokenUrl,K=i.userInfoUrl;if(i.discoveryUrl){let g=await R(i.discoveryUrl,{method:"GET"});g.data&&(c=g.data.token_endpoint,K=g.data.userinfo_endpoint)}try{if(!c)throw new Ve("BAD_REQUEST",{message:"Invalid OAuth configuration."});t=await v({code:A,codeVerifier:a,redirectURI:`${r.context.baseURL}/oauth2/callback/${i.providerId}`,options:{clientId:i.clientId,clientSecret:i.clientSecret},tokenEndpoint:c})}catch(g){throw r.context.logger.error(g&&typeof g=="object"&&"name"in g?g.name:"",g),r.redirect(`${d}?error=oauth_code_verification_failed`)}if(!t)throw new Ve("BAD_REQUEST",{message:"Invalid OAuth configuration."});let l=i.getUserInfo?await i.getUserInfo(t):await kt(t,K);if(!l?.email)throw r.context.logger.error("Unable to get user info",l),r.redirect(`${r.context.baseURL}/error?error=email_is_missing`);let p=i.mapProfileToUser?await i.mapProfileToUser(l):null,y=await je(r,{userInfo:{...l,...p},account:{providerId:i.providerId,accountId:l.id,...t,scope:t.scopes?.join(",")}});function h(g){throw r.redirect(`${d||s||`${r.context.baseURL}/error`}?error=${g}`)}if(y.error)return h(y.error.split(" ").join("_"));let{session:S,user:D}=y.data;await O(r,{session:S,user:D});let B;try{B=new URL(s).toString()}catch{B=s}throw r.redirect(B)})},$ERROR_CODES:o}};import{z as eo}from"zod";var Pt={jwks:{fields:{publicKey:{type:"string",required:!0},privateKey:{type:"string",required:!0},createdAt:{type:"date",required:!0}}}},dm=eo.object({id:eo.string(),publicKey:eo.string(),privateKey:eo.string(),createdAt:eo.date()});var Fo=e=>({getAllKeys:async()=>await e.findMany({model:"jwks"}),getLatestKey:async()=>(await e.findMany({model:"jwks",sortBy:{field:"createdAt",direction:"desc"},limit:1}))[0],createJwk:async o=>await e.create({model:"jwks",data:{...o,createdAt:new Date}})});import{exportJWK as yo,generateKeyPair as Dt,importJWK as kn,SignJWT as Pn}from"jose";var fm=e=>({id:"jwt",endpoints:{getJwks:u("/jwks",{method:"GET",metadata:{openapi:{description:"Get the JSON Web Key Set",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{keys:{type:"array",items:{type:"object",properties:{kid:{type:"string"},kty:{type:"string"},use:{type:"string"},alg:{type:"string"},n:{type:"string"},e:{type:"string"}}}}}}}}}}}}},async o=>{let r=Fo(o.context.adapter),i=await r.getAllKeys();if(i.length===0){let{publicKey:t,privateKey:n}=await Dt(e?.jwks?.keyPairConfig?.alg??"EdDSA",e?.jwks?.keyPairConfig??{crv:"Ed25519",extractable:!0}),s=await yo(t),a=await yo(n),d=JSON.stringify(a),A=!e?.jwks?.disablePrivateKeyEncryption,c={id:o.context.generateId({model:"jwks"}),publicKey:JSON.stringify(s),privateKey:A?JSON.stringify(await Ke({key:o.context.options.secret,data:d})):d,createdAt:new Date};return await r.createJwk(c),o.json({keys:[{...s,kid:c.id}]})}return o.json({keys:i.map(t=>({...JSON.parse(t.publicKey),kid:t.id}))})}),getToken:u("/token",{method:"GET",requireHeaders:!0,use:[I],metadata:{openapi:{description:"Get a JWT token",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{token:{type:"string"}}}}}}}}}},async o=>{let r=Fo(o.context.adapter),i=await r.getLatestKey(),t=!e?.jwks?.disablePrivateKeyEncryption;if(i===void 0){let{publicKey:A,privateKey:c}=await Dt(e?.jwks?.keyPairConfig?.alg??"EdDSA",e?.jwks?.keyPairConfig??{crv:"Ed25519",extractable:!0}),K=await yo(A),l=await yo(c),p=JSON.stringify(l),y={id:o.context.generateId({model:"jwks"}),publicKey:JSON.stringify(K),privateKey:t?JSON.stringify(await Ke({key:o.context.options.secret,data:p})):p,createdAt:new Date};i=await r.createJwk(y)}let n=t?await we({key:o.context.options.secret,data:JSON.parse(i.privateKey)}):i.privateKey,s=await kn(JSON.parse(n),e?.jwks?.keyPairConfig?.alg??"EdDSA"),a=e?.jwt?.definePayload?await e?.jwt.definePayload(o.context.session):o.context.session.user,d=await new Pn({...a,...o.context.session.session.impersonatedBy?{impersonatedBy:o.context.session.session.impersonatedBy}:{}}).setProtectedHeader({alg:e?.jwks?.keyPairConfig?.alg??"EdDSA",kid:i.id}).setIssuedAt().setIssuer(e?.jwt?.issuer??o.context.options.baseURL).setAudience(e?.jwt?.audience??o.context.options.baseURL).setExpirationTime(e?.jwt?.expirationTime??"15m").setSubject(o.context.session.user.id).sign(s);return o.json({token:d})})},schema:he(Pt,e?.schema)});import{z as wo}from"zod";var bm=e=>{let o={maximumSessions:5,...e},r=t=>t.includes("_multi-"),i={INVALID_SESSION_TOKEN:"Invalid session token"};return{id:"multi-session",endpoints:{listDeviceSessions:u("/multi-session/list-device-sessions",{method:"GET",requireHeaders:!0},async t=>{let n=t.headers?.get("cookie");if(!n)return t.json([]);let s=Object.fromEntries(Ze(n)),a=(await Promise.all(Object.entries(s).filter(([c])=>r(c)).map(async([c])=>await t.getSignedCookie(c,t.context.secret)))).filter(c=>c!==void 0);if(!a.length)return t.json([]);let A=(await t.context.internalAdapter.findSessions(a)).filter(c=>c&&c.session.expiresAt>new Date);return t.json(A)}),setActiveSession:u("/multi-session/set-active",{method:"POST",body:wo.object({sessionToken:wo.string({description:"The session token to set as active"})}),requireHeaders:!0,use:[I],metadata:{openapi:{description:"Set the active session",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{session:{$ref:"#/components/schemas/Session"}}}}}}}}}},async t=>{let n=t.body.sessionToken,s=`${t.context.authCookies.sessionToken.name}_multi-${n}`;if(!await t.getSignedCookie(s,t.context.secret))throw new m("UNAUTHORIZED",{message:i.INVALID_SESSION_TOKEN});let d=await t.context.internalAdapter.findSession(n);if(!d||d.session.expiresAt<new Date)throw t.setCookie(s,"",{...t.context.authCookies.sessionToken.options,maxAge:0}),new m("UNAUTHORIZED",{message:i.INVALID_SESSION_TOKEN});return await O(t,d),t.json(d)}),revokeDeviceSession:u("/multi-session/revoke",{method:"POST",body:wo.object({sessionToken:wo.string({description:"The session token to revoke"})}),requireHeaders:!0,use:[I],metadata:{openapi:{description:"Revoke a device session",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"}}}}}}}}}},async t=>{let n=t.body.sessionToken,s=`${t.context.authCookies.sessionToken.name}_multi-${n}`;if(!await t.getSignedCookie(s,t.context.secret))throw new m("UNAUTHORIZED",{message:i.INVALID_SESSION_TOKEN});if(await t.context.internalAdapter.deleteSession(n),t.setCookie(s,"",{...t.context.authCookies.sessionToken.options,maxAge:0}),!(t.context.session?.session.token===n))return t.json({status:!0});let A=t.headers?.get("cookie");if(A){let c=Object.fromEntries(Ze(A)),K=(await Promise.all(Object.entries(c).filter(([p])=>r(p)).map(async([p])=>await t.getSignedCookie(p,t.context.secret)))).filter(p=>p!==void 0),l=t.context.internalAdapter;if(K.length>0){let y=(await l.findSessions(K)).filter(h=>h&&h.session.expiresAt>new Date);if(y.length>0){let h=y[0];await O(t,h)}else G(t)}else G(t)}else G(t);return t.json({status:!0})})},hooks:{after:[{matcher:()=>!0,handler:L(async t=>{let n=t.responseHeader.get("set-cookie");if(!n)return;let s=Ee(n),a=t.context.authCookies.sessionToken,d=s.get(a.name)?.value;if(!d)return;let A=Ze(t.headers?.get("cookie")||""),c=d.split(".")[0];if(!c)return;let K=`${a.name}_multi-${c}`;s.get(K)||A.get(K)||Object.keys(Object.fromEntries(A)).filter(r).length+(n.includes("session_token")?1:0)>o.maximumSessions||await t.setSignedCookie(K,c,t.context.secret,a.options)})},{matcher:t=>t.path==="/sign-out",handler:L(async t=>{let n=t.headers?.get("cookie");if(!n)return;let s=Object.fromEntries(Ze(n)),a=Object.keys(s).map(d=>r(d)?(t.setCookie(d,"",{maxAge:0}),d.split("_multi-")[1]):null).filter(d=>d!==null);await t.context.internalAdapter.deleteSessions(a)})}]},$ERROR_CODES:i}};import{z as q}from"zod";var Vo=["email-verification","sign-in","forget-password"],Um=e=>{let o={expiresIn:300,otpLength:6,...e},r={OTP_EXPIRED:"otp expired",INVALID_OTP:"invalid otp",INVALID_EMAIL:"invalid email",USER_NOT_FOUND:"user not found"};return{id:"email-otp",endpoints:{sendVerificationOTP:u("/email-otp/send-verification-otp",{method:"POST",body:q.object({email:q.string({description:"Email address to send the OTP"}),type:q.enum(Vo,{description:"Type of the OTP"})}),metadata:{openapi:{description:"Send verification OTP",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{success:{type:"boolean"}}}}}}}}}},async i=>{if(!e?.sendVerificationOTP)throw i.context.logger.error("send email verification is not implemented"),new m("BAD_REQUEST",{message:"send email verification is not implemented"});let t=i.body.email;if(!/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(t))throw new m("BAD_REQUEST",{message:r.INVALID_EMAIL});if((i.body.type==="forget-password"||o.disableSignUp)&&!await i.context.internalAdapter.findUserByEmail(t))return i.json({success:!0});let s=_(o.otpLength,"0-9");return await i.context.internalAdapter.createVerificationValue({value:s,identifier:`${i.body.type}-otp-${t}`,expiresAt:x(o.expiresIn,"sec")}).catch(async a=>{await i.context.internalAdapter.deleteVerificationByIdentifier(`${i.body.type}-otp-${t}`),await i.context.internalAdapter.createVerificationValue({value:s,identifier:`${i.body.type}-otp-${t}`,expiresAt:x(o.expiresIn,"sec")})}),await e.sendVerificationOTP({email:t,otp:s,type:i.body.type},i.request),i.json({success:!0})}),createVerificationOTP:u("/email-otp/create-verification-otp",{method:"POST",body:q.object({email:q.string({description:"Email address to send the OTP"}),type:q.enum(Vo,{description:"Type of the OTP"})}),metadata:{SERVER_ONLY:!0,openapi:{description:"Create verification OTP",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"string"}}}}}}}},async i=>{let t=i.body.email,n=_(o.otpLength,"0-9");return await i.context.internalAdapter.createVerificationValue({value:n,identifier:`${i.body.type}-otp-${t}`,expiresAt:x(o.expiresIn,"sec")}),n}),getVerificationOTP:u("/email-otp/get-verification-otp",{method:"GET",query:q.object({email:q.string({description:"Email address to get the OTP"}),type:q.enum(Vo)}),metadata:{SERVER_ONLY:!0,openapi:{description:"Get verification OTP",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{otp:{type:"string"}}}}}}}}}},async i=>{let t=i.query.email,n=await i.context.internalAdapter.findVerificationValue(`${i.query.type}-otp-${t}`);return!n||n.expiresAt<new Date?i.json({otp:null}):i.json({otp:n.value})}),verifyEmailOTP:u("/email-otp/verify-email",{method:"POST",body:q.object({email:q.string({description:"Email address to verify"}),otp:q.string({description:"OTP to verify"})}),metadata:{openapi:{description:"Verify email OTP",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{user:{$ref:"#/components/schemas/User"}}}}}}}}}},async i=>{let t=i.body.email;if(!/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(t))throw new m("BAD_REQUEST",{message:r.INVALID_EMAIL});let s=await i.context.internalAdapter.findVerificationValue(`email-verification-otp-${t}`);if(!s)throw new m("BAD_REQUEST",{message:r.INVALID_OTP});if(s.expiresAt<new Date)throw await i.context.internalAdapter.deleteVerificationValue(s.id),new m("BAD_REQUEST",{message:r.OTP_EXPIRED});let a=i.body.otp;if(s.value!==a)throw new m("BAD_REQUEST",{message:r.INVALID_OTP});await i.context.internalAdapter.deleteVerificationValue(s.id);let d=await i.context.internalAdapter.findUserByEmail(t);if(!d)throw new m("BAD_REQUEST",{message:r.USER_NOT_FOUND});let A=await i.context.internalAdapter.updateUser(d.user.id,{email:t,emailVerified:!0});if(i.context.options.emailVerification?.autoSignInAfterVerification){let c=await i.context.internalAdapter.createSession(A.id,i.request);return await O(i,{session:c,user:A}),i.json({status:!0,token:c.token,user:{id:A.id,email:A.email,emailVerified:A.emailVerified,name:A.name,image:A.image,createdAt:A.createdAt,updatedAt:A.updatedAt}})}return i.json({status:!0,token:null,user:{id:A.id,email:A.email,emailVerified:A.emailVerified,name:A.name,image:A.image,createdAt:A.createdAt,updatedAt:A.updatedAt}})}),signInEmailOTP:u("/sign-in/email-otp",{method:"POST",body:q.object({email:q.string({description:"Email address to sign in"}),otp:q.string({description:"OTP sent to the email"})}),metadata:{openapi:{description:"Sign in with email OTP",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{user:{$ref:"#/components/schemas/User"},session:{$ref:"#/components/schemas/Session"}}}}}}}}}},async i=>{let t=i.body.email,n=await i.context.internalAdapter.findVerificationValue(`sign-in-otp-${t}`);if(!n)throw new m("BAD_REQUEST",{message:r.INVALID_OTP});if(n.expiresAt<new Date)throw await i.context.internalAdapter.deleteVerificationValue(n.id),new m("BAD_REQUEST",{message:r.OTP_EXPIRED});let s=i.body.otp;if(n.value!==s)throw new m("BAD_REQUEST",{message:r.INVALID_OTP});await i.context.internalAdapter.deleteVerificationValue(n.id);let a=await i.context.internalAdapter.findUserByEmail(t);if(!a){if(o.disableSignUp)throw new m("BAD_REQUEST",{message:r.USER_NOT_FOUND});let A=await i.context.internalAdapter.createUser({email:t,emailVerified:!0,name:t}),c=await i.context.internalAdapter.createSession(A.id,i.request);return await O(i,{session:c,user:A}),i.json({token:c.token,user:{id:A.id,email:A.email,emailVerified:A.emailVerified,name:A.name,image:A.image,createdAt:A.createdAt,updatedAt:A.updatedAt}})}a.user.emailVerified||await i.context.internalAdapter.updateUser(a.user.id,{emailVerified:!0});let d=await i.context.internalAdapter.createSession(a.user.id,i.request);return await O(i,{session:d,user:a.user}),i.json({token:d.token,user:{id:a.user.id,email:a.user.email,emailVerified:a.user.emailVerified,name:a.user.name,image:a.user.image,createdAt:a.user.createdAt,updatedAt:a.user.updatedAt}})}),forgetPasswordEmailOTP:u("/forget-password/email-otp",{method:"POST",body:q.object({email:q.string({description:"Email address to send the OTP"})}),metadata:{openapi:{description:"Forget password with email OTP",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{success:{type:"boolean"}}}}}}}}}},async i=>{let t=i.body.email;if(!await i.context.internalAdapter.findUserByEmail(t))throw new m("BAD_REQUEST",{message:r.USER_NOT_FOUND});let s=_(o.otpLength,"0-9");return await i.context.internalAdapter.createVerificationValue({value:s,identifier:`forget-password-otp-${t}`,expiresAt:x(o.expiresIn,"sec")}),await e.sendVerificationOTP({email:t,otp:s,type:"forget-password"},i.request),i.json({success:!0})}),resetPasswordEmailOTP:u("/email-otp/reset-password",{method:"POST",body:q.object({email:q.string({description:"Email address to reset the password"}),otp:q.string({description:"OTP sent to the email"}),password:q.string({description:"New password"})}),metadata:{openapi:{description:"Reset password with email OTP",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{success:{type:"boolean"}}}}}}}}}},async i=>{let t=i.body.email,n=await i.context.internalAdapter.findUserByEmail(t,{includeAccounts:!0});if(!n)throw new m("BAD_REQUEST",{message:r.USER_NOT_FOUND});let s=await i.context.internalAdapter.findVerificationValue(`forget-password-otp-${t}`);if(!s)throw new m("BAD_REQUEST",{message:r.INVALID_OTP});if(s.expiresAt<new Date)throw await i.context.internalAdapter.deleteVerificationValue(s.id),new m("BAD_REQUEST",{message:r.OTP_EXPIRED});let a=i.body.otp;if(s.value!==a)throw new m("BAD_REQUEST",{message:r.INVALID_OTP});await i.context.internalAdapter.deleteVerificationValue(s.id);let d=await i.context.password.hash(i.body.password);return n.accounts.find(c=>c.providerId==="credential")?await i.context.internalAdapter.updatePassword(n.user.id,d):await i.context.internalAdapter.createAccount({userId:n.user.id,providerId:"credential",accountId:n.user.id,password:d}),i.json({success:!0})})},hooks:{after:[{matcher(i){return!!(i.path?.startsWith("/sign-up")&&o.sendVerificationOnSignUp)},async handler(i){let t=i.context.returned;if(t instanceof m)return;let n=t&&"email"in t?t.email:t instanceof Response&&t.status===200?i.body.email:null;if(n){let s=_(o.otpLength,"0-9");await i.context.internalAdapter.createVerificationValue({value:s,identifier:`email-verification-otp-${n}`,expiresAt:x(o.expiresIn,"sec")}),await e.sendVerificationOTP({email:n,otp:s,type:"email-verification"},i.request)}}}]},$ERROR_CODES:r,rateLimit:[{pathMatcher(i){return i==="/email-otp/send-verification-otp"},window:60,max:3},{pathMatcher(i){return i==="/email-otp/verify-email"},window:60,max:3},{pathMatcher(i){return i==="/sign-in/email-otp"},window:60,max:3}]}};import{z as Lt}from"zod";function Nt(e){return e==="true"||e===!0}var jm=e=>({id:"one-tap",endpoints:{oneTapCallback:u("/one-tap/callback",{method:"POST",body:Lt.object({idToken:Lt.string({description:"Google ID token, which the client obtains from the One Tap API"})}),metadata:{openapi:{summary:"One tap callback",description:"Use this endpoint to authenticate with Google One Tap",responses:{200:{description:"Successful response",content:{"application/json":{schema:{type:"object",properties:{session:{$ref:"#/components/schemas/Session"},user:{$ref:"#/components/schemas/User"}}}}}},400:{description:"Invalid token"}}}}},async o=>{let{idToken:r}=o.body,{data:i,error:t}=await R("https://oauth2.googleapis.com/tokeninfo?id_token="+r);if(t)return o.json({error:"Invalid token"});let n=await o.context.internalAdapter.findUserByEmail(i.email);if(!n){if(e?.disableSignup)throw new m("BAD_GATEWAY",{message:"User not found"});let a=await o.context.internalAdapter.createOAuthUser({email:i.email,emailVerified:Nt(i.email_verified),name:i.name,image:i.picture},{providerId:"google",accountId:i.sub});if(!a)throw new m("INTERNAL_SERVER_ERROR",{message:"Could not create user"});let d=await o.context.internalAdapter.createSession(a?.user.id,o.request);return await O(o,{user:a.user,session:d}),o.json({token:d.token,user:{id:a.user.id,email:a.user.email,emailVerified:a.user.emailVerified,name:a.user.name,image:a.user.image,createdAt:a.user.createdAt,updatedAt:a.user.updatedAt}})}let s=await o.context.internalAdapter.createSession(n.user.id,o.request);return await O(o,{user:n.user,session:s}),o.json({token:s.token,user:{id:n.user.id,email:n.user.email,emailVerified:n.user.emailVerified,name:n.user.name,image:n.user.image,createdAt:n.user.createdAt,updatedAt:n.user.updatedAt}})})}});import{z as Mo}from"zod";function Dn(){let e=ye.VERCEL_URL,o=ye.NETLIFY_URL,r=ye.RENDER_URL,i=ye.AWS_LAMBDA_FUNCTION_NAME,t=ye.GOOGLE_CLOUD_FUNCTION_NAME,n=ye.AZURE_FUNCTION_NAME;return e||o||r||i||t||n}var qm=e=>({id:"oauth-proxy",endpoints:{oAuthProxy:u("/oauth-proxy-callback",{method:"GET",query:Mo.object({callbackURL:Mo.string({description:"The URL to redirect to after the proxy"}),cookies:Mo.string({description:"The cookies to set after the proxy"})}),use:[ge(o=>o.query.callbackURL)],metadata:{openapi:{description:"OAuth Proxy Callback",parameters:[{in:"query",name:"callbackURL",required:!0,description:"The URL to redirect to after the proxy"},{in:"query",name:"cookies",required:!0,description:"The cookies to set after the proxy"}],responses:{302:{description:"Redirect",headers:{Location:{description:"The URL to redirect to",schema:{type:"string"}}}}}}}},async o=>{let r=o.query.cookies,i=await we({key:o.context.secret,data:r});throw o.setHeader("set-cookie",i),o.redirect(o.query.callbackURL)})},hooks:{after:[{matcher(o){return o.path?.startsWith("/callback")},handler:L(async o=>{let r=o.context.returned,i=r instanceof m?r.headers:null,t=i?.get("location");if(t?.includes("/oauth-proxy-callback?callbackURL")){if(!t.startsWith("http"))return;let n=new URL(t);if(n.origin===Re(o.context.baseURL)){let c=n.searchParams.get("callbackURL");if(!c)return;o.setHeader("location",c);return}let a=i?.get("set-cookie");if(!a)return;let d=await Ke({key:o.context.secret,data:a}),A=`${t}&cookies=${encodeURIComponent(d)}`;o.setHeader("location",A)}})}],before:[{matcher(o){return o.path?.startsWith("/sign-in/social")},async handler(o){let r=new URL(e?.currentURL||o.request?.url||Dn()||o.context.baseURL);return o.body.callbackURL=`${r.origin}${o.context.options.basePath||"/api/auth"}/oauth-proxy-callback?callbackURL=${encodeURIComponent(o.body.callbackURL||o.context.baseURL)}`,{context:o}}}]}});import{z as oo}from"zod";var Gm=(e,o)=>({id:"custom-session",endpoints:{getSession:u("/get-session",{method:"GET",metadata:{CUSTOM_SESSION:!0},query:oo.optional(oo.object({disableCookieCache:oo.boolean({description:"Disable cookie cache and fetch session from database"}).or(oo.string().transform(r=>r==="true")).optional(),disableRefresh:oo.boolean({description:"Disable session refresh. Useful for checking session status, without updating the session"}).optional()}))},async r=>{let i=await U(r);if(!i)return r.json(null);let t=await e(i);return r.json(t)})}});import{ZodObject as xt,ZodOptional as qo,ZodSchema as Bt}from"zod";var Me=e=>{let o=e.plugins?.reduce((d,A)=>{let c=A.schema;if(!c)return d;for(let[K,l]of Object.entries(c))d[K]={fields:{...d[K]?.fields,...l.fields},modelName:l.modelName||K};return d},{}),r=e.rateLimit?.storage==="database",i={rateLimit:{modelName:e.rateLimit?.modelName||"rateLimit",fields:{key:{type:"string",fieldName:e.rateLimit?.fields?.key||"key"},count:{type:"number",fieldName:e.rateLimit?.fields?.count||"count"},lastRequest:{type:"number",fieldName:e.rateLimit?.fields?.lastRequest||"lastRequest"}}}},{user:t,session:n,account:s,...a}=o||{};return{user:{modelName:e.user?.modelName||"user",fields:{name:{type:"string",required:!0,fieldName:e.user?.fields?.name||"name"},email:{type:"string",unique:!0,required:!0,fieldName:e.user?.fields?.email||"email"},emailVerified:{type:"boolean",defaultValue:()=>!1,required:!0,fieldName:e.user?.fields?.emailVerified||"emailVerified"},image:{type:"string",required:!1,fieldName:e.user?.fields?.image||"image"},createdAt:{type:"date",defaultValue:()=>new Date,required:!0,fieldName:e.user?.fields?.createdAt||"createdAt"},updatedAt:{type:"date",defaultValue:()=>new Date,required:!0,fieldName:e.user?.fields?.updatedAt||"updatedAt"},...t?.fields,...e.user?.additionalFields},order:1},session:{modelName:e.session?.modelName||"session",fields:{expiresAt:{type:"date",required:!0,fieldName:e.session?.fields?.expiresAt||"expiresAt"},token:{type:"string",required:!0,fieldName:e.session?.fields?.token||"token",unique:!0},createdAt:{type:"date",required:!0,fieldName:e.session?.fields?.createdAt||"createdAt"},updatedAt:{type:"date",required:!0,fieldName:e.session?.fields?.updatedAt||"updatedAt"},ipAddress:{type:"string",required:!1,fieldName:e.session?.fields?.ipAddress||"ipAddress"},userAgent:{type:"string",required:!1,fieldName:e.session?.fields?.userAgent||"userAgent"},userId:{type:"string",fieldName:e.session?.fields?.userId||"userId",references:{model:e.user?.modelName||"user",field:"id",onDelete:"cascade"},required:!0},...n?.fields,...e.session?.additionalFields},order:2},account:{modelName:e.account?.modelName||"account",fields:{accountId:{type:"string",required:!0,fieldName:e.account?.fields?.accountId||"accountId"},providerId:{type:"string",required:!0,fieldName:e.account?.fields?.providerId||"providerId"},userId:{type:"string",references:{model:e.user?.modelName||"user",field:"id",onDelete:"cascade"},required:!0,fieldName:e.account?.fields?.userId||"userId"},accessToken:{type:"string",required:!1,fieldName:e.account?.fields?.accessToken||"accessToken"},refreshToken:{type:"string",required:!1,fieldName:e.account?.fields?.refreshToken||"refreshToken"},idToken:{type:"string",required:!1,fieldName:e.account?.fields?.idToken||"idToken"},accessTokenExpiresAt:{type:"date",required:!1,fieldName:e.account?.fields?.accessTokenExpiresAt||"accessTokenExpiresAt"},refreshTokenExpiresAt:{type:"date",required:!1,fieldName:e.account?.fields?.accessTokenExpiresAt||"refreshTokenExpiresAt"},scope:{type:"string",required:!1,fieldName:e.account?.fields?.scope||"scope"},password:{type:"string",required:!1,fieldName:e.account?.fields?.password||"password"},createdAt:{type:"date",required:!0,fieldName:e.account?.fields?.createdAt||"createdAt"},updatedAt:{type:"date",required:!0,fieldName:e.account?.fields?.updatedAt||"updatedAt"},...s?.fields},order:3},verification:{modelName:e.verification?.modelName||"verification",fields:{identifier:{type:"string",required:!0,fieldName:e.verification?.fields?.identifier||"identifier"},value:{type:"string",required:!0,fieldName:e.verification?.fields?.value||"value"},expiresAt:{type:"date",required:!0,fieldName:e.verification?.fields?.expiresAt||"expiresAt"},createdAt:{type:"date",required:!1,defaultValue:()=>new Date,fieldName:e.verification?.fields?.createdAt||"createdAt"},updatedAt:{type:"date",required:!1,defaultValue:()=>new Date,fieldName:e.verification?.fields?.updatedAt||"updatedAt"}},order:4},...a,...r?i:{}}};import{z as ug}from"zod";import{Kysely as Kg,MssqlDialect as mg}from"kysely";import{MysqlDialect as fg,PostgresDialect as hg,SqliteDialect as yg}from"kysely";var io={};function zt(e){switch(e.constructor.name){case"ZodString":return"string";case"ZodNumber":return"number";case"ZodBoolean":return"boolean";case"ZodObject":return"object";case"ZodArray":return"array";default:return"string"}}function Co(e){let o=[];return e.metadata?.openapi?.parameters?(o.push(...e.metadata.openapi.parameters),o):(e.query instanceof xt&&Object.entries(e.query.shape).forEach(([r,i])=>{i instanceof Bt&&o.push({name:r,in:"query",schema:{type:zt(i),..."minLength"in i&&i.minLength?{minLength:i.minLength}:{},description:i.description}})}),o)}function jt(e){if(e.metadata?.openapi?.requestBody)return e.metadata.openapi.requestBody;if(e.body&&(e.body instanceof xt||e.body instanceof qo)){let o=e.body.shape;if(!o)return;let r={},i=[];return Object.entries(o).forEach(([t,n])=>{n instanceof Bt&&(r[t]={type:zt(n),description:n.description},n instanceof qo||i.push(t))}),{required:e.body instanceof qo?!1:!!e.body,content:{"application/json":{schema:{type:"object",properties:r,required:i}}}}}}function bo(e){return{400:{content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"}},required:["message"]}}},description:"Bad Request. Usually due to missing parameters, or invalid parameters."},401:{content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"}},required:["message"]}}},description:"Unauthorized. Due to missing or invalid authentication."},403:{content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"}}}}},description:"Forbidden. You do not have permission to access this resource or to perform this action."},404:{content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"}}}}},description:"Not Found. The requested resource was not found."},429:{content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"}}}}},description:"Too Many Requests. You have exceeded the rate limit. Try again later."},500:{content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"}}}}},description:"Internal Server Error. This is a problem with the server that you cannot fix."},...e}}async function Ho(e,o){let r=Do(e,{...o,plugins:[]}),i=Me(o),n={schemas:{...Object.entries(i).reduce((a,[d,A])=>{let c=d.charAt(0).toUpperCase()+d.slice(1);return a[c]={type:"object",properties:Object.entries(A.fields).reduce((K,[l,p])=>(K[l]={type:p.type},K),{})},a},{})}};Object.entries(r.api).forEach(([a,d])=>{let A=d.options;if(!A.metadata?.SERVER_ONLY&&(A.method==="GET"&&(io[d.path]={get:{tags:["Default",...A.metadata?.openapi?.tags||[]],description:A.metadata?.openapi?.description,operationId:A.metadata?.openapi?.operationId,security:[{bearerAuth:[]}],parameters:Co(A),responses:bo(A.metadata?.openapi?.responses)}}),A.method==="POST")){let c=jt(A);io[d.path]={post:{tags:["Default",...A.metadata?.openapi?.tags||[]],description:A.metadata?.openapi?.description,operationId:A.metadata?.openapi?.operationId,security:[{bearerAuth:[]}],parameters:Co(A),...c?{requestBody:c}:{requestBody:{content:{"application/json":{schema:{type:"object",properties:{}}}}}},responses:bo(A.metadata?.openapi?.responses)}}}});for(let a of o.plugins||[]){if(a.id==="open-api")continue;let d=Do(e,{...o,plugins:[a]}),A=Object.keys(d.api).map(c=>r.api[c]===void 0?d.api[c]:null).filter(c=>c!==null);Object.entries(A).forEach(([c,K])=>{let l=K.options;l.metadata?.SERVER_ONLY||(l.method==="GET"&&(io[K.path]={get:{tags:l.metadata?.openapi?.tags||[a.id.charAt(0).toUpperCase()+a.id.slice(1)],description:l.metadata?.openapi?.description,operationId:l.metadata?.openapi?.operationId,security:[{bearerAuth:[]}],parameters:Co(l),responses:bo(l.metadata?.openapi?.responses)}}),l.method==="POST"&&(io[K.path]={post:{tags:l.metadata?.openapi?.tags||[a.id.charAt(0).toUpperCase()+a.id.slice(1)],description:l.metadata?.openapi?.description,operationId:l.metadata?.openapi?.operationId,security:[{bearerAuth:[]}],parameters:Co(l),requestBody:jt(l),responses:bo(l.metadata?.openapi?.responses)}}))})}return{openapi:"3.1.1",info:{title:"Better Auth",description:"API Reference for your Better Auth Instance",version:"1.1.0"},components:n,security:[{apiKeyCookie:[]}],servers:[{url:e.baseURL}],tags:[{name:"Default",description:"Default endpoints that are included with Better Auth by default. These endpoints are not part of any plugin."}],paths:io}}var Ft=`<svg width="75" height="75" viewBox="0 0 75 75" fill="none" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<rect width="75" height="75" fill="url(#pattern0_21_12)"/>
<defs>
<pattern id="pattern0_21_12" patternContentUnits="objectBoundingBox" width="1" height="1">
<use xlink:href="#image0_21_12" transform="scale(0.00094697)"/>
</pattern>
<image id="image0_21_12" width="1056" height="1056" xlink:href="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAASABIAAD/4QBARXhpZgAATU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAEIKADAAQAAAABAAAEIAAAAAD/7QA4UGhvdG9zaG9wIDMuMAA4QklNBAQAAAAAAAA4QklNBCUAAAAAABDUHYzZjwCyBOmACZjs+EJ+/+ICKElDQ19QUk9GSUxFAAEBAAACGGFwcGwEAAAAbW50clJHQiBYWVogB+YAAQABAAAAAAAAYWNzcEFQUEwAAAAAQVBQTAAAAAAAAAAAAAAAAAAAAAAAAPbWAAEAAAAA0y1hcHBs7P2jjjiFR8NttL1PetoYLwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAKZGVzYwAAAPwAAAAwY3BydAAAASwAAABQd3RwdAAAAXwAAAAUclhZWgAAAZAAAAAUZ1hZWgAAAaQAAAAUYlhZWgAAAbgAAAAUclRSQwAAAcwAAAAgY2hhZAAAAewAAAAsYlRSQwAAAcwAAAAgZ1RSQwAAAcwAAAAgbWx1YwAAAAAAAAABAAAADGVuVVMAAAAUAAAAHABEAGkAcwBwAGwAYQB5ACAAUAAzbWx1YwAAAAAAAAABAAAADGVuVVMAAAA0AAAAHABDAG8AcAB5AHIAaQBnAGgAdAAgAEEAcABwAGwAZQAgAEkAbgBjAC4ALAAgADIAMAAyADJYWVogAAAAAAAA9tUAAQAAAADTLFhZWiAAAAAAAACD3wAAPb////+7WFlaIAAAAAAAAEq/AACxNwAACrlYWVogAAAAAAAAKDgAABELAADIuXBhcmEAAAAAAAMAAAACZmYAAPKnAAANWQAAE9AAAApbc2YzMgAAAAAAAQxCAAAF3v//8yYAAAeTAAD9kP//+6L///2jAAAD3AAAwG7/wAARCAQgBCADASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9sAQwACAgICAgIDAgIDBAMDAwQFBAQEBAUHBQUFBQUHCAcHBwcHBwgICAgICAgICgoKCgoKCwsLCwsNDQ0NDQ0NDQ0N/9sAQwECAgIDAwMGAwMGDQkHCQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0N/90ABABC/9oADAMBAAIRAxEAPwD9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//Q/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/0f38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9L9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//T/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/1P38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9X9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//W/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/1/38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9D9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//R/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/0v38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9P9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//U/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/1f38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9b9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//X/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/0P38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9H9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//S/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/0/38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9T9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//V/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/1v38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAK/Ln/gq38a/in8Dvgp4T8R/CfxFdeG9SvvFMdlcXFoELyW5srqQxnzEcY3op4Gciv1Gr8Z/+C2X/JvXgj/sc4v/AE33lAH4z/8ADwv9tD/oq2tf9823/wAZo/4eF/tof9FW1r/vm2/+M18Z0UAfZn/Dwv8AbQ/6KtrX/fNt/wDGaP8Ah4X+2h/0VbWv++bb/wCM18Z0UAfZn/Dwv9tD/oq2tf8AfNt/8Zo/4eF/tof9FW1r/vm2/wDjNfGdFAH2Z/w8L/bQ/wCira1/3zbf/GaP+Hhf7aH/AEVbWv8Avm2/+M18Z0UAfZn/AA8L/bQ/6KtrX/fNt/8AGaP+Hhf7aH/RVta/75tv/jNfGdFAH2Z/w8L/AG0P+ira1/3zbf8Axmj/AIeF/tof9FW1r/vm2/8AjNfGdFAH63/sVftq/tTfEb9qb4deCfG3xF1TVtD1bVGgvbKdYBHPGIJW2ttiVsblB4I6V/UbX8Z//BPT/k9D4U/9hpv/AEmmr+zCgAooooAKKKKACiiigAooooAKKKKACiiigD+M/wD4eF/tof8ARVta/wC+bb/4zR/w8L/bQ/6KtrX/AHzbf/Ga+M6KAPsz/h4X+2h/0VbWv++bb/4zR/w8L/bQ/wCira1/3zbf/Ga+M6KAPsz/AIeF/tof9FW1r/vm2/8AjNH/AA8L/bQ/6KtrX/fNt/8AGa+M6KAPsz/h4X+2h/0VbWv++bb/AOM0f8PC/wBtD/oq2tf9823/AMZr4zooA+zP+Hhf7aH/AEVbWv8Avm2/+M0f8PC/20P+ira1/wB823/xmvjOigD7M/4eF/tof9FW1r/vm2/+M0f8PC/20P8Aoq2tf9823/xmvjOigD7M/wCHhf7aH/RVta/75tv/AIzR/wAPC/20P+ira1/3zbf/ABmvjOigD7M/4eF/tof9FW1r/vm2/wDjNH/Dwv8AbQ/6KtrX/fNt/wDGa+M6KAPsz/h4X+2h/wBFW1r/AL5tv/jNH/Dwv9tD/oq2tf8AfNt/8Zr4zooA+zP+Hhf7aH/RVta/75tv/jNH/Dwv9tD/AKKtrX/fNt/8Zr4zooA+zP8Ah4X+2h/0VbWv++bb/wCM0f8ADwv9tD/oq2tf9823/wAZr4zooA+zP+Hhf7aH/RVta/75tv8A4zR/w8L/AG0P+ira1/3zbf8AxmvjOigD7M/4eF/tof8ARVta/wC+bb/4zR/w8L/bQ/6KtrX/AHzbf/Ga+M6KAP6tv+CUnxr+Kfxx+CnizxH8WPEV14k1Kx8UyWVvcXYQPHbiytZBGPLRBje7HkZya/Uavxn/AOCJv/JvXjf/ALHOX/032dfsxQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAf//X/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAr8Z/+C2X/JvXgj/sc4v/AE33lfsxX4z/APBbL/k3rwR/2OcX/pvvKAP5m6KKKACiiigAooooAKKKKACiiigAooooA+zP+Cen/J6Hwp/7DTf+k01f2YV/Gf8A8E9P+T0PhT/2Gm/9Jpq/swoAKKKKACiiigAooooAKKKKACiiigAooooA/gDooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/pk/4Im/8m9eN/8Asc5f/TfZ1+zFfjP/AMETf+TevG//AGOcv/pvs6/ZigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/9D9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACvxn/4LZf8m9eCP+xzi/8ATfeV+zFfjP8A8Fsv+TevBH/Y5xf+m+8oA/mbooooAKKKKACiiigAooooAKKKKACiiigD7M/4J6f8nofCn/sNN/6TTV/ZhX8Z/wDwT0/5PQ+FP/Yab/0mmr+zCgAooooAKKKKACiiigAooooAKKKKACiiigD+AOiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD+mT/gib/yb143/wCxzl/9N9nX7MV+M/8AwRN/5N68b/8AY5y/+m+zr9mKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/0f38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAK/Gf/gtl/yb14I/7HOL/wBN95X7MV+M/wDwWy/5N68Ef9jnF/6b7ygD+ZuiiigAooooAKKKKACiiigAooooAKKKKAPsz/gnp/yeh8Kf+w03/pNNX9mFfxn/APBPT/k9D4U/9hpv/Saav7MKACiiigAooooAKKKKACiiigAooooAKKKKAP4A6KKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP6ZP+CJv/JvXjf/ALHOX/032dfsxX4z/wDBE3/k3rxv/wBjnL/6b7Ov2YoAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/S/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAr8Z/+C2X/JvXgj/sc4v/AE33lfsxX4z/APBbL/k3rwR/2OcX/pvvKAP5m6KKKACiiigAooooAKKKKACiiigAooooA+zP+Cen/J6Hwp/7DTf+k01f2YV/Gf8A8E9P+T0PhT/2Gm/9Jpq/swoAKKKKACiiigAooooAKKKKACiiigAooooA/gDooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/pk/4Im/8m9eN/8Asc5f/TfZ1+zFfjP/AMETf+TevG//AGOcv/pvs6/ZigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/9P9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACvxn/4LZf8m9eCP+xzi/8ATfeV+zFfjP8A8Fsv+TevBH/Y5xf+m+8oA/mbooooAKKKKACiiigAooooAKKKKACiiigD7M/4J6f8nofCn/sNN/6TTV/ZhX8Z/wDwT0/5PQ+FP/Yab/0mmr+zCgAooooAKKKKACiiigAooooAKKKKACiiigD+AOiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD+mT/gib/yb143/wCxzl/9N9nX7MV+M/8AwRN/5N68b/8AY5y/+m+zr9mKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/1P38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAK/Gf/gtl/yb14I/7HOL/wBN95X7MV+M/wDwWy/5N68Ef9jnF/6b7ygD+ZuiiigAooooAKKKKACiiigAooooAKKKKAPsz/gnp/yeh8Kf+w03/pNNX9mFfwq/BT4r638Dvin4d+LHhy0tb7UvDd0bu3t70ObeRzG0eJBGyPjDnowOa/Ub/h9l+0L/ANCR4M/79ah/8m0Af0yUV/M3/wAPsv2hf+hI8Gf9+tQ/+TaP+H2X7Qv/AEJHgz/v1qH/AMm0Af0yUV/M3/w+y/aF/wChI8Gf9+tQ/wDk2j/h9l+0L/0JHgz/AL9ah/8AJtAH9MlFfzN/8Psv2hf+hI8Gf9+tQ/8Ak2j/AIfZftC/9CR4M/79ah/8m0Af0yUV/M3/AMPsv2hf+hI8Gf8AfrUP/k2j/h9l+0L/ANCR4M/79ah/8m0Af0yUV/M3/wAPsv2hf+hI8Gf9+tQ/+TaP+H2X7Qv/AEJHgz/v1qH/AMm0Af0yUV/M3/w+y/aF/wChI8Gf9+tQ/wDk2j/h9l+0L/0JHgz/AL9ah/8AJtAH4z0V/TJ/w5N/Z6/6Hfxn/wB/dP8A/kKj/hyb+z1/0O/jP/v7p/8A8hUAfzN0V/TJ/wAOTf2ev+h38Z/9/dP/APkKj/hyb+z1/wBDv4z/AO/un/8AyFQB/M3RX9Mn/Dk39nr/AKHfxn/390//AOQqP+HJv7PX/Q7+M/8Av7p//wAhUAfzN0V/TJ/w5N/Z6/6Hfxn/AN/dP/8AkKj/AIcm/s9f9Dv4z/7+6f8A/IVAH8zdFf0yf8OTf2ev+h38Z/8Af3T/AP5Co/4cm/s9f9Dv4z/7+6f/APIVAH8zdFf0yf8ADk39nr/od/Gf/f3T/wD5Co/4cm/s9f8AQ7+M/wDv7p//AMhUAfzN0V/TJ/w5N/Z6/wCh38Z/9/dP/wDkKvwV/ag+FGifA74++M/hP4cu7q+03w3fi0t7i9KG4kQxRyZkMaomcueigYoA8FooooAKKKKACiiigAooooAKKKKACiiigD+mT/gib/yb143/AOxzl/8ATfZ1+zFfjP8A8ETf+TevG/8A2Ocv/pvs6/ZigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//9X9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACvxn/4LZf8m9eCP+xzi/8ATfeV+zFfjP8A8Fsv+TevBH/Y5xf+m+8oA/mbooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/v8ooooAKKKKACiiigAooooAKKKKACiiigAr+M//goX/wAnofFb/sNL/wCk0Nf2YV/Gf/wUL/5PQ+K3/YaX/wBJoaAPjOiiigAooooAKKKKACiiigAooooAKKKKAP6ZP+CJv/JvXjf/ALHOX/032dfsxX4z/wDBE3/k3rxv/wBjnL/6b7Ov2YoAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/W/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAr8Z/+C2X/JvXgj/sc4v/AE33lfsxX4z/APBbL/k3rwR/2OcX/pvvKAP5m6KKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP7/KKKKACiiigAooooAKKKKACiiigAooooAK/jP/4KF/8AJ6HxW/7DS/8ApNDX9mFfxn/8FC/+T0Pit/2Gl/8ASaGgD4zooooAKKKKACiiigAooooAKKKKACiiigD+mT/gib/yb143/wCxzl/9N9nX7MV+M/8AwRN/5N68b/8AY5y/+m+zr9mKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/1/38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAK/Gf/gtl/yb14I/7HOL/wBN95X7MV+M/wDwWy/5N68Ef9jnF/6b7ygD+ZuiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD+/yiiigAooooAKKKKACiiigAooooAKKKKACv4z/+Chf/ACeh8Vv+w0v/AKTQ1/ZhX8Z//BQv/k9D4rf9hpf/AEmhoA+M6KKKACiiigAooooAKKKKACiiigAooooA/pk/4Im/8m9eN/8Asc5f/TfZ1+zFfjP/AMETf+TevG//AGOcv/pvs6/ZigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/9D9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACvxn/4LZf8m9eCP+xzi/8ATfeV+zFfjP8A8Fsv+TevBH/Y5xf+m+8oA/mbooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/v8ooooAKKKKACiiigAooooAKKKKACiiigAr+M//goX/wAnofFb/sNL/wCk0Nf2YV/Gf/wUL/5PQ+K3/YaX/wBJoaAPjOiiigAooooAKKKKACiiigAooooAKKKKAP6ZP+CJv/JvXjf/ALHOX/032dfsxX4z/wDBE3/k3rxv/wBjnL/6b7Ov2YoAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/R/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAr8Z/+C2X/JvXgj/sc4v/AE33lfsxX4z/APBbL/k3rwR/2OcX/pvvKAP5m6KKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP7/KKKKACiiigAooooAKKKKACiiigAooooAK/jP/4KF/8AJ6HxW/7DS/8ApNDX9mFfxn/8FC/+T0Pit/2Gl/8ASaGgD4zooooAKKKKACiiigAooooAKKKKACiiigD+mT/gib/yb143/wCxzl/9N9nX7MV+M/8AwRN/5N68b/8AY5y/+m+zr9mKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/0v38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAK/Gf/gtl/yb14I/7HOL/wBN95X7MV+M/wDwWy/5N68Ef9jnF/6b7ygD+ZuiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD+/yiiigAooooAKKKKACiiigAooooAKKKKACv4z/+Chf/ACeh8Vv+w0v/AKTQ1/ZhX8Z//BQv/k9D4rf9hpf/AEmhoA+M6KKKACiiigAooooAKKKKACiiigAooooA/pk/4Im/8m9eN/8Asc5f/TfZ1+zFfjP/AMETf+TevG//AGOcv/pvs6/ZigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/9P9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACvxn/4LZf8m9eCP+xzi/8ATfeV+zFfjP8A8Fsv+TevBH/Y5xf+m+8oA/mbooooAKKKKACiiigAooooAKKKKACiiigD1L4KfCjW/jj8U/Dvwn8OXdrY6l4kujaW9xelxbxuI2kzIY1d8YQ9FJzX6jf8OTf2hf8Aod/Bn/f3UP8A5Cr4z/4J6f8AJ6Hwp/7DTf8ApNNX9mFAH8zf/Dk39oX/AKHfwZ/391D/AOQqP+HJv7Qv/Q7+DP8Av7qH/wAhV/TJRQB/M3/w5N/aF/6HfwZ/391D/wCQqP8Ahyb+0L/0O/gz/v7qH/yFX9MlFAH8zf8Aw5N/aF/6HfwZ/wB/dQ/+QqP+HJv7Qv8A0O/gz/v7qH/yFX9MlFAH8zf/AA5N/aF/6HfwZ/391D/5Co/4cm/tC/8AQ7+DP+/uof8AyFX9MlFAH8zf/Dk39oX/AKHfwZ/391D/AOQqP+HJv7Qv/Q7+DP8Av7qH/wAhV/TJRQB/M3/w5N/aF/6HfwZ/391D/wCQqP8Ahyb+0L/0O/gz/v7qH/yFX9MlFAH4z/8AD7L9nr/oSPGf/frT/wD5No/4fZfs9f8AQkeM/wDv1p//AMm1/M3RQB/TJ/w+y/Z6/wChI8Z/9+tP/wDk2j/h9l+z1/0JHjP/AL9af/8AJtfzN0UAf0yf8Psv2ev+hI8Z/wDfrT//AJNo/wCH2X7PX/QkeM/+/Wn/APybX8zdFAH9Mn/D7L9nr/oSPGf/AH60/wD+TaP+H2X7PX/QkeM/+/Wn/wDybX8zdFAH9Mn/AA+y/Z6/6Ejxn/360/8A+TaP+H2X7PX/AEJHjP8A79af/wDJtfzN0UAf0yf8Psv2ev8AoSPGf/frT/8A5No/4fZfs9f9CR4z/wC/Wn//ACbX8zdFAH9Mn/D7L9nr/oSPGf8A360//wCTa/BX9qD4r6J8cfj74z+LHhy0urHTfEl+Lu3t70ILiNBFHHiQRs6Zyh6MRivBaKACiiigAooooAKKKKACiiigAooooAKKKKAP6ZP+CJv/ACb143/7HOX/ANN9nX7MV+M//BE3/k3rxv8A9jnL/wCm+zr9mKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD//U/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAr8Z/+C2X/JvXgj/sc4v/AE33lfsxX4z/APBbL/k3rwR/2OcX/pvvKAP5m6KKKACiiigAooooAKKKKACiiigAooooA+zP+Cen/J6Hwp/7DTf+k01f2YV/Gf8A8E9P+T0PhT/2Gm/9Jpq/swoAKKKKACiiigAooooAKKKKACiiigAooooA/gDooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/pk/4Im/8m9eN/8Asc5f/TfZ1+zFfjP/AMETf+TevG//AGOcv/pvs6/ZigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/9X9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACvxn/4LZf8m9eCP+xzi/8ATfeV+zFfjP8A8Fsv+TevBH/Y5xf+m+8oA/mbooooAKKKKACiiigAooooAKKKKACiiigD7M/4J6f8nofCn/sNN/6TTV/ZhX8Z/wDwT0/5PQ+FP/Yab/0mmr+zCgAooooAKKKKACiiigAooooAKKKKACiiigD+AOiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD+mT/gib/yb143/wCxzl/9N9nX7MV+M/8AwRN/5N68b/8AY5y/+m+zr9mKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/1v38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAK/Gf/gtl/yb14I/7HOL/wBN95X7MV+M/wDwWy/5N68Ef9jnF/6b7ygD+ZuiiigAooooAKKKKACiiigAooooAKKKKAPsz/gnp/yeh8Kf+w03/pNNX9mFfxn/APBPT/k9D4U/9hpv/Saav7MKACiiigAooooAKKKKACiiigAooooAKKKKAP4A6KKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP6ZP+CJv/JvXjf/ALHOX/032dfsxX4z/wDBE3/k3rxv/wBjnL/6b7Ov2YoAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/X/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAr8Z/+C2X/JvXgj/sc4v/AE33lfsxX4z/APBbL/k3rwR/2OcX/pvvKAP5m6KKKACiiigAooooAKKKKACiiigAooooA+zP+Cen/J6Hwp/7DTf+k01f2YV/Gf8A8E9P+T0PhT/2Gm/9Jpq/swoAKKKKACiiigAooooAKKKKACiiigAooooA/gDooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/pk/4Im/8m9eN/8Asc5f/TfZ1+zFfjP/AMETf+TevG//AGOcv/pvs6/ZigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/9D9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACvxn/4LZf8m9eCP+xzi/8ATfeV+zFfjP8A8Fsv+TevBH/Y5xf+m+8oA/mbooooAKKKKACiiigAooooAKKKKACiiigD7M/4J6f8nofCn/sNN/6TTV/ZhX8Z/wDwT0/5PQ+FP/Yab/0mmr+zCgAooooAKKKKACiiigAooooAKKKKACiiigD+AOiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD+mT/gib/yb143/wCxzl/9N9nX7MV+M/8AwRN/5N68b/8AY5y/+m+zr9mKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/0f38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAK/Gf/gtl/yb14I/7HOL/wBN95X7MV+XP/BVv4KfFP44/BTwn4c+E/h268SalY+KY724t7QoHjtxZXUZkPmOgxvdRwc5NAH8pNFfZn/DvT9tD/olOtf99W3/AMeo/wCHen7aH/RKda/76tv/AI9QB8Z0V9mf8O9P20P+iU61/wB9W3/x6j/h3p+2h/0SnWv++rb/AOPUAfGdFfZn/DvT9tD/AKJTrX/fVt/8eo/4d6ftof8ARKda/wC+rb/49QB8Z0V9mf8ADvT9tD/olOtf99W3/wAeo/4d6ftof9Ep1r/vq2/+PUAfGdFfZn/DvT9tD/olOtf99W3/AMeo/wCHen7aH/RKda/76tv/AI9QB8Z0V9mf8O9P20P+iU61/wB9W3/x6j/h3p+2h/0SnWv++rb/AOPUAH/BPT/k9D4U/wDYab/0mmr+zCv5cv2Kv2Kv2pvhz+1N8OvG3jb4dappOh6TqjT3t7O0BjgjMEq7m2ys2NzAcA9a/qNoAKKKKACiiigAooooAKKKKACiiigAooooA/gDor7M/wCHen7aH/RKda/76tv/AI9R/wAO9P20P+iU61/31bf/AB6gD4zor7M/4d6ftof9Ep1r/vq2/wDj1H/DvT9tD/olOtf99W3/AMeoA+M6K+zP+Hen7aH/AESnWv8Avq2/+PUf8O9P20P+iU61/wB9W3/x6gD4zor7M/4d6ftof9Ep1r/vq2/+PUf8O9P20P8AolOtf99W3/x6gD4zor7M/wCHen7aH/RKda/76tv/AI9R/wAO9P20P+iU61/31bf/AB6gD4zor7M/4d6ftof9Ep1r/vq2/wDj1H/DvT9tD/olOtf99W3/AMeoA+M6K+zP+Hen7aH/AESnWv8Avq2/+PUf8O9P20P+iU61/wB9W3/x6gD4zor7M/4d6ftof9Ep1r/vq2/+PUf8O9P20P8AolOtf99W3/x6gD4zor7M/wCHen7aH/RKda/76tv/AI9R/wAO9P20P+iU61/31bf/AB6gD4zor7M/4d6ftof9Ep1r/vq2/wDj1H/DvT9tD/olOtf99W3/AMeoA+M6K+zP+Hen7aH/AESnWv8Avq2/+PUf8O9P20P+iU61/wB9W3/x6gD4zor7M/4d6ftof9Ep1r/vq2/+PUf8O9P20P8AolOtf99W3/x6gD4zor7M/wCHen7aH/RKda/76tv/AI9R/wAO9P20P+iU61/31bf/AB6gD9mP+CJv/JvXjf8A7HOX/wBN9nX7MV+XP/BKT4KfFP4HfBTxZ4c+LHh268N6lfeKZL23t7soXktzZWsYkHlu4xvRhyc5FfqNQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAf/9L9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//T/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/1P38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9X9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//W/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/1/38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9D9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//R/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/0v38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9P9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//U/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/1f38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9b9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//X/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/0P38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9H9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//S/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/0/38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9T9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//V/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/1v38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9f9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//Q/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/2Q=="/>
</defs>
</svg>
`;var jn=e=>`<!doctype html>
<html>
  <head>
    <title>Scalar API Reference</title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1" />
  </head>
  <body>
    <script
      id="api-reference"
      type="application/json">
    ${JSON.stringify(e)}
    </script>
	 <script>
      var configuration = {
	  	favicon: "data:image/svg+xml;utf8,${encodeURIComponent(Ft)}",
	   	theme: "saturn",
        metaData: {
			title: "Better Auth API",
			description: "API Reference for your Better Auth Instance",
		}
      }

      document.getElementById('api-reference').dataset.configuration =
        JSON.stringify(configuration)
    </script>
	  <script src="https://cdn.jsdelivr.net/npm/@scalar/api-reference"></script>
  </body>
</html>`,gf=e=>{let o=e?.path??"/reference";return{id:"open-api",endpoints:{generateOpenAPISchema:u("/open-api/generate-schema",{method:"GET"},async r=>{let i=await Ho(r.context,r.context.options);return r.json(i)}),openAPIReference:u(o,{method:"GET",metadata:{isAction:!1}},async r=>{if(e?.disableDefaultReference)throw new m("NOT_FOUND");let i=await Ho(r.context,r.context.options);return new Response(jn(i),{headers:{"Content-Type":"text/html"}})})}}};import{SignJWT as xn}from"jose";import{z as ie}from"zod";import{subtle as Bn}from"@better-auth/utils";var Vt={oauthApplication:{modelName:"oauthApplication",fields:{name:{type:"string"},icon:{type:"string",required:!1},metadata:{type:"string",required:!1},clientId:{type:"string",unique:!0},clientSecret:{type:"string"},redirectURLs:{type:"string"},type:{type:"string"},disabled:{type:"boolean",required:!1,defaultValue:!1},userId:{type:"string",required:!1},createdAt:{type:"date"},updatedAt:{type:"date"}}},oauthAccessToken:{modelName:"oauthAccessToken",fields:{accessToken:{type:"string",unique:!0},refreshToken:{type:"string",unique:!0},accessTokenExpiresAt:{type:"date"},refreshTokenExpiresAt:{type:"date"},clientId:{type:"string"},userId:{type:"string",required:!1},scopes:{type:"string"},createdAt:{type:"date"},updatedAt:{type:"date"}}},oauthConsent:{modelName:"oauthConsent",fields:{clientId:{type:"string"},userId:{type:"string"},scopes:{type:"string"},createdAt:{type:"date"},updatedAt:{type:"date"},consentGiven:{type:"boolean"}}}};import{APIError as $o}from"better-call";function to(e,o,r){return`${e.includes("?")?"&":"?"}error=${o}&error_description=${r}`}async function Zo(e,o){let r={codeExpiresIn:600,defaultScope:"openid",...o,scopes:["openid","profile","email","offline_access",...o?.scopes||[]]};if(!e.request)throw new $o("UNAUTHORIZED",{error_description:"request not found",error:"invalid_request"});let i=await U(e);if(!i){await e.setSignedCookie("oidc_login_prompt",JSON.stringify(e.query),e.context.secret,{maxAge:600});let h=e.request.url?.split("?")[1];throw e.redirect(`${o.loginPage}?${h}`)}let t=e.query;if(!t.client_id)throw e.redirect(`${e.context.baseURL}/error?error=invalid_client`);if(!t.response_type)throw e.redirect(to(`${e.context.baseURL}/error`,"invalid_request","response_type is required"));let n=await e.context.adapter.findOne({model:"oauthApplication",where:[{field:"clientId",value:e.query.client_id}]}).then(h=>h?{...h,redirectURLs:h.redirectURLs.split(","),metadata:h.metadata?JSON.parse(h.metadata):{}}:null);if(!n)throw e.redirect(`${e.context.baseURL}/error?error=invalid_client`);let s=n.redirectURLs.find(h=>h===e.query.redirect_uri);if(!s||!t.redirect_uri)throw new $o("BAD_REQUEST",{message:"Invalid redirect URI"});if(n.disabled)throw e.redirect(`${e.context.baseURL}/error?error=client_disabled`);if(t.response_type!=="code")throw e.redirect(`${e.context.baseURL}/error?error=unsupported_response_type`);let a=t.scope?.split(" ").filter(h=>h)||r.defaultScope.split(" "),d=a.filter(h=>!r.scopes.includes(h)||h==="offline_access"&&t.prompt!=="consent");if(d.length)throw e.redirect(to(t.redirect_uri,"invalid_scope",`The following scopes are invalid: ${d.join(", ")}`));if((!t.code_challenge||!t.code_challenge_method)&&o.requirePKCE)throw e.redirect(to(t.redirect_uri,"invalid_request","pkce is required"));if(!["s256",o.allowPlainCodeChallengeMethod?"plain":"s256"].includes(t.code_challenge_method?.toLowerCase()||""))throw e.redirect(to(t.redirect_uri,"invalid_request","invalid code_challenge method"));let A=_(32,"a-z","A-Z","0-9"),c=r.codeExpiresIn*1e3,K=new Date(Date.now()+c);try{await e.context.internalAdapter.createVerificationValue({value:JSON.stringify({clientId:n.clientId,redirectURI:t.redirect_uri,scope:a,userId:i.user.id,authTime:i.session.createdAt.getTime(),requireConsent:t.prompt==="consent",state:t.prompt==="consent"?t.state:null,codeChallenge:t.code_challenge,codeChallengeMethod:t.code_challenge_method}),identifier:A,expiresAt:K})}catch{throw e.redirect(to(t.redirect_uri,"server_error","An error occurred while processing the request"))}let l=new URL(s);if(l.searchParams.set("code",A),l.searchParams.set("state",e.query.state),t.prompt!=="consent"||await e.context.adapter.findOne({model:"oauthConsent",where:[{field:"clientId",value:n.clientId},{field:"userId",value:i.user.id}]}).then(h=>!!h?.consentGiven))throw e.redirect(l.toString());if(o?.consentPage){await e.setSignedCookie("oidc_consent_prompt",A,e.context.secret,{maxAge:600});let h=`${o.consentPage}?client_id=${n.clientId}&scope=${a.join(" ")}`;throw e.redirect(h)}let y=o?.getConsentHTML;if(!y)throw new $o("INTERNAL_SERVER_ERROR",{message:"No consent page provided"});return new Response(y({scopes:a,clientMetadata:n.metadata,clientIcon:n?.icon,clientId:n.clientId,clientName:n.name,code:A}),{headers:{"content-type":"text/html"}})}import{createHash as zn}from"@better-auth/utils/hash";var Fn=(e,o)=>{let r=e.context.options.baseURL,i=e.context.baseURL;return{issuer:r,authorization_endpoint:`${i}/oauth2/authorize`,token_endpoint:`${i}/oauth2/token`,userInfo_endpoint:`${i}/oauth2/userinfo`,jwks_uri:`${i}/jwks`,registration_endpoint:`${i}/oauth2/register`,scopes_supported:["openid","profile","email","offline_access"],response_types_supported:["code"],response_modes_supported:["query"],grant_types_supported:["authorization_code"],acr_values_supported:["urn:mace:incommon:iap:silver","urn:mace:incommon:iap:bronze"],subject_types_supported:["public"],id_token_signing_alg_values_supported:["RS256","none"],token_endpoint_auth_methods_supported:["client_secret_basic","client_secret_post"],claims_supported:["sub","iss","aud","exp","nbf","iat","jti","email","email_verified","name"],...o?.metadata}},kf=e=>{let o={oauthClient:"oauthApplication",oauthAccessToken:"oauthAccessToken",oauthConsent:"oauthConsent"},r={codeExpiresIn:600,defaultScope:"openid",accessTokenExpiresIn:3600,refreshTokenExpiresIn:604800,...e,scopes:["openid","profile","email","offline_access",...e?.scopes||[]]};return{id:"oidc",hooks:{after:[{matcher(){return!0},handler:async i=>{let t=await i.getSignedCookie("oidc_login_prompt",i.context.secret),n=i.context.authCookies.sessionToken.name,s=Ee(i.responseHeader.get("set-cookie")||""),a=s.has(n);if(!t||!a)return;i.setCookie("oidc_login_prompt","",{maxAge:0});let A=s.get(n)?.value?.split(".")[0];if(!A)return;let c=await i.context.internalAdapter.findSession(A);return c?(i.query=JSON.parse(t),i.query.prompt="consent",i.context.session=c,await Zo(i,r)):void 0}}]},endpoints:{getOpenIdConfig:u("/.well-known/openid-configuration",{method:"GET"},async i=>Fn(i,e)),oAuth2authorize:u("/oauth2/authorize",{method:"GET",query:ie.record(ie.string(),ie.any())},async i=>Zo(i,r)),oAuthConsent:u("/oauth2/consent",{method:"POST",body:ie.object({accept:ie.boolean()}),use:[I]},async i=>{let t=await i.getSignedCookie("oidc_consent_prompt",i.context.secret);if(!t)throw new m("UNAUTHORIZED",{error_description:"No consent prompt found",error:"invalid_grant"});let n=await i.context.internalAdapter.findVerificationValue(t);if(!n)throw new m("UNAUTHORIZED",{error_description:"Invalid code",error:"invalid_grant"});if(n.expiresAt<new Date)throw await i.context.internalAdapter.deleteVerificationValue(n.id),new m("UNAUTHORIZED",{error_description:"Code expired",error:"invalid_grant"});let s=JSON.parse(n.value);if(!s.requireConsent||!s.state)throw new m("UNAUTHORIZED",{error_description:"Consent not required",error:"invalid_grant"});if(!i.body.accept)return await i.context.internalAdapter.deleteVerificationValue(n.id),i.json({redirectURI:`${s.redirectURI}?error=access_denied&error_description=User denied access`});let a=_(32,"a-z","A-Z","0-9"),d=r.codeExpiresIn*1e3,A=new Date(Date.now()+d);await i.context.internalAdapter.updateVerificationValue(n.id,{value:JSON.stringify({...s,requireConsent:!1}),identifier:a,expiresAt:A}),await i.context.adapter.create({model:o.oauthConsent,data:{clientId:s.clientId,userId:s.userId,scopes:s.scope.join(" "),consentGiven:!0,createdAt:new Date,updatedAt:new Date}});let c=new URL(s.redirectURI);return c.searchParams.set("code",a),c.searchParams.set("state",s.state),i.json({redirectURI:c.toString()})}),oAuth2token:u("/oauth2/token",{method:"POST",body:ie.any(),metadata:{isAction:!1}},async i=>{let{body:t}=i;if(!t)throw new m("BAD_REQUEST",{error_description:"request body not found",error:"invalid_request"});if(t instanceof FormData&&(t=Object.fromEntries(t.entries())),!(t instanceof Object))throw new m("BAD_REQUEST",{error_description:"request body is not an object",error:"invalid_request"});let{client_id:n,client_secret:s,grant_type:a,code:d,redirect_uri:A,refresh_token:c,code_verifier:K}=t;if(a==="refresh_token"){if(!c)throw new m("BAD_REQUEST",{error_description:"refresh_token is required",error:"invalid_request"});let N=await i.context.adapter.findOne({model:o.oauthAccessToken,where:[{field:"refreshToken",value:c.toString()}]});if(!N)throw new m("UNAUTHORIZED",{error_description:"invalid refresh token",error:"invalid_grant"});if(N.clientId!==n?.toString())throw new m("UNAUTHORIZED",{error_description:"invalid client_id",error:"invalid_client"});if(N.refreshTokenExpiresAt<new Date)throw new m("UNAUTHORIZED",{error_description:"refresh token expired",error:"invalid_grant"});let Z=_(32,"a-z","A-Z"),re=_(32,"a-z","A-Z"),ae=new Date(Date.now()+r.accessTokenExpiresIn*1e3),Go=new Date(Date.now()+r.refreshTokenExpiresIn*1e3);return await i.context.adapter.create({model:o.oauthAccessToken,data:{accessToken:Z,refreshToken:re,accessTokenExpiresAt:ae,refreshTokenExpiresAt:Go,clientId:n.toString(),userId:N.userId,scopes:N.scopes,createdAt:new Date,updatedAt:new Date}}),i.json({access_token:Z,token_type:"bearer",expires_in:r.accessTokenExpiresIn,refresh_token:re,scope:N.scopes})}if(!d)throw new m("BAD_REQUEST",{error_description:"code is required",error:"invalid_request"});if(e.requirePKCE&&!K)throw new m("BAD_REQUEST",{error_description:"code verifier is missing",error:"invalid_request"});let l=await i.context.internalAdapter.findVerificationValue(d.toString());if(!l)throw new m("UNAUTHORIZED",{error_description:"invalid code",error:"invalid_grant"});if(l.expiresAt<new Date)throw await i.context.internalAdapter.deleteVerificationValue(l.id),new m("UNAUTHORIZED",{error_description:"code expired",error:"invalid_grant"});if(await i.context.internalAdapter.deleteVerificationValue(l.id),!n||!s)throw new m("UNAUTHORIZED",{error_description:"client_id and client_secret are required",error:"invalid_client"});if(!a)throw new m("BAD_REQUEST",{error_description:"grant_type is required",error:"invalid_request"});if(a!=="authorization_code")throw new m("BAD_REQUEST",{error_description:"grant_type must be 'authorization_code'",error:"unsupported_grant_type"});if(!A)throw new m("BAD_REQUEST",{error_description:"redirect_uri is required",error:"invalid_request"});let p=await i.context.adapter.findOne({model:o.oauthClient,where:[{field:"clientId",value:n.toString()}]}).then(N=>N?{...N,redirectURLs:N.redirectURLs.split(","),metadata:N.metadata?JSON.parse(N.metadata):{}}:null);if(!p)throw new m("UNAUTHORIZED",{error_description:"invalid client_id",error:"invalid_client"});if(p.disabled)throw new m("UNAUTHORIZED",{error_description:"client is disabled",error:"invalid_client"});if(!(p.clientSecret===s.toString()))throw new m("UNAUTHORIZED",{error_description:"invalid client_secret",error:"invalid_client"});let h=JSON.parse(l.value);if(h.clientId!==n.toString())throw new m("UNAUTHORIZED",{error_description:"invalid client_id",error:"invalid_client"});if(h.redirectURI!==A.toString())throw new m("UNAUTHORIZED",{error_description:"invalid redirect_uri",error:"invalid_client"});if(h.codeChallenge&&!K)throw new m("BAD_REQUEST",{error_description:"code verifier is missing",error:"invalid_request"});if((h.codeChallengeMethod==="plain"?K:await zn("SHA-256","base64urlnopad").digest(K))!==h.codeChallenge)throw new m("UNAUTHORIZED",{error_description:"code verification failed",error:"invalid_request"});let D=h.scope;await i.context.internalAdapter.deleteVerificationValue(d.toString());let B=_(32,"a-z","A-Z"),g=_(32,"A-Z","a-z"),C=new Date(Date.now()+r.accessTokenExpiresIn*1e3),k=new Date(Date.now()+r.refreshTokenExpiresIn*1e3);await i.context.adapter.create({model:o.oauthAccessToken,data:{accessToken:B,refreshToken:g,accessTokenExpiresAt:C,refreshTokenExpiresAt:k,clientId:n.toString(),userId:h.userId,scopes:D.join(" "),createdAt:new Date,updatedAt:new Date}});let w=await i.context.internalAdapter.findUserById(h.userId);if(!w)throw new m("UNAUTHORIZED",{error_description:"user not found",error:"invalid_grant"});let te={alg:"HS256",key:await Bn.generateKey({name:"HMAC",hash:"SHA-256"},!0,["sign","verify"])},qe={given_name:w.name.split(" ")[0],family_name:w.name.split(" ")[1],name:w.name,profile:w.image,updated_at:w.updatedAt.toISOString()},ro={email:w.email,email_verified:w.emailVerified},He={...D.includes("profile")?qe:{},...D.includes("email")?ro:{}},Oo=await new xn({sub:w.id,aud:n.toString(),iat:Date.now(),auth_time:i.context.session?.session.createdAt.getTime(),nonce:t.nonce,acr:"urn:mace:incommon:iap:silver",...He}).setProtectedHeader({alg:te.alg}).setIssuedAt().setExpirationTime(Math.floor(Date.now()/1e3)+r.accessTokenExpiresIn).sign(te.key);return i.json({access_token:B,token_type:"Bearer",expires_in:r.accessTokenExpiresIn,refresh_token:D.includes("offline_access")?g:void 0,scope:D.join(" "),id_token:D.includes("openid")?Oo:void 0},{headers:{"Cache-Control":"no-store",Pragma:"no-cache"}})}),oAuth2userInfo:u("/oauth2/userinfo",{method:"GET",metadata:{isAction:!1}},async i=>{if(!i.request)throw new m("UNAUTHORIZED",{error_description:"request not found",error:"invalid_request"});let t=i.request.headers.get("authorization");if(!t)throw new m("UNAUTHORIZED",{error_description:"authorization header not found",error:"invalid_request"});let n=t.replace("Bearer ",""),s=await i.context.adapter.findOne({model:o.oauthAccessToken,where:[{field:"accessToken",value:n}]});if(!s)throw new m("UNAUTHORIZED",{error_description:"invalid access token",error:"invalid_token"});if(s.accessTokenExpiresAt<new Date)throw new m("UNAUTHORIZED",{error_description:"The Access Token expired",error:"invalid_token"});let a=await i.context.internalAdapter.findUserById(s.userId);if(!a)throw new m("UNAUTHORIZED",{error_description:"user not found",error:"invalid_token"});let d=s.scopes.split(" "),A={email:d.includes("email")?a.email:void 0,name:d.includes("profile")?a.name:void 0,picture:d.includes("profile")?a.image:void 0,given_name:d.includes("profile")?a.name.split(" ")[0]:void 0,family_name:d.includes("profile")?a.name.split(" ")[1]:void 0,email_verified:d.includes("email")?a.emailVerified:void 0};return i.json(A)}),registerOAuthApplication:u("/oauth2/register",{method:"POST",body:ie.object({name:ie.string(),icon:ie.string().optional(),metadata:ie.record(ie.any()).optional(),redirectURLs:ie.array(ie.string())})},async i=>{let t=i.body,n=await U(i);if(!n&&!e.allowDynamicClientRegistration)throw new m("UNAUTHORIZED",{message:"Unauthorized"});let s=e.generateClientId?.()||_(32,"a-z","A-Z"),a=e.generateClientSecret?.()||_(32,"a-z","A-Z"),d=await i.context.adapter.create({model:o.oauthClient,data:{name:t.name,icon:t.icon,metadata:t.metadata?JSON.stringify(t.metadata):null,clientId:s,clientSecret:a,redirectURLs:t.redirectURLs.join(","),type:"web",authenticationScheme:"client_secret",disabled:!1,userId:n?.session.userId,createdAt:new Date,updatedAt:new Date}});return i.json({...d,redirectURLs:d.redirectURLs.split(","),metadata:d.metadata?JSON.parse(d.metadata):null})}),getOAuthClient:u("/oauth2/client/:id",{method:"GET",use:[I]},async i=>{let t=await i.context.adapter.findOne({model:o.oauthClient,where:[{field:"clientId",value:i.params.id}]});if(!t)throw new m("NOT_FOUND",{error_description:"client not found",error:"not_found"});return i.json({clientId:t.clientId,name:t.name,icon:t.icon})})},schema:Vt}};export{De as HIDE_METADATA,GK as admin,NK as anonymous,AK as bearer,u as createAuthEndpoint,L as createAuthMiddleware,Gm as customSession,Um as emailOTP,nm as genericOAuth,fm as jwt,hK as magicLink,bm as multiSession,qm as oAuthProxy,kf as oidcProvider,jm as oneTap,gf as openAPI,Wo as optionsMiddleware,jl as organization,UK as phoneNumber,Zp as twoFactor,_p as twoFactorClient,vt as username};
