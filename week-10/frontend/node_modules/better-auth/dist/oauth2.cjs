"use strict";var A=Object.defineProperty;var se=Object.getOwnPropertyDescriptor;var ae=Object.getOwnPropertyNames;var ie=Object.prototype.hasOwnProperty;var ce=(e,t)=>{for(var r in t)A(e,r,{get:t[r],enumerable:!0})},le=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of ae(t))!ie.call(e,s)&&s!==r&&A(e,s,{get:()=>t[s],enumerable:!(n=se(t,s))||n.enumerable});return e};var ue=e=>le(A({},"__esModule",{value:!0}),e);var Fe={};ce(Fe,{createAuthorizationURL:()=>fe,generateCodeChallenge:()=>E,generateState:()=>Je,getOAuth2Tokens:()=>L,parseState:()=>Me,validateAuthorizationCode:()=>Oe,validateToken:()=>je});module.exports=ue(Fe);var C=(e,t="ms")=>new Date(Date.now()+(t==="sec"?e*1e3:e));var q=require("@better-auth/utils/hash"),H=require("@better-auth/utils/base64");async function E(e){let t=await(0,q.createHash)("SHA-256").digest(e);return H.base64Url.encode(new Uint8Array(t),{padding:!1})}function L(e){return{tokenType:e.token_type,accessToken:e.access_token,refreshToken:e.refresh_token,accessTokenExpiresAt:e.expires_in?C(e.expires_in,"sec"):void 0,scopes:e?.scope?typeof e.scope=="string"?e.scope.split(" "):e.scope:[],idToken:e.id_token}}async function fe({id:e,options:t,authorizationEndpoint:r,state:n,codeVerifier:s,scopes:l,claims:o,redirectURI:h,duration:f}){let a=new URL(r);if(a.searchParams.set("response_type","code"),a.searchParams.set("client_id",t.clientId),a.searchParams.set("state",n),a.searchParams.set("scope",l.join(" ")),a.searchParams.set("redirect_uri",t.redirectURI||h),s){let c=await E(s);a.searchParams.set("code_challenge_method","S256"),a.searchParams.set("code_challenge",c)}if(o){let c=o.reduce((u,d)=>(u[d]=null,u),{});a.searchParams.set("claims",JSON.stringify({id_token:{email:null,email_verified:null,...c}}))}return f&&a.searchParams.set("duration",f),a}var de=Object.defineProperty,pe=Object.defineProperties,he=Object.getOwnPropertyDescriptors,N=Object.getOwnPropertySymbols,ye=Object.prototype.hasOwnProperty,me=Object.prototype.propertyIsEnumerable,D=(e,t,r)=>t in e?de(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,b=(e,t)=>{for(var r in t||(t={}))ye.call(t,r)&&D(e,r,t[r]);if(N)for(var r of N(t))me.call(t,r)&&D(e,r,t[r]);return e},R=(e,t)=>pe(e,he(t)),ge=class extends Error{constructor(e,t,r){super(t||e.toString(),{cause:r}),this.status=e,this.statusText=t,this.error=r}},ve=async(e,t)=>{var r,n,s,l,o,h;let f=t||{},a={onRequest:[t?.onRequest],onResponse:[t?.onResponse],onSuccess:[t?.onSuccess],onError:[t?.onError],onRetry:[t?.onRetry]};if(!t||!t?.plugins)return{url:e,options:f,hooks:a};for(let c of t?.plugins||[]){if(c.init){let u=await((r=c.init)==null?void 0:r.call(c,e.toString(),t));f=u.options||f,e=u.url}a.onRequest.push((n=c.hooks)==null?void 0:n.onRequest),a.onResponse.push((s=c.hooks)==null?void 0:s.onResponse),a.onSuccess.push((l=c.hooks)==null?void 0:l.onSuccess),a.onError.push((o=c.hooks)==null?void 0:o.onError),a.onRetry.push((h=c.hooks)==null?void 0:h.onRetry)}return{url:e,options:f,hooks:a}},I=class{constructor(e){this.options=e}shouldAttemptRetry(e,t){return this.options.shouldRetry?Promise.resolve(e<this.options.attempts&&this.options.shouldRetry(t)):Promise.resolve(e<this.options.attempts)}getDelay(){return this.options.delay}},we=class{constructor(e){this.options=e}shouldAttemptRetry(e,t){return this.options.shouldRetry?Promise.resolve(e<this.options.attempts&&this.options.shouldRetry(t)):Promise.resolve(e<this.options.attempts)}getDelay(e){return Math.min(this.options.maxDelay,this.options.baseDelay*2**e)}};function be(e){if(typeof e=="number")return new I({type:"linear",attempts:e,delay:1e3});switch(e.type){case"linear":return new I(e);case"exponential":return new we(e);default:throw new Error("Invalid retry strategy")}}var Re=e=>{let t={},r=n=>typeof n=="function"?n():n;if(e?.auth){if(e.auth.type==="Bearer"){let n=r(e.auth.token);if(!n)return t;t.authorization=`Bearer ${n}`}else if(e.auth.type==="Basic"){let n=r(e.auth.username),s=r(e.auth.password);if(!n||!s)return t;t.authorization=`Basic ${btoa(`${n}:${s}`)}`}else if(e.auth.type==="Custom"){let n=r(e.auth.value);if(!n)return t;t.authorization=`${r(e.auth.prefix)} ${n}`}}return t},z=["get","post","put","patch","delete"];var xe=/^application\/(?:[\w!#$%&*.^`~-]*\+)?json(;.+)?$/i;function _e(e){let t=e.headers.get("content-type"),r=new Set(["image/svg","application/xml","application/xhtml","application/html"]);if(!t)return"json";let n=t.split(";").shift()||"";return xe.test(n)?"json":r.has(n)||n.startsWith("text/")?"text":"blob"}function Ue(e){try{return JSON.parse(e),!0}catch{return!1}}function J(e){if(e===void 0)return!1;let t=typeof e;return t==="string"||t==="number"||t==="boolean"||t===null?!0:t!=="object"?!1:Array.isArray(e)?!0:e.buffer?!1:e.constructor&&e.constructor.name==="Object"||typeof e.toJSON=="function"}function V(e){try{return JSON.parse(e)}catch{return e}}function W(e){return typeof e=="function"}function Te(e){if(e?.customFetchImpl)return e.customFetchImpl;if(typeof globalThis<"u"&&W(globalThis.fetch))return globalThis.fetch;if(typeof window<"u"&&W(window.fetch))return window.fetch;throw new Error("No fetch implementation found")}function Pe(e){let t=new Headers(e?.headers),r=Re(e);for(let[n,s]of Object.entries(r||{}))t.set(n,s);if(!t.has("content-type")){let n=Se(e?.body);n&&t.set("content-type",n)}return t}function Se(e){return J(e)?"application/json":null}function Ae(e){if(!e?.body)return null;let t=new Headers(e?.headers);return J(e.body)&&!t.has("content-type")?JSON.stringify(e.body):e.body}function Ee(e,t){var r;if(t?.method)return t.method.toUpperCase();if(e.startsWith("@")){let n=(r=e.split("@")[1])==null?void 0:r.split("/")[0];return z.includes(n)?n.toUpperCase():t?.body?"POST":"GET"}return t?.body?"POST":"GET"}function Le(e,t){let r;return!e?.signal&&e?.timeout&&(r=setTimeout(()=>t?.abort(),e?.timeout)),{abortTimeout:r,clearTimeout:()=>{r&&clearTimeout(r)}}}function ke(e,t){let{baseURL:r,params:n,query:s}=t||{query:{},params:{},baseURL:""},l=e.startsWith("http")?e.split("/").slice(0,3).join("/"):r;if(!l)throw new TypeError(`Invalid URL ${e}. Are you passing in a relative URL but not setting the baseURL?`);if(e.startsWith("@")){let u=e.toString().split("@")[1].split("/")[0];z.includes(u)&&(e=e.replace(`@${u}/`,"/"))}l.endsWith("/")||(l+="/");let[o,h]=e.replace(l,"").split("?"),f=new URLSearchParams(h);for(let[u,d]of Object.entries(s||{}))f.set(u,String(d));if(n)if(Array.isArray(n)){let u=o.split("/").filter(d=>d.startsWith(":"));for(let[d,P]of u.entries()){let _=n[d];o=o.replace(P,_)}}else for(let[u,d]of Object.entries(n))o=o.replace(`:${u}`,String(d));o=o.split("/").map(encodeURIComponent).join("/"),o.startsWith("/")&&(o=o.slice(1));let a=f.size>0?`?${f}`.replace(/\+/g,"%20"):"";return new URL(`${o}${a}`,l)}var U=async(e,t)=>{var r,n,s,l,o,h,f,a;let{hooks:c,url:u,options:d}=await ve(e,t),P=Te(d),_=new AbortController,X=(r=d.signal)!=null?r:_.signal,Q=ke(u,d),Z=Ae(d),Y=Pe(d),ee=Ee(u,d),p=R(b({},d),{url:Q,headers:Y,body:Z,method:ee,signal:X});for(let m of c.onRequest)if(m){let y=await m(p);y instanceof Object&&(p=y)}("pipeTo"in p&&typeof p.pipeTo=="function"||typeof((n=t?.body)==null?void 0:n.pipe)=="function")&&("duplex"in p||(p.duplex="half"));let{clearTimeout:te}=Le(d,_),i=await P(p.url,p);te();let B={response:i,request:p};for(let m of c.onResponse)if(m){let y=await m(R(b({},B),{response:(s=t?.hookOptions)!=null&&s.cloneResponse?i.clone():i}));y instanceof Response?i=y:y instanceof Object&&(i=y.response)}if(i.ok){if(!(p.method!=="HEAD"))return{data:"",error:null};let y=_e(i),v={data:"",response:i,request:p};if(y==="json"||y==="text"){let w=await i.text(),oe=await((l=p.jsonParser)!=null?l:V)(w);v.data=oe}else v.data=await i[y]();p?.output&&p.output&&!p.disableValidation&&(v.data=p.output.parse(v.data));for(let w of c.onSuccess)w&&await w(R(b({},v),{response:(o=t?.hookOptions)!=null&&o.cloneResponse?i.clone():i}));return t?.throw?v.data:{data:v.data,error:null}}let re=(h=t?.jsonParser)!=null?h:V,$=await i.text(),S=Ue($)?await re($):{},ne={response:i,request:p,error:R(b({},S),{status:i.status,statusText:i.statusText})};for(let m of c.onError)m&&await m(R(b({},ne),{response:(f=t?.hookOptions)!=null&&f.cloneResponse?i.clone():i}));if(t?.retry){let m=be(t.retry),y=(a=t.retryAttempt)!=null?a:0;if(await m.shouldAttemptRetry(y,i)){for(let w of c.onRetry)w&&await w(B);let v=m.getDelay(y);return await new Promise(w=>setTimeout(w,v)),await U(e,R(b({},t),{retryAttempt:y+1}))}}if(t?.throw)throw new ge(i.status,i.statusText,S);return{data:null,error:R(b({},S),{status:i.status,statusText:i.statusText})}};var M=require("jose");async function Oe({code:e,codeVerifier:t,redirectURI:r,options:n,tokenEndpoint:s,authentication:l}){let o=new URLSearchParams,h={"content-type":"application/x-www-form-urlencoded",accept:"application/json","user-agent":"better-auth"};if(o.set("grant_type","authorization_code"),o.set("code",e),t&&o.set("code_verifier",t),o.set("redirect_uri",r),l==="basic"){let u=btoa(`${n.clientId}:${n.clientSecret}`);h.authorization=`Basic ${u}`}else o.set("client_id",n.clientId),o.set("client_secret",n.clientSecret);let{data:f,error:a}=await U(s,{method:"POST",body:o,headers:h});if(a)throw a;return L(f)}async function je(e,t){let{data:r,error:n}=await U(t,{method:"GET",headers:{accept:"application/json","user-agent":"better-auth"}});if(n)throw n;let s=r.keys,l=JSON.parse(atob(e.split(".")[0])),o=s.find(f=>f.kid===l.kid);if(!o)throw new Error("Key not found");return await(0,M.jwtVerify)(e,o)}var g=require("zod"),j=require("better-call");var T=Object.create(null),x=e=>globalThis.process?.env||globalThis.Deno?.env.toObject()||globalThis.__env__||(e?T:globalThis),F=new Proxy(T,{get(e,t){return x()[t]??T[t]},has(e,t){let r=x();return t in r||t in T},set(e,t,r){let n=x(!0);return n[t]=r,!0},deleteProperty(e,t){if(!t)return!1;let r=x(!0);return delete r[t],!0},ownKeys(){let e=x(!0);return Object.keys(e)}});function Be(e){return e?e!=="false":!1}var $e=typeof process<"u"&&process.env&&process.env.NODE_ENV||"";var ct=$e==="test"||Be(F.TEST);function G(e){try{return new URL(e).origin}catch{return null}}var Ve=require("@better-auth/utils/hash"),We=require("@noble/ciphers/chacha"),O=require("@noble/ciphers/utils"),ze=require("@noble/ciphers/webcrypto");var qe=require("@better-auth/utils/hash");var He=require("jose");var Ne=require("@noble/hashes/scrypt"),De=require("uncrypto"),Ie=require("@better-auth/utils/hex");var K=require("@better-auth/utils/random"),k=(0,K.createRandomStringGenerator)("a-z","0-9","A-Z","-_");async function Je(e,t){let r=e.body?.callbackURL||(e.query?.currentURL?G(e.query?.currentURL):"")||e.context.options.baseURL;if(!r)throw new j.APIError("BAD_REQUEST",{message:"callbackURL is required"});let n=k(128),s=k(32),l=JSON.stringify({callbackURL:r,codeVerifier:n,errorURL:e.body?.errorCallbackURL||e.query?.currentURL,newUserURL:e.body?.newUserCallbackURL,link:t,expiresAt:Date.now()+10*60*1e3}),o=new Date;o.setMinutes(o.getMinutes()+10);let h=await e.context.internalAdapter.createVerificationValue({value:l,identifier:s,expiresAt:o});if(!h)throw e.context.logger.error("Unable to create verification. Make sure the database adapter is properly working and there is a verification table in the database"),new j.APIError("INTERNAL_SERVER_ERROR",{message:"Unable to create verification"});return{state:h.identifier,codeVerifier:n}}async function Me(e){let t=e.query.state||e.body.state,r=await e.context.internalAdapter.findVerificationValue(t);if(!r)throw e.context.logger.error("State Mismatch. Verification not found",{state:t}),e.redirect(`${e.context.baseURL}/error?error=please_restart_the_process`);let n=g.z.object({callbackURL:g.z.string(),codeVerifier:g.z.string(),errorURL:g.z.string().optional(),newUserURL:g.z.string().optional(),expiresAt:g.z.number(),link:g.z.object({email:g.z.string(),userId:g.z.string()}).optional()}).parse(JSON.parse(r.value));if(n.errorURL||(n.errorURL=`${e.context.baseURL}/error`),n.expiresAt<Date.now())throw await e.context.internalAdapter.deleteVerificationValue(r.id),e.context.logger.error("State expired.",{state:t}),e.redirect(`${e.context.baseURL}/error?error=please_restart_the_process`);return await e.context.internalAdapter.deleteVerificationValue(r.id),n}0&&(module.exports={createAuthorizationURL,generateCodeChallenge,generateState,getOAuth2Tokens,parseState,validateAuthorizationCode,validateToken});
